@startuml Application Startup Sequence
!theme cerulean-outline
title Trade Journal Application Startup Sequence

actor User
participant "Python Process" as Process
participant "FastAPI App" as App
participant "Database Manager" as DB
participant "V2 Components" as V2
participant "Static Files" as Static
participant "Logger" as Log
participant "Tastytrade Client" as TT
participant "Auto-Sync Task" as AutoSync

== Application Initialization ==

User -> Process: python app.py
activate Process

Process -> Log: Configure logging\n(rotating file logs, 7 day retention)
activate Log
Log --> Process: Logging configured
deactivate Log

Process -> App: Initialize FastAPI app\n(title, description, version)
activate App

App -> App: Add CORS middleware\n(allow all origins for local dev)

== Database & Component Setup ==

App -> DB: Initialize DatabaseManager()
activate DB
DB -> DB: Set up connection factory\n(sqlite3.Row for dict-like access)
DB --> App: Database manager ready
deactivate DB

App -> V2: Initialize V2 System Components
activate V2
V2 -> V2: Create OrderManager(db)
V2 -> V2: Create PositionInventoryManager(db)
V2 -> V2: Create OrderProcessorV2(db, position_manager)
V2 -> V2: Create StrategyDetector(db)
V2 -> V2: Create PnLCalculatorV2(db, position_manager)
V2 --> App: V2 components ready
deactivate V2

== Static File Setup ==

App -> Static: Create static directories\n(css, js, images)
activate Static
Static -> Static: mkdir -p static/{css,js,images}
Static --> App: Directories created
deactivate Static

App -> App: Mount static files\n(/static -> ./static)

== Startup Event Processing ==

App -> App: @app.on_event("startup")\nstartup_event()
activate App

App -> Log: Log "Starting Trade Journal Web App"

App -> DB: db.initialize_database()
activate DB
DB -> DB: Create all tables if not exist\n(raw_transactions, orders, order_chains, etc.)
DB --> App: Database initialized
deactivate DB

== Auto-Sync Logic ==

App -> DB: db.get_last_sync_timestamp()
activate DB
DB --> App: last_sync_time or None
deactivate DB

alt Last sync exists
    App -> App: Calculate hours since last sync

    alt Hours > 6
        App -> Log: Log "Auto-sync triggered"
        App -> AutoSync: asyncio.create_task(background_auto_sync())
        activate AutoSync

        AutoSync -> TT: Initialize TastytradeClient()
        activate TT
        AutoSync -> TT: authenticate()
        TT --> AutoSync: Authentication result

        alt Authentication successful
            AutoSync -> TT: get_all_accounts()
            TT --> AutoSync: Account list

            AutoSync -> DB: Save accounts to database
            activate DB
            DB --> AutoSync: Accounts saved
            deactivate DB

            AutoSync -> TT: get_positions()
            TT --> AutoSync: Current positions

            AutoSync -> DB: save_positions()
            activate DB
            DB --> AutoSync: Positions saved
            deactivate DB

            AutoSync -> DB: update_last_sync_timestamp()
            activate DB
            DB --> AutoSync: Timestamp updated
            deactivate DB

            AutoSync -> Log: Log "Background auto-sync completed"
        else Authentication failed
            AutoSync -> Log: Log "Auto-sync: Failed to authenticate"
        end

        deactivate TT
        deactivate AutoSync

    else Hours <= 6
        App -> Log: Log "No auto-sync needed"
    end

else No previous sync
    App -> Log: Log "No previous sync found"
end

deactivate App

== Server Startup ==

Process -> Process: uvicorn.run(\n  app="app:app",\n  host="0.0.0.0",\n  port=8000,\n  reload=True\n)

Process -> Log: Log "Starting Trade Journal on http://localhost:8000"

Process -> Process: Bind to all interfaces (0.0.0.0:8000)\nEnable hot reload for development

== Ready State ==

Process --> User: Server ready\nWeb interface available at\nhttp://localhost:8000

note over User, AutoSync
  Application is now ready to serve requests.

  Key endpoints available:
  • GET / → Open Positions page (static/positions.html)
  • GET /chains → Order Chains page (static/chains-v2.html)
  • POST /api/sync → Manual sync with Tastytrade
  • GET /api/positions → Current positions data
  • WebSocket /ws/quotes → Live market data
end note

@enduml