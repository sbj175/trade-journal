<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptionLedger Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/tailwind-config.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="/static/admin-app.js"></script>
</head>
<body class="bg-tv-bg text-tv-text min-h-screen" x-data="adminApp()">

    <!-- Login Screen -->
    <template x-if="!authenticated">
        <div class="flex items-center justify-center min-h-screen">
            <div class="bg-tv-panel border border-tv-border rounded-lg p-8 w-full max-w-md">
                <h1 class="text-2xl font-bold mb-6 text-center">OptionLedger Admin</h1>
                <form @submit.prevent="login" class="space-y-4">
                    <div>
                        <label class="block text-sm text-tv-muted mb-1">Admin Passphrase</label>
                        <input
                            type="password"
                            x-model="passphrase"
                            class="w-full bg-tv-bg border border-tv-border rounded px-3 py-2 text-tv-text focus:outline-none focus:border-tv-blue"
                            placeholder="Enter passphrase"
                            autofocus
                        >
                    </div>
                    <template x-if="authError">
                        <p class="text-tv-red text-sm" x-text="authError"></p>
                    </template>
                    <button
                        type="submit"
                        class="w-full bg-tv-blue text-white rounded px-4 py-2 font-medium hover:opacity-90 transition-opacity"
                    >Sign In</button>
                </form>
            </div>
        </div>
    </template>

    <!-- Dashboard -->
    <template x-if="authenticated">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-2xl font-bold">OptionLedger Admin</h1>
                <div class="flex items-center gap-3">
                    <button
                        @click="loadData()"
                        :disabled="loading"
                        class="bg-tv-panel border border-tv-border rounded px-3 py-1.5 text-sm hover:border-tv-blue transition-colors disabled:opacity-50"
                    >
                        <span x-show="!loading">Refresh</span>
                        <span x-show="loading">Loading...</span>
                    </button>
                    <button
                        @click="logout()"
                        class="text-tv-muted hover:text-tv-red text-sm transition-colors"
                    >Sign Out</button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-tv-panel border border-tv-border rounded-lg p-4">
                    <div class="text-tv-muted text-sm mb-1">Total Users</div>
                    <div class="text-2xl font-bold" x-text="formatNumber(stats.total_users)"></div>
                </div>
                <div class="bg-tv-panel border border-tv-border rounded-lg p-4">
                    <div class="text-tv-muted text-sm mb-1">Active Users</div>
                    <div class="text-2xl font-bold text-tv-green" x-text="formatNumber(stats.active_users)"></div>
                </div>
                <div class="bg-tv-panel border border-tv-border rounded-lg p-4">
                    <div class="text-tv-muted text-sm mb-1">Tastytrade Linked</div>
                    <div class="text-2xl font-bold text-tv-blue" x-text="formatNumber(stats.tt_connected)"></div>
                </div>
                <div class="bg-tv-panel border border-tv-border rounded-lg p-4">
                    <div class="text-tv-muted text-sm mb-1">Brokerage Accounts</div>
                    <div class="text-2xl font-bold" x-text="formatNumber(stats.total_accounts)"></div>
                </div>
            </div>

            <!-- Database Health -->
            <template x-if="dbHealth && dbHealth.status !== 'error'">
                <div class="mb-8">
                    <div class="bg-tv-panel border border-tv-border rounded-lg overflow-hidden">
                        <div class="px-4 py-3 border-b border-tv-border">
                            <h2 class="text-lg font-semibold">Database Health</h2>
                        </div>
                        <div class="p-4 space-y-4">
                            <!-- Top metrics row -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-tv-bg rounded-lg p-3">
                                    <div class="text-tv-muted text-xs mb-1 flex items-center gap-1">
                                        Status
                                        <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-tv-muted/50 text-tv-muted text-[9px] cursor-help" title="Whether the app can reach PostgreSQL. A failed SELECT 1 query turns this red.">?</span>
                                    </div>
                                    <div class="text-lg font-bold text-tv-green">Connected</div>
                                    <div class="text-tv-muted text-xs mt-0.5" x-text="dbHealth.dialect"></div>
                                </div>
                                <div class="bg-tv-bg rounded-lg p-3">
                                    <div class="text-tv-muted text-xs mb-1 flex items-center gap-1">
                                        Query Latency
                                        <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-tv-muted/50 text-tv-muted text-[9px] cursor-help" title="Round-trip time for a simple SELECT 1 query. Under 5 ms is typical for a local database; higher values may indicate network latency to a remote host.">?</span>
                                    </div>
                                    <div class="text-lg font-bold" x-text="dbHealth.query_latency_ms + ' ms'"></div>
                                    <div class="text-tv-muted text-xs mt-0.5">SELECT 1 round-trip</div>
                                </div>
                                <div class="bg-tv-bg rounded-lg p-3">
                                    <div class="text-tv-muted text-xs mb-1 flex items-center gap-1">
                                        Database Size
                                        <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-tv-muted/50 text-tv-muted text-[9px] cursor-help" title="Total disk space used by the database, including tables, indexes, and TOAST data. Reported by pg_database_size().">?</span>
                                    </div>
                                    <div class="text-lg font-bold" x-text="dbHealth.database_size"></div>
                                    <div class="text-tv-muted text-xs mt-0.5" x-text="formatNumber(dbHealth.database_size_bytes) + ' bytes'"></div>
                                </div>
                                <div class="bg-tv-bg rounded-lg p-3">
                                    <div class="text-tv-muted text-xs mb-1 flex items-center gap-1">
                                        Schema Version
                                        <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-tv-muted/50 text-tv-muted text-[9px] cursor-help" title="Current Alembic migration revision. Should match the latest migration in the codebase. A mismatch means pending migrations need to be applied.">?</span>
                                    </div>
                                    <div class="text-lg font-bold font-mono" x-text="dbHealth.schema_version || 'N/A'"></div>
                                    <div class="text-tv-muted text-xs mt-0.5">alembic revision</div>
                                </div>
                            </div>

                            <!-- Connection Pool -->
                            <div x-data="{ pool: dbHealth.connection_pool }">
                                <div class="text-sm font-medium text-tv-muted mb-2 flex items-center gap-1">
                                    Connection Pool
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-tv-muted/50 text-tv-muted text-[9px] cursor-help" title="SQLAlchemy maintains a pool of reusable database connections to avoid the overhead of opening a new connection for every request.">?</span>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    <div class="bg-tv-bg rounded px-3 py-2 flex justify-between items-center">
                                        <span class="text-tv-muted text-xs flex items-center gap-1">
                                            Pool Size
                                            <span class="inline-flex items-center justify-center w-3 h-3 rounded-full border border-tv-muted/50 text-tv-muted text-[8px] cursor-help" title="Maximum number of persistent connections kept in the pool. These stay open and are reused across requests.">?</span>
                                        </span>
                                        <span class="font-mono text-sm" x-text="pool.pool_size"></span>
                                    </div>
                                    <div class="bg-tv-bg rounded px-3 py-2 flex justify-between items-center">
                                        <span class="text-tv-muted text-xs flex items-center gap-1">
                                            Checked Out
                                            <span class="inline-flex items-center justify-center w-3 h-3 rounded-full border border-tv-muted/50 text-tv-muted text-[8px] cursor-help" title="Connections currently in use by an active request. These are unavailable to other requests until released.">?</span>
                                        </span>
                                        <span class="font-mono text-sm" x-text="pool.checked_out"></span>
                                    </div>
                                    <div class="bg-tv-bg rounded px-3 py-2 flex justify-between items-center">
                                        <span class="text-tv-muted text-xs flex items-center gap-1">
                                            Checked In
                                            <span class="inline-flex items-center justify-center w-3 h-3 rounded-full border border-tv-muted/50 text-tv-muted text-[8px] cursor-help" title="Idle connections sitting in the pool, ready to be reused by the next request.">?</span>
                                        </span>
                                        <span class="font-mono text-sm" x-text="pool.checked_in"></span>
                                    </div>
                                    <div class="bg-tv-bg rounded px-3 py-2 flex justify-between items-center">
                                        <span class="text-tv-muted text-xs flex items-center gap-1">
                                            Overflow
                                            <span class="inline-flex items-center justify-center w-3 h-3 rounded-full border border-tv-muted/50 text-tv-muted text-[8px] cursor-help" title="Extra connections beyond pool_size, shown as current / max. Negative values mean the pool hasn't fully warmed up yet (connections are created lazily). Positive values mean demand exceeded pool_size. These temporary connections are discarded after use.">?</span>
                                        </span>
                                        <span class="font-mono text-sm" x-text="pool.overflow + ' / ' + pool.max_overflow"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Table Sizes -->
                            <div x-data="{ tablesOpen: false }">
                                <button @click="tablesOpen = !tablesOpen" class="text-sm font-medium text-tv-muted mb-2 flex items-center gap-1 hover:text-tv-text transition-colors">
                                    <span class="text-xs" x-text="tablesOpen ? '\u25BC' : '\u25B6'"></span>
                                    Tables
                                    <span class="text-tv-muted/70 font-normal" x-text="'(' + dbHealth.tables.length + ')'"></span>
                                    <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-tv-muted/50 text-tv-muted text-[9px] cursor-help" @click.stop title="Row counts are estimates from pg_stat_user_tables (fast, avoids full table scans). Sizes include table data, indexes, and TOAST storage. Sorted largest first.">?</span>
                                </button>
                                <div x-show="tablesOpen" x-collapse class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="border-b border-tv-border text-tv-muted text-left">
                                                <th class="px-3 py-1.5">Table</th>
                                                <th class="px-3 py-1.5 text-right">Rows (est.)</th>
                                                <th class="px-3 py-1.5 text-right">Size</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="t in dbHealth.tables" :key="t.name">
                                                <tr class="border-b border-tv-border/30">
                                                    <td class="px-3 py-1.5 font-mono text-xs" x-text="t.name"></td>
                                                    <td class="px-3 py-1.5 text-right" x-text="formatNumber(t.rows)"></td>
                                                    <td class="px-3 py-1.5 text-right text-tv-muted" x-text="t.size"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- DB Health Error State -->
            <template x-if="dbHealth && dbHealth.status === 'error'">
                <div class="mb-8">
                    <div class="bg-tv-panel border border-tv-border rounded-lg p-4">
                        <h2 class="text-lg font-semibold mb-2">Database Health</h2>
                        <div class="bg-tv-bg rounded-lg p-3 text-tv-red text-sm">
                            <span class="font-medium">Error:</span>
                            <span x-text="dbHealth.error"></span>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Users Table -->
            <div class="bg-tv-panel border border-tv-border rounded-lg overflow-hidden">
                <div class="px-4 py-3 border-b border-tv-border">
                    <h2 class="text-lg font-semibold">Users</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-tv-border text-tv-muted text-left">
                                <th class="px-4 py-2 cursor-pointer hover:text-tv-text select-none" @click="toggleSort('email')">Email<span class="text-xs ml-0.5" x-text="sortIcon('email')"></span></th>
                                <th class="px-4 py-2 cursor-pointer hover:text-tv-text select-none" @click="toggleSort('created_at')">Joined<span class="text-xs ml-0.5" x-text="sortIcon('created_at')"></span></th>
                                <th class="px-4 py-2 text-center cursor-pointer hover:text-tv-text select-none" @click="toggleSort('accounts')">Accounts<span class="text-xs ml-0.5" x-text="sortIcon('accounts')"></span></th>
                                <th class="px-4 py-2 text-center cursor-pointer hover:text-tv-text select-none" @click="toggleSort('tt_connected')">Linked<span class="text-xs ml-0.5" x-text="sortIcon('tt_connected')"></span></th>
                                <th class="px-4 py-2 text-right cursor-pointer hover:text-tv-text select-none" @click="toggleSort('txn_count')">Txns<span class="text-xs ml-0.5" x-text="sortIcon('txn_count')"></span></th>
                                <th class="px-4 py-2 text-right cursor-pointer hover:text-tv-text select-none" @click="toggleSort('positions')">Positions<span class="text-xs ml-0.5" x-text="sortIcon('positions')"></span></th>
                                <th class="px-4 py-2 text-right cursor-pointer hover:text-tv-text select-none" @click="toggleSort('days_of_history')">History<span class="text-xs ml-0.5" x-text="sortIcon('days_of_history')"></span></th>
                                <th class="px-4 py-2 cursor-pointer hover:text-tv-text select-none" @click="toggleSort('last_login_at')">Last Login<span class="text-xs ml-0.5" x-text="sortIcon('last_login_at')"></span></th>
                                <th class="px-4 py-2 cursor-pointer hover:text-tv-text select-none" @click="toggleSort('last_sync')">Last Sync<span class="text-xs ml-0.5" x-text="sortIcon('last_sync')"></span></th>
                                <th class="px-4 py-2 text-right">Actions</th>
                            </tr>
                        </thead>
                        <template x-for="user in sortedUsers" :key="user.id">
                            <tbody>
                                <tr class="border-b border-tv-border/50 hover:bg-tv-bg/50 transition-colors cursor-pointer"
                                    @click="expandedUser === user.id ? expandedUser = null : expandedUser = user.id">
                                    <td class="px-4 py-2">
                                        <span class="inline-block w-3 text-tv-muted text-xs mr-1" x-text="expandedUser === user.id ? '\u25BC' : '\u25B6'"></span>
                                        <span x-text="user.email || 'Default User'" :class="!user.email && 'text-tv-muted italic'"></span>
                                    </td>
                                    <td class="px-4 py-2 text-tv-muted" x-text="formatDate(user.created_at)"></td>
                                    <td class="px-4 py-2 text-center" x-text="user.accounts"></td>
                                    <td class="px-4 py-2 text-center">
                                        <span
                                            :class="user.tt_connected ? 'text-tv-green' : 'text-tv-muted'"
                                            x-text="user.tt_connected ? 'Yes' : 'No'"
                                        ></span>
                                    </td>
                                    <td class="px-4 py-2 text-right" x-text="formatNumber(user.txn_count)"></td>
                                    <td class="px-4 py-2 text-right" x-text="formatNumber(user.positions)"></td>
                                    <td class="px-4 py-2 text-right">
                                        <span x-text="user.days_of_history != null ? user.days_of_history + 'd' : '-'"></span>
                                    </td>
                                    <td class="px-4 py-2 text-tv-muted" x-text="formatDateTime(user.last_login_at)"></td>
                                    <td class="px-4 py-2 text-tv-muted" x-text="formatDateTime(user.last_sync)"></td>
                                    <td class="px-4 py-2 text-right" @click.stop>
                                        <div class="flex items-center justify-end gap-2">
                                            <button
                                                @click="resetSync(user)"
                                                class="text-tv-blue hover:underline text-xs"
                                                title="Reset sync metadata"
                                            >Reset Sync</button>
                                            <button
                                                @click="openDeleteModal(user)"
                                                class="text-tv-red hover:underline text-xs"
                                                title="Delete all user data"
                                            >Delete Data</button>
                                            <button
                                                @click="openDeleteUserModal(user)"
                                                class="text-tv-red hover:underline text-xs"
                                                title="Delete user and all data"
                                            >Delete User</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr x-show="expandedUser === user.id" x-collapse>
                                    <td colspan="10" class="px-4 py-3 bg-tv-bg/70">
                                        <template x-if="Object.keys(user.accounts_detail || {}).length === 0">
                                            <div class="text-tv-muted text-xs italic">No positions</div>
                                        </template>
                                        <template x-if="Object.keys(user.accounts_detail || {}).length > 0">
                                            <div class="space-y-3">
                                                <template x-for="[acct, strategies] in Object.entries(user.accounts_detail)" :key="acct">
                                                    <div>
                                                        <div class="text-xs text-tv-muted mb-1">Account <span class="text-tv-text" x-text="acct"></span></div>
                                                        <div class="flex flex-wrap gap-1.5">
                                                            <template x-for="s in strategies" :key="s.strategy">
                                                                <span class="inline-block bg-tv-panel border border-tv-border rounded px-2 py-0.5 text-xs">
                                                                    <span x-text="s.strategy"></span>
                                                                    <span class="text-tv-muted ml-1" x-text="'(' + s.count + ')'"></span>
                                                                </span>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </td>
                                </tr>
                            </tbody>
                        </template>
                        <tbody x-show="users.length === 0 && !loading">
                            <tr>
                                <td colspan="10" class="px-4 py-8 text-center text-tv-muted">No users found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>

    <!-- Delete Data Confirmation Modal -->
    <template x-if="deleteModal.open">
        <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50" @click.self="closeDeleteModal()">
            <div class="bg-tv-panel border border-tv-border rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-bold text-tv-red mb-2">Delete User Data</h3>
                <p class="text-sm text-tv-muted mb-4">
                    This will permanently delete all trading data for
                    <strong class="text-tv-text" x-text="deleteModal.user?.email || deleteModal.user?.id"></strong>.
                    The user account itself will be preserved.
                </p>
                <p class="text-sm mb-3">
                    Type <code class="bg-tv-bg px-1 py-0.5 rounded text-tv-red" x-text="deleteModal.user?.email || deleteModal.user?.id"></code> to confirm:
                </p>
                <input
                    type="text"
                    x-model="deleteModal.confirmEmail"
                    class="w-full bg-tv-bg border border-tv-border rounded px-3 py-2 text-tv-text mb-4 focus:outline-none focus:border-tv-red"
                    placeholder="Type to confirm"
                >
                <div class="flex justify-end gap-3">
                    <button
                        @click="closeDeleteModal()"
                        class="px-4 py-2 text-sm text-tv-muted hover:text-tv-text transition-colors"
                    >Cancel</button>
                    <button
                        @click="confirmDeleteData()"
                        :disabled="!canConfirmDelete"
                        class="px-4 py-2 text-sm bg-tv-red text-white rounded font-medium disabled:opacity-30 disabled:cursor-not-allowed hover:opacity-90 transition-opacity"
                    >Delete All Data</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Delete User Confirmation Modal -->
    <template x-if="deleteUserModal.open">
        <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50" @click.self="closeDeleteUserModal()">
            <div class="bg-tv-panel border border-tv-border rounded-lg p-6 w-full max-w-md">
                <h3 class="text-lg font-bold text-tv-red mb-2">Delete User</h3>
                <p class="text-sm text-tv-muted mb-4">
                    This will permanently delete the user account
                    <strong class="text-tv-text" x-text="deleteUserModal.user?.email || deleteUserModal.user?.id"></strong>
                    and all their trading data. This frees up a beta slot.
                </p>
                <p class="text-sm mb-3">
                    Type <code class="bg-tv-bg px-1 py-0.5 rounded text-tv-red" x-text="deleteUserModal.user?.email || deleteUserModal.user?.id"></code> to confirm:
                </p>
                <input
                    type="text"
                    x-model="deleteUserModal.confirmEmail"
                    class="w-full bg-tv-bg border border-tv-border rounded px-3 py-2 text-tv-text mb-4 focus:outline-none focus:border-tv-red"
                    placeholder="Type to confirm"
                >
                <div class="flex justify-end gap-3">
                    <button
                        @click="closeDeleteUserModal()"
                        class="px-4 py-2 text-sm text-tv-muted hover:text-tv-text transition-colors"
                    >Cancel</button>
                    <button
                        @click="confirmDeleteUser()"
                        :disabled="!canConfirmDeleteUser"
                        class="px-4 py-2 text-sm bg-tv-red text-white rounded font-medium disabled:opacity-30 disabled:cursor-not-allowed hover:opacity-90 transition-opacity"
                    >Delete User</button>
                </div>
            </div>
        </div>
    </template>

</body>
</html>
