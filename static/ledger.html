<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptionLedger - Ledger</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232962ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='22 12 18 12 15 21 9 3 6 12 2 12'></polyline></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/tailwind-config.js"></script>

    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif; }
        body { background: #131722; color: #d1d4dc; font-size: 16px; }
        .tv-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .tv-scrollbar::-webkit-scrollbar-track { background: #1e222d; }
        .tv-scrollbar::-webkit-scrollbar-thumb { background: #2a2e39; border-radius: 3px; }
        .tv-scrollbar::-webkit-scrollbar-thumb:hover { background: #363a45; }
        [x-cloak] { display: none !important; }
        .spinner {
            border: 2px solid #2a2e39;
            border-top: 2px solid #2962ff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- Shared utilities and constants -->
    <script src="/static/js/constants.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/ledger-app.js"></script>
</head>
<body class="min-h-screen tv-scrollbar" x-data="ledgerApp">

    {% include 'partials/nav.html' %}

    <!-- Action Bar -->
    <div class="bg-tv-panel border-b border-tv-border px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-4">
        </div>

        <!-- Filters -->
        <div class="flex items-center gap-6 text-base">
            <!-- Symbol Filter -->
            <div class="relative">
                <input type="text"
                       x-model="filterUnderlying"
                       @focus="$event.target.select()"
                       @keyup.enter="applyFilters(); localStorage.setItem('trade_journal_selected_underlying', filterUnderlying || ''); cleanUrlParams()"
                       @blur="applyFilters(); localStorage.setItem('trade_journal_selected_underlying', filterUnderlying || ''); cleanUrlParams()"
                       @input="filterUnderlying = filterUnderlying.toUpperCase()"
                       placeholder="Symbol"
                       class="bg-tv-bg border border-tv-border text-tv-text text-base px-3 py-2 w-28 uppercase placeholder:normal-case placeholder:text-tv-muted"
                       :class="filterUnderlying ? 'pr-8' : ''">
                <button x-show="filterUnderlying"
                        @click="filterUnderlying = ''; applyFilters(); localStorage.setItem('trade_journal_selected_underlying', ''); cleanUrlParams()"
                        class="absolute right-2 top-1/2 -translate-y-1/2 text-tv-muted hover:text-tv-text">
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>

            <!-- Time Filter -->
            <div class="flex items-center gap-2">
                <span class="text-tv-muted">Time:</span>
                <select x-model="timePeriod" @change="applyFilters(); saveState()"
                        class="bg-tv-bg border border-tv-border text-tv-text text-base px-3 py-2">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="7">7D</option>
                    <option value="30">30D</option>
                    <option value="60">60D</option>
                    <option value="90">90D</option>
                    <option value="all">All</option>
                </select>
            </div>

            <!-- Direction Filter -->
            <div class="flex items-center gap-2">
                <span class="text-tv-muted">Direction:</span>
                <button @click="toggleFilter('direction', 'bullish')"
                        :class="filterDirection.includes('bullish') ? 'bg-tv-green/20 text-tv-green border-tv-green/50' : 'bg-tv-bg text-tv-muted border-tv-border hover:text-tv-text'"
                        class="px-3 py-1.5 text-sm border rounded transition-colors">
                    Bullish
                </button>
                <button @click="toggleFilter('direction', 'bearish')"
                        :class="filterDirection.includes('bearish') ? 'bg-tv-red/20 text-tv-red border-tv-red/50' : 'bg-tv-bg text-tv-muted border-tv-border hover:text-tv-text'"
                        class="px-3 py-1.5 text-sm border rounded transition-colors">
                    Bearish
                </button>
                <button @click="toggleFilter('direction', 'neutral')"
                        :class="filterDirection.includes('neutral') ? 'bg-tv-blue/20 text-tv-blue border-tv-blue/50' : 'bg-tv-bg text-tv-muted border-tv-border hover:text-tv-text'"
                        class="px-3 py-1.5 text-sm border rounded transition-colors">
                    Neutral
                </button>
            </div>

            <!-- Type Filter -->
            <div class="flex items-center gap-2">
                <span class="text-tv-muted">Type:</span>
                <button @click="toggleFilter('type', 'credit')"
                        :class="filterType.includes('credit') ? 'bg-cyan-500/20 text-cyan-400 border-cyan-500/50' : 'bg-tv-bg text-tv-muted border-tv-border hover:text-tv-text'"
                        class="px-3 py-1.5 text-sm border rounded transition-colors">
                    Credit
                </button>
                <button @click="toggleFilter('type', 'debit')"
                        :class="filterType.includes('debit') ? 'bg-amber-500/20 text-amber-400 border-amber-500/50' : 'bg-tv-bg text-tv-muted border-tv-border hover:text-tv-text'"
                        class="px-3 py-1.5 text-sm border rounded transition-colors">
                    Debit
                </button>
            </div>

            <!-- Status Filter -->
            <div class="flex items-center gap-2">
                <label class="flex items-center gap-2 text-tv-muted">
                    <input type="checkbox" x-model="showOpen" @change="applyFilters(); saveState()" class="w-4 h-4">
                    <span class="text-tv-green text-sm">Open</span>
                </label>
                <label class="flex items-center gap-2 text-tv-muted">
                    <input type="checkbox" x-model="showClosed" @change="applyFilters(); saveState()" class="w-4 h-4">
                    <span class="text-tv-muted text-sm">Closed</span>
                </label>
            </div>

            <!-- Sort direction indicator -->
            <div class="flex items-center gap-1 text-tv-muted text-sm">
                <i class="fas fa-sort"></i>
                <span x-text="sortColumn === 'opening_date' ? 'Date' : sortColumn === 'underlying' ? 'Symbol' : sortColumn === 'strategy_label' ? 'Strategy' : sortColumn === 'status' ? 'Status' : sortColumn === 'closing_date' ? 'Closed' : 'P&L'"></span>
                <span x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="bg-tv-panel/50 border-b border-tv-border px-4 py-2 flex items-center gap-8 text-base">
        <span class="text-tv-muted">
            Groups: <span class="text-tv-text" x-text="filteredGroups.length"></span>
        </span>
        <span class="text-tv-muted">
            Open: <span class="text-tv-green" x-text="stats.openCount"></span>
        </span>
        <span class="text-tv-muted">
            Closed: <span class="text-tv-text" x-text="stats.closedCount"></span>
        </span>
        <span class="text-tv-muted">
            Realized P&L:
            <span :class="stats.totalPnl >= 0 ? 'text-tv-green' : 'text-tv-red'"
                  x-text="'$' + formatNumber(stats.totalPnl)"></span>
        </span>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="flex items-center justify-center py-20">
        <div class="spinner mr-3"></div>
        <span class="text-tv-muted text-lg">Loading ledger data...</span>
    </div>

    <!-- Empty State -->
    <div x-show="!loading && filteredGroups.length === 0" class="text-center py-20">
        <i class="fas fa-book-open text-4xl text-tv-muted mb-4"></i>
        <p class="text-tv-muted text-lg">No position groups found.</p>
        <p class="text-tv-muted mt-2">Sync your data from the <a href="/positions" class="text-tv-blue hover:underline">Positions</a> page first.</p>
    </div>

    <!-- Group List -->
    <div x-show="!loading && filteredGroups.length > 0" class="py-2">
        <!-- Column Headers -->
        <div class="flex items-center px-8 py-2 text-sm text-tv-muted border-b border-tv-border bg-tv-panel/50 sticky top-0 z-10">
            <span class="w-6"></span>
            <span class="w-8 mr-3"></span>
            <span class="w-20 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortGroups('underlying')">
                Symbol
                <span x-show="sortColumn === 'underlying'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-40 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortGroups('strategy_label')">
                Strategy
                <span x-show="sortColumn === 'strategy_label'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-20 mr-6 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortGroups('status')">
                Status
                <span x-show="sortColumn === 'status'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-28 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortGroups('opening_date')">
                Opened
                <span x-show="sortColumn === 'opening_date'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-28 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortGroups('closing_date')">
                Closed
                <span x-show="sortColumn === 'closing_date'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="ml-auto cursor-pointer hover:text-tv-text flex items-center justify-end gap-1" @click="sortGroups('total_pnl')">
                Realized P&L
                <span x-show="sortColumn === 'total_pnl'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
        </div>

        <div class="px-4 pt-2">
        <template x-for="group in filteredGroups" :key="group.group_id">
            <div class="mb-2">
                <!-- Group Header Row -->
                <div @click="selectedLots.length > 0 && isEligibleTarget(group) ? moveLots(group.group_id) : (group.expanded = !group.expanded)"
                     class="flex items-center px-4 py-3 bg-tv-panel cursor-pointer border border-tv-border rounded-sm transition-colors"
                     :class="{
                         'border-b-0 rounded-b-none': group.expanded,
                         'hover:bg-tv-border/50': selectedLots.length === 0,
                         'border-l-4 !border-l-tv-blue bg-tv-blue/10 hover:bg-tv-blue/20': selectedLots.length > 0 && isEligibleTarget(group),
                         'opacity-40': selectedLots.length > 0 && isSourceGroup(group),
                         'opacity-60': selectedLots.length > 0 && !isEligibleTarget(group) && !isSourceGroup(group)
                     }">
                    <!-- Expand icon -->
                    <i class="fas fa-chevron-right w-6 text-tv-muted transition-transform duration-200"
                       :class="group.expanded ? 'rotate-90' : ''"></i>

                    <!-- Account badge -->
                    <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold mr-3"
                          :class="getAccountBadgeClass(group.account_number)"
                          x-text="getAccountSymbol(group.account_number)"></span>

                    <!-- Underlying -->
                    <span class="w-20 text-lg font-semibold text-tv-text" x-text="group.underlying"></span>

                    <!-- Strategy Label (inline edit) -->
                    <span class="w-40" @click.stop>
                        <template x-if="!group._editingStrategy">
                            <span class="flex items-center gap-1.5 group/strat">
                                <span class="text-tv-muted text-base truncate" x-text="group.strategy_label || '—'"></span>
                                <i class="fas fa-pencil-alt text-xs text-tv-muted/40 group-hover/strat:text-tv-muted hover:!text-tv-blue cursor-pointer transition-colors"
                                   @click="group._editingStrategy = true"
                                   title="Edit strategy label"></i>
                                <i class="fas fa-right-left text-xs text-tv-muted/40 group-hover/strat:text-tv-muted hover:!text-tv-blue cursor-pointer transition-colors"
                                   :class="group._movingLots ? '!text-tv-blue' : ''"
                                   @click="toggleGroupMoveMode(group)"
                                   title="Move lots between groups"></i>
                            </span>
                        </template>
                        <template x-if="group._editingStrategy">
                            <input type="text"
                                   :value="group.strategy_label || ''"
                                   @keyup.enter="updateGroupStrategy(group, $event.target.value); group._editingStrategy = false"
                                   @blur="updateGroupStrategy(group, $event.target.value); group._editingStrategy = false"
                                   @keyup.escape="group._editingStrategy = false"
                                   x-init="$el.focus(); $el.select()"
                                   class="w-36 bg-tv-bg border border-tv-border text-tv-text text-base px-2 py-1 rounded"
                                   placeholder="Strategy label">
                        </template>
                    </span>

                    <!-- Status -->
                    <span class="w-20 mr-6 text-sm px-2 py-0.5 rounded text-center"
                          :class="group.status === 'OPEN' ? 'bg-tv-green/20 text-tv-green' : 'bg-tv-muted/20 text-tv-muted'"
                          x-text="group.status"></span>

                    <!-- Opening date -->
                    <span class="w-28 text-tv-muted text-base" x-text="formatDate(group.opening_date)"></span>

                    <!-- Closing date -->
                    <span class="w-28 text-tv-muted text-base" x-text="group.closing_date ? formatDate(group.closing_date) : '—'"></span>

                    <!-- P&L (pushed right) -->
                    <span class="ml-auto text-base font-medium"
                          :class="group.realized_pnl >= 0 ? 'text-tv-green' : 'text-tv-red'"
                          x-show="group.realized_pnl">
                        $<span x-text="formatNumber(group.realized_pnl)"></span>
                    </span>
                </div>

                <!-- Expanded Detail -->
                <div x-show="group.expanded" x-cloak
                     class="bg-tv-bg border border-tv-border border-t-0 rounded-b-sm px-2 py-2">

                    <!-- Per-group view toggle -->
                    <div class="flex justify-start px-4 pt-1 pb-1">
                        <div class="flex items-center border border-tv-border rounded overflow-hidden text-xs">
                            <button @click.stop="group._viewMode = 'positions'"
                                    :class="groupViewMode(group) === 'positions' ? 'bg-tv-blue text-white' : 'bg-tv-bg text-tv-muted hover:text-tv-text'"
                                    class="px-2 py-1 transition-colors">
                                <i class="fas fa-layer-group mr-1"></i>Positions
                            </button>
                            <button @click.stop="group._viewMode = 'actions'"
                                    :class="groupViewMode(group) === 'actions' ? 'bg-tv-blue text-white' : 'bg-tv-bg text-tv-muted hover:text-tv-text'"
                                    class="px-2 py-1 transition-colors">
                                <i class="fas fa-list-ol mr-1"></i>Orders
                            </button>
                        </div>
                    </div>

                    <!-- Position View -->
                    <template x-if="groupViewMode(group) === 'positions'">
                        <div>
                            <!-- Lots Table Header -->
                            <div class="flex items-center text-sm text-tv-muted px-4 py-2 border-b border-tv-border/30 font-mono">
                                <span class="w-5"></span>
                                <span x-show="group._movingLots" class="w-8"></span>
                                <span class="w-32">Entry Date</span>
                                <span class="w-10 text-right">Qty</span>
                                <span class="w-16 text-center mx-2">Exp</span>
                                <span class="w-10">DTE</span>
                                <span class="w-16 text-center mx-2">Strike</span>
                                <span class="w-10">Type</span>
                                <span class="w-20 text-center ml-3">Status</span>
                                <span class="w-20 text-right">Entry $</span>
                                <span class="w-24 text-right ml-2">Cost Basis</span>
                                <span class="w-24 text-right ml-4">Realized</span>
                            </div>

                            <!-- Section A: Equity Aggregate -->
                            <template x-if="openEquityLots(group).length > 0">
                                <div x-data="{ eqExpanded: false }">
                                    <!-- Aggregate summary row -->
                                    <div @click="eqExpanded = !eqExpanded"
                                         class="flex items-center text-sm px-4 py-1.5 hover:bg-tv-panel/50 font-mono cursor-pointer"
                                         :class="eqExpanded ? 'bg-tv-panel/30' : ''">
                                        <i class="fas fa-chevron-right w-5 text-tv-muted text-xs transition-transform duration-200"
                                           :class="eqExpanded ? 'rotate-90' : ''"></i>
                                        <template x-if="group._movingLots">
                                            <span class="w-8">
                                                <input type="checkbox"
                                                       :checked="openEquityLots(group).every(l => selectedLots.includes(l.transaction_id))"
                                                       @click.stop="toggleAllEquityLots(group); if (!eqExpanded) eqExpanded = true"
                                                       class="w-4 h-4">
                                            </span>
                                        </template>
                                        <span class="w-32 text-tv-muted" x-text="equityAggregate(group).lotCount + ' lots'"></span>
                                        <span class="w-10 text-right font-medium"
                                              :class="equityAggregate(group).quantity > 0 ? 'text-tv-green' : 'text-tv-red'"
                                              x-text="equityAggregate(group).quantity"></span>
                                        <span class="w-16 text-center bg-tv-panel mx-2 py-0.5 rounded text-tv-text">Shares</span>
                                        <span class="w-10 text-tv-muted">&mdash;</span>
                                        <span class="w-16 text-center mx-2 py-0.5 rounded text-tv-muted">&mdash;</span>
                                        <span class="w-10 text-tv-muted">Stk</span>
                                        <span class="w-20 text-center text-sm px-1 py-0.5 rounded border ml-3 bg-tv-green/20 text-tv-green border-tv-green/50">OPEN</span>
                                        <span class="w-20 text-right text-tv-muted"
                                              x-text="'$' + formatNumber(equityAggregate(group).avgPrice)"></span>
                                        <span class="w-24 text-right text-tv-muted ml-2"
                                              x-text="'$' + formatNumber(equityAggregate(group).costBasis)"></span>
                                        <span class="w-24 text-right ml-4"></span>
                                    </div>

                                    <!-- Expanded individual equity lots -->
                                    <div x-show="eqExpanded" x-cloak>
                                        <template x-for="(lot, lotIdx) in openEquityLots(group)" :key="lot.lot_id">
                                            <div>
                                                <div @click="toggleLotExpand(lot)"
                                                     class="flex items-center text-sm px-4 py-1.5 hover:bg-tv-panel/50 font-mono cursor-pointer border-l-2 border-tv-blue/30"
                                                     :class="lot._expanded ? 'bg-tv-panel/30' : ''">
                                                    <i class="fas fa-chevron-right w-5 text-tv-muted text-xs transition-transform duration-200"
                                                       :class="lot._expanded ? 'rotate-90' : ''"></i>
                                                    <template x-if="group._movingLots">
                                                        <span class="w-8">
                                                            <input type="checkbox"
                                                                   :checked="selectedLots.includes(lot.transaction_id)"
                                                                   @click.stop="toggleLotSelection(lot.transaction_id)"
                                                                   class="w-4 h-4">
                                                        </span>
                                                    </template>
                                                    <span class="w-32 text-tv-muted">
                                                        <template x-if="lot.derivation_type">
                                                            <span class="text-tv-muted mr-1">&#8627;</span>
                                                        </template>
                                                        <span x-text="formatOrderDate(lot.entry_date)"></span>
                                                    </span>
                                                    <span class="w-10 text-right font-medium"
                                                          :class="(lot.remaining_quantity ?? lot.quantity) > 0 ? 'text-tv-green' : 'text-tv-red'"
                                                          x-text="lot.remaining_quantity ?? lot.quantity"></span>
                                                    <span class="w-16 text-center bg-tv-panel mx-2 py-0.5 rounded text-tv-text">Shares</span>
                                                    <span class="w-10 text-tv-muted">&mdash;</span>
                                                    <span class="w-16 text-center mx-2 py-0.5 rounded text-tv-muted">&mdash;</span>
                                                    <span class="w-10 text-tv-muted">Stk</span>
                                                    <span class="w-20 text-center text-sm px-1 py-0.5 rounded border ml-3 bg-tv-green/20 text-tv-green border-tv-green/50"
                                                          x-text="lot.status"></span>
                                                    <span class="w-20 text-right text-tv-muted"
                                                          x-text="lot.entry_price ? '$' + formatNumber(lot.entry_price) : ''"></span>
                                                    <span class="w-24 text-right text-tv-muted ml-2"
                                                          x-text="lot.cost_basis ? '$' + formatNumber(lot.cost_basis) : ''"></span>
                                                    <span class="w-24 text-right ml-4"
                                                          :class="lot.realized_pnl > 0 ? 'text-tv-green' : lot.realized_pnl < 0 ? 'text-tv-red' : 'text-tv-muted'"
                                                          x-text="lot.realized_pnl ? '$' + formatNumber(lot.realized_pnl) : ''"></span>
                                                </div>

                                                <!-- Expanded Events (opening + closings) -->
                                                <div x-show="lot._expanded" x-cloak class="border-l-2 border-tv-blue/30">
                                                    <div class="flex items-center text-sm px-4 py-1 text-tv-muted font-mono border-l-2 border-tv-border/30">
                                                        <span class="w-5"></span>
                                                        <span x-show="group._movingLots" class="w-8"></span>
                                                        <span class="w-8"></span>
                                                        <span class="w-24" x-text="formatOrderDate(lot.entry_date)"></span>
                                                        <span class="w-10 text-right"
                                                              :class="lot.quantity > 0 ? 'text-tv-green' : 'text-tv-red'"
                                                              x-text="(lot.quantity > 0 ? '+' : '') + lot.quantity"></span>
                                                        <span class="w-16 text-center mx-2"></span>
                                                        <span class="w-10"></span>
                                                        <span class="w-16 text-center mx-2"></span>
                                                        <span class="w-10"></span>
                                                        <span class="w-20 text-center text-xs px-1 py-0.5 rounded border ml-3"
                                                              :class="lot.quantity > 0 ? 'bg-tv-green/20 text-tv-green border-tv-green/50' : 'bg-tv-red/20 text-tv-red border-tv-red/50'"
                                                              x-text="lot.quantity > 0 ? 'BTO' : 'STO'"></span>
                                                        <span class="w-20 text-right" x-text="lot.entry_price ? '$' + formatNumber(lot.entry_price) : ''"></span>
                                                        <span class="w-24 text-right ml-2 whitespace-nowrap"
                                                              :class="lot.quantity < 0 ? 'text-tv-green' : 'text-tv-red'"
                                                              x-text="lot.cost_basis ? ('$' + formatNumber(lot.cost_basis) + (lot.quantity < 0 ? ' cr' : ' db')) : ''"></span>
                                                        <span class="w-24 ml-4"></span>
                                                    </div>
                                                    <template x-for="closing in (lot.closings || [])" :key="closing.closing_id">
                                                        <div class="flex items-center text-sm px-4 py-1 text-tv-muted font-mono border-l-2 border-tv-border/30">
                                                            <span class="w-5"></span>
                                                            <span x-show="group._movingLots" class="w-8"></span>
                                                            <span class="w-8"></span>
                                                            <span class="w-24" x-text="formatOrderDate(closing.closing_date)"></span>
                                                            <span class="w-10 text-right"
                                                                  :class="lot.quantity < 0 ? 'text-tv-green' : 'text-tv-red'"
                                                                  x-text="(lot.quantity < 0 ? '+' : '-') + closing.quantity_closed"></span>
                                                            <span class="w-16 text-center mx-2"></span>
                                                            <span class="w-10"></span>
                                                            <span class="w-16 text-center mx-2"></span>
                                                            <span class="w-10"></span>
                                                            <span class="w-20 text-center text-xs px-1 py-0.5 rounded border ml-3"
                                                                  :class="{
                                                                      'bg-tv-green/20 text-tv-green border-tv-green/50': (closing.closing_type === 'MANUAL' || closing.closing_type === 'EXPIRATION') && lot.quantity < 0,
                                                                      'bg-tv-red/20 text-tv-red border-tv-red/50': (closing.closing_type === 'MANUAL' || closing.closing_type === 'EXPIRATION') && lot.quantity >= 0,
                                                                      'bg-orange-500/20 text-orange-400 border-orange-500/50': closing.closing_type === 'ASSIGNMENT',
                                                                      'bg-purple-500/20 text-purple-400 border-purple-500/50': closing.closing_type === 'EXERCISE'
                                                                  }"
                                                                  x-text="closing.closing_type === 'MANUAL' ? (lot.quantity < 0 ? 'BTC' : 'STC') : closing.closing_type === 'EXPIRATION' ? 'EXPIRED' : closing.closing_type"></span>
                                                            <span class="w-20 text-right" x-text="closing.closing_price ? '$' + formatNumber(closing.closing_price) : ''"></span>
                                                            <span class="w-24 text-right ml-2 whitespace-nowrap"
                                                                  :class="lot.quantity < 0 ? 'text-tv-red' : 'text-tv-green'"
                                                                  x-text="closing.closing_price ? ('$' + formatNumber(closing.quantity_closed * closing.closing_price * (lot.option_type ? 100 : 1)) + (lot.quantity < 0 ? ' db' : ' cr')) : ''"></span>
                                                            <span class="w-24 ml-4"></span>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- Separator between equity aggregate and option/closed lots -->
                            <template x-if="openEquityLots(group).length > 0 && sortedOptionLots(group).length > 0">
                                <div class="border-t border-tv-muted/20 my-2 mx-4"></div>
                            </template>

                            <!-- Section B: Option lots + closed equity lots -->
                            <template x-for="(lot, lotIdx) in sortedOptionLots(group)" :key="lot.lot_id">
                                <div>
                                    <!-- Separator between open and closed -->
                                    <template x-if="lotIdx > 0 && lot.status === 'CLOSED' && sortedOptionLots(group)[lotIdx - 1].status !== 'CLOSED'">
                                        <div class="border-t border-tv-muted/40 my-3 mx-4"></div>
                                    </template>
                                    <div @click="toggleLotExpand(lot)"
                                         class="flex items-center text-sm px-4 py-1.5 hover:bg-tv-panel/50 font-mono cursor-pointer"
                                         :class="lot._expanded ? 'bg-tv-panel/30' : ''">
                                        <!-- Expand chevron -->
                                        <i class="fas fa-chevron-right w-5 text-tv-muted text-xs transition-transform duration-200"
                                           :class="lot._expanded ? 'rotate-90' : ''"></i>

                                        <!-- Checkbox (edit mode) -->
                                        <template x-if="group._movingLots">
                                            <span class="w-8">
                                                <input type="checkbox"
                                                       :checked="selectedLots.includes(lot.transaction_id)"
                                                       @click.stop="toggleLotSelection(lot.transaction_id)"
                                                       class="w-4 h-4">
                                            </span>
                                        </template>

                                        <!-- Entry Date (with derivation indicator for derived lots) -->
                                        <span class="w-32 text-tv-muted">
                                            <template x-if="lot.derivation_type">
                                                <span class="text-tv-muted mr-1">&#8627;</span>
                                            </template>
                                            <span x-text="formatOrderDate(lot.entry_date)"></span>
                                        </span>

                                        <!-- Qty -->
                                        <span class="w-10 text-right font-medium"
                                              :class="lot.quantity > 0 ? 'text-tv-green' : 'text-tv-red'"
                                              x-text="lot.quantity"></span>

                                        <!-- Expiration -->
                                        <span class="w-16 text-center bg-tv-panel mx-2 py-0.5 rounded text-tv-text"
                                              x-text="lot.expiration ? formatExpirationShort(lot.expiration) : (lot.instrument_type === 'EQUITY' ? 'Shares' : '—')"></span>

                                        <!-- DTE -->
                                        <span class="w-10 text-tv-muted"
                                              :class="lot.expiration && calculateDTE(lot.expiration) <= 21 ? 'text-amber-400 font-bold' : ''"
                                              x-text="lot.expiration ? calculateDTE(lot.expiration) + 'd' : '—'"></span>

                                        <!-- Strike -->
                                        <span class="w-16 text-center mx-2 py-0.5 rounded"
                                              :class="lot.strike ? 'bg-tv-panel text-tv-text' : 'text-tv-muted'"
                                              x-text="lot.strike || '—'"></span>

                                        <!-- Option Type -->
                                        <span class="w-10 text-tv-muted"
                                              x-text="lot.option_type ? (lot.option_type.toUpperCase().startsWith('C') ? 'Call' : 'Put') : (lot.instrument_type === 'EQUITY' ? 'Stk' : '—')"></span>

                                        <!-- Status -->
                                        <span class="w-20 text-center text-sm px-1 py-0.5 rounded border ml-3"
                                              :class="lot.status === 'OPEN' ? 'bg-tv-green/20 text-tv-green border-tv-green/50' : lot.status === 'PARTIAL' ? 'bg-amber-500/20 text-amber-400 border-amber-500/50' : 'bg-tv-muted/20 text-tv-muted border-tv-red/50'"
                                              x-text="lot.status"></span>

                                        <!-- Entry Price -->
                                        <span class="w-20 text-right text-tv-muted"
                                              x-text="lot.entry_price ? '$' + formatNumber(lot.entry_price) : ''"></span>

                                        <!-- Cost Basis (blank when closed) -->
                                        <span class="w-24 text-right text-tv-muted ml-2"
                                              x-text="lot.status === 'CLOSED' ? '' : (lot.cost_basis ? '$' + formatNumber(lot.cost_basis) : '')"></span>

                                        <!-- Realized P&L -->
                                        <span class="w-24 text-right ml-4"
                                              :class="lot.realized_pnl > 0 ? 'text-tv-green' : lot.realized_pnl < 0 ? 'text-tv-red' : 'text-tv-muted'"
                                              x-text="lot.realized_pnl ? '$' + formatNumber(lot.realized_pnl) : ''"></span>
                                    </div>

                                    <!-- Expanded Events (opening + closings) -->
                                    <div x-show="lot._expanded" x-cloak>
                                        <!-- Opening Event -->
                                        <div class="flex items-center text-sm px-4 py-1 text-tv-muted font-mono border-l-2 border-tv-border/30">
                                            <span class="w-5"></span>
                                            <span x-show="group._movingLots" class="w-8"></span>
                                            <span class="w-8"></span>
                                            <span class="w-24" x-text="formatOrderDate(lot.entry_date)"></span>
                                            <span class="w-10 text-right"
                                                  :class="lot.quantity > 0 ? 'text-tv-green' : 'text-tv-red'"
                                                  x-text="(lot.quantity > 0 ? '+' : '') + lot.quantity"></span>
                                            <span class="w-16 text-center mx-2"></span>
                                            <span class="w-10"></span>
                                            <span class="w-16 text-center mx-2"></span>
                                            <span class="w-10"></span>
                                            <!-- Action in Status column -->
                                            <span class="w-20 text-center text-xs px-1 py-0.5 rounded border ml-3"
                                                  :class="lot.quantity > 0 ? 'bg-tv-green/20 text-tv-green border-tv-green/50' : 'bg-tv-red/20 text-tv-red border-tv-red/50'"
                                                  x-text="lot.quantity > 0 ? 'BTO' : 'STO'"></span>
                                            <!-- Per-share price -->
                                            <span class="w-20 text-right" x-text="lot.entry_price ? '$' + formatNumber(lot.entry_price) : ''"></span>
                                            <!-- Total credit/debit -->
                                            <span class="w-24 text-right ml-2 whitespace-nowrap"
                                                  :class="lot.quantity < 0 ? 'text-tv-green' : 'text-tv-red'"
                                                  x-text="lot.cost_basis ? ('$' + formatNumber(lot.cost_basis) + (lot.quantity < 0 ? ' cr' : ' db')) : ''"></span>
                                            <span class="w-24 ml-4"></span>
                                        </div>

                                        <!-- Closing Events (sub-rows) -->
                                        <template x-for="closing in (lot.closings || [])" :key="closing.closing_id">
                                            <div class="flex items-center text-sm px-4 py-1 text-tv-muted font-mono border-l-2 border-tv-border/30">
                                                <span class="w-5"></span>
                                                <span x-show="group._movingLots" class="w-8"></span>
                                                <span class="w-8"></span>
                                                <span class="w-24" x-text="formatOrderDate(closing.closing_date)"></span>
                                                <span class="w-10 text-right"
                                                      :class="lot.quantity < 0 ? 'text-tv-green' : 'text-tv-red'"
                                                      x-text="(lot.quantity < 0 ? '+' : '-') + closing.quantity_closed"></span>
                                                <span class="w-16 text-center mx-2"></span>
                                                <span class="w-10"></span>
                                                <span class="w-16 text-center mx-2"></span>
                                                <span class="w-10"></span>
                                                <!-- Closing type badge in Status column -->
                                                <span class="w-20 text-center text-xs px-1 py-0.5 rounded border ml-3"
                                                      :class="{
                                                          'bg-tv-green/20 text-tv-green border-tv-green/50': (closing.closing_type === 'MANUAL' || closing.closing_type === 'EXPIRATION') && lot.quantity < 0,
                                                          'bg-tv-red/20 text-tv-red border-tv-red/50': (closing.closing_type === 'MANUAL' || closing.closing_type === 'EXPIRATION') && lot.quantity >= 0,
                                                          'bg-orange-500/20 text-orange-400 border-orange-500/50': closing.closing_type === 'ASSIGNMENT',
                                                          'bg-purple-500/20 text-purple-400 border-purple-500/50': closing.closing_type === 'EXERCISE'
                                                      }"
                                                      x-text="closing.closing_type === 'MANUAL' ? (lot.quantity < 0 ? 'BTC' : 'STC') : closing.closing_type === 'EXPIRATION' ? 'EXPIRED' : closing.closing_type"></span>
                                                <!-- Per-share price -->
                                                <span class="w-20 text-right" x-text="closing.closing_price ? '$' + formatNumber(closing.closing_price) : ''"></span>
                                                <!-- Total credit/debit -->
                                                <span class="w-24 text-right ml-2 whitespace-nowrap"
                                                      :class="lot.quantity < 0 ? 'text-tv-red' : 'text-tv-green'"
                                                      x-text="closing.closing_price ? ('$' + formatNumber(closing.quantity_closed * closing.closing_price * (lot.option_type ? 100 : 1)) + (lot.quantity < 0 ? ' db' : ' cr')) : ''"></span>
                                                <!-- Realized P&L shown at leg level only -->
                                                <span class="w-24 ml-4"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Action View -->
                    <template x-if="groupViewMode(group) === 'actions'">
                        <div>
                            <template x-for="(order, index) in (group.orders || []).filter(o => o != null)" :key="`${group.group_id}_order_${index}`">
                                <div class="mx-2 my-3 p-3 bg-tv-panel rounded border border-tv-border">
                                    <!-- Order Header -->
                                    <div class="flex items-center text-base">
                                        <span class="w-8 text-tv-muted" x-text="(group.orders || []).length - index"></span>
                                        <span class="w-32 text-tv-muted" x-text="formatOrderDate(order.order_date)"></span>
                                        <span class="w-28 text-amber-400"
                                              x-text="order.display_type || order.order_type"></span>
                                        <!-- Credit/Debit badges -->
                                        <span x-show="order.order_type === 'ROLLING' && formatRollCreditDebit(order)"
                                              class="text-base px-3 py-1 rounded-sm"
                                              :class="calculateRollCreditDebit(order)?.type === 'credit' ? 'bg-tv-green/20 text-tv-green' : 'bg-tv-red/20 text-tv-red'"
                                              x-text="formatRollCreditDebit(order)"></span>
                                        <span x-show="order.order_type === 'OPENING' && formatOpeningCreditDebit(order)"
                                              class="text-base px-3 py-1 rounded-sm"
                                              :class="calculateOpeningCreditDebit(order)?.type === 'credit' ? 'bg-tv-green/20 text-tv-green' : 'bg-tv-red/20 text-tv-red'"
                                              x-text="formatOpeningCreditDebit(order)"></span>
                                        <span x-show="order.order_type === 'CLOSING' && formatClosingCreditDebit(order)"
                                              class="text-base px-3 py-1 rounded-sm"
                                              :class="calculateClosingCreditDebit(order)?.type === 'credit' ? 'bg-tv-green/20 text-tv-green' : 'bg-tv-red/20 text-tv-red'"
                                              x-text="formatClosingCreditDebit(order)"></span>
                                        <!-- Order ID -->
                                        <span class="ml-4 text-sm font-mono text-tv-muted"
                                              x-show="order.order_id && !order.order_id.startsWith('SYSTEM_')">
                                            Order# <span class="text-tv-text" x-text="order.order_id"></span>
                                        </span>
                                        <span class="ml-4 text-sm font-mono text-amber-400"
                                              x-show="order.order_id && order.order_id.startsWith('SYSTEM_Expiration')">
                                            EXPIRATION
                                        </span>
                                        <!-- P&L -->
                                        <span class="ml-auto font-medium"
                                              :class="order.total_pnl >= 0 ? 'text-tv-green' : 'text-tv-red'">
                                            $<span x-text="formatNumber(order.total_pnl)"></span>
                                        </span>
                                    </div>

                                    <!-- Positions table -->
                                    <div x-show="order.positions && order.positions.length > 0" class="pt-3 space-y-1 font-mono">
                                        <!-- Header row -->
                                        <div class="flex items-center text-xs text-tv-muted pb-1 border-b border-tv-border/30">
                                            <span class="w-10 text-right">Qty</span>
                                            <span class="w-16 text-center mx-2">Exp</span>
                                            <span class="w-10">DTE</span>
                                            <span class="w-16 text-center mx-2">Strike</span>
                                            <span class="w-6">Type</span>
                                            <span class="w-12 ml-4">Action</span>
                                            <span class="w-20 text-right ml-auto">Price</span>
                                            <span class="w-24 text-right">Realized</span>
                                        </div>
                                        <template x-for="position in (order.positions || []).sort((a, b) => new Date(a.expiration || 0) - new Date(b.expiration || 0) || (a.strike || 0) - (b.strike || 0))" :key="`pos_${position.position_id || Math.random()}`">
                                            <div>
                                                <div class="flex items-center text-sm">
                                                    <span class="w-10 text-right font-medium"
                                                          :class="getDisplayQuantity(position) > 0 ? 'text-tv-green' : 'text-tv-red'"
                                                          x-text="getDisplayQuantity(position)"></span>
                                                    <span class="w-16 text-center bg-tv-bg mx-2 py-0.5 rounded text-tv-text"
                                                          x-text="formatExpirationShort(position.expiration)"></span>
                                                    <span class="w-10 text-tv-muted"
                                                          x-text="calculateDTE(position.expiration) + 'd'"></span>
                                                    <span class="w-16 text-center bg-tv-bg mx-2 py-0.5 rounded text-tv-text"
                                                          x-text="position.strike"></span>
                                                    <span class="w-6 text-tv-muted"
                                                          x-text="(position.option_type || '').toUpperCase().startsWith('C') ? 'C' : 'P'"></span>
                                                    <span class="w-12 ml-4"
                                                          :class="order.order_id?.startsWith('SYSTEM_Expiration') ? 'text-amber-400' : position.opening_action?.includes('BUY') ? 'text-tv-green' : 'text-tv-red'"
                                                          x-text="order.order_id?.startsWith('SYSTEM_Expiration') ? 'EXPIRED' : formatAction(position.opening_action)"></span>
                                                    <span class="w-20 text-right text-tv-muted ml-auto"
                                                          x-text="'$' + formatNumber(position.opening_price)"></span>
                                                    <span class="w-24 text-right"
                                                          :class="position.pnl >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                                          x-text="'$' + formatNumber(position.pnl)"></span>
                                                    <span x-show="position.closing_action?.includes('EXPIRED')" class="text-amber-400 ml-2">EXP</span>
                                                    <span x-show="position.closing_action?.includes('ASSIGNED')" class="text-orange-400 ml-2">ASN</span>
                                                </div>
                                                <!-- Derived positions -->
                                                <template x-if="position.derived_positions && position.derived_positions.length > 0">
                                                    <template x-for="derived in position.derived_positions" :key="`derived_${derived.lot_id}`">
                                                        <div class="flex items-center text-sm ml-6 mt-1">
                                                            <span class="text-tv-muted mr-2">&#8627;</span>
                                                            <span class="w-10 text-right font-medium"
                                                                  :class="derived.quantity > 0 ? 'text-tv-green' : 'text-tv-red'"
                                                                  x-text="derived.quantity"></span>
                                                            <span class="w-20 text-center text-tv-text mx-2"
                                                                  x-text="derived.symbol"></span>
                                                            <span class="w-20 text-orange-400"
                                                                  x-text="derived.derivation_type"></span>
                                                            <span class="w-20 text-right text-tv-muted ml-auto"
                                                                  x-text="'$' + formatNumber(derived.entry_price)"></span>
                                                            <span class="w-24 text-right text-tv-muted"
                                                                  x-text="derived.status"></span>
                                                        </div>
                                                    </template>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- No orders message -->
                            <div x-show="!group.orders || group.orders.length === 0"
                                 class="text-center py-4 text-tv-muted text-sm">
                                No orders found for this group
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>
        </div>
    </div>

    <!-- Floating Action Bar (Move Mode) -->
    <div x-show="selectedLots.length > 0" x-cloak
         class="fixed bottom-0 left-0 right-0 bg-tv-panel border-t border-tv-border px-6 py-4 flex items-center justify-between z-50 shadow-lg">
        <span class="text-tv-text text-base">
            <span class="font-medium" x-text="selectedLots.length"></span> lot(s) selected
            <span class="text-tv-muted ml-2">— click a target group below</span>
        </span>
        <div class="flex items-center gap-3">
            <button @click="moveLots('__new__')"
                    class="bg-tv-blue text-white px-5 py-2 text-base hover:bg-tv-blue/80 transition-colors">
                + New Group
            </button>
            <button @click="cancelMoveMode()"
                    class="text-tv-muted hover:text-tv-text px-4 py-2 text-base border border-tv-border">
                Cancel
            </button>
        </div>
    </div>

</body>
</html>
