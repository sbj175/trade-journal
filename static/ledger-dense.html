<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptionLedger - Ledger</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232962ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='22 12 18 12 15 21 9 3 6 12 2 12'></polyline></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tv: {
                            bg: '#131722',
                            panel: '#1e222d',
                            border: '#2a2e39',
                            text: '#d1d4dc',
                            muted: '#787b86',
                            green: '#26a69a',
                            red: '#ef5350',
                            blue: '#2962ff',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif; }
        body { background: #131722; color: #d1d4dc; font-size: 16px; }
        .tv-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .tv-scrollbar::-webkit-scrollbar-track { background: #1e222d; }
        .tv-scrollbar::-webkit-scrollbar-thumb { background: #2a2e39; border-radius: 3px; }
        .tv-scrollbar::-webkit-scrollbar-thumb:hover { background: #363a45; }
        [x-cloak] { display: none !important; }
        .spinner {
            border: 2px solid #2a2e39;
            border-top: 2px solid #2962ff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen tv-scrollbar" x-data="ledgerApp()" x-init="init()">

    {% include 'partials/nav.html' %}

    <!-- Action Bar -->
    <div class="bg-tv-panel border-b border-tv-border px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <!-- View Toggle -->
            <div class="flex items-center border border-tv-border rounded overflow-hidden">
                <button @click="viewMode = 'positions'"
                        :class="viewMode === 'positions' ? 'bg-tv-blue text-white' : 'bg-tv-bg text-tv-muted hover:text-tv-text'"
                        class="px-4 py-2 text-base transition-colors">
                    <i class="fas fa-layer-group mr-1"></i> Positions
                </button>
                <button @click="viewMode = 'actions'"
                        :class="viewMode === 'actions' ? 'bg-tv-blue text-white' : 'bg-tv-bg text-tv-muted hover:text-tv-text'"
                        class="px-4 py-2 text-base transition-colors">
                    <i class="fas fa-list-ol mr-1"></i> Actions
                </button>
            </div>

            <!-- Edit Mode -->
            <button @click="toggleEditMode()"
                    :class="editMode ? 'bg-tv-blue text-white border-tv-blue' : 'bg-tv-bg text-tv-muted border-tv-border hover:text-tv-text'"
                    class="px-4 py-2 text-base border transition-colors">
                <i class="fas fa-edit mr-1"></i>
                <span x-text="editMode ? 'Done Editing' : 'Edit Groups'"></span>
            </button>
        </div>

        <!-- Filters -->
        <div class="flex items-center gap-6 text-base">
            <!-- Symbol Filter -->
            <div class="relative">
                <input type="text"
                       x-model="filterUnderlying"
                       @focus="$event.target.select()"
                       @keyup.enter="applyFilters(); localStorage.setItem('trade_journal_selected_underlying', filterUnderlying || '')"
                       @blur="applyFilters(); localStorage.setItem('trade_journal_selected_underlying', filterUnderlying || '')"
                       @input="filterUnderlying = filterUnderlying.toUpperCase()"
                       placeholder="Symbol"
                       class="bg-tv-bg border border-tv-border text-tv-text text-base px-3 py-2 w-28 uppercase placeholder:normal-case placeholder:text-tv-muted"
                       :class="filterUnderlying ? 'pr-8' : ''">
                <button x-show="filterUnderlying"
                        @click="filterUnderlying = ''; applyFilters(); localStorage.setItem('trade_journal_selected_underlying', '')"
                        class="absolute right-2 top-1/2 -translate-y-1/2 text-tv-muted hover:text-tv-text">
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>

            <!-- Time Filter -->
            <div class="flex items-center gap-2">
                <span class="text-tv-muted">Time:</span>
                <select x-model="timePeriod" @change="applyFilters(); saveState()"
                        class="bg-tv-bg border border-tv-border text-tv-text text-base px-3 py-2">
                    <option value="7">7D</option>
                    <option value="30">30D</option>
                    <option value="60">60D</option>
                    <option value="90">90D</option>
                    <option value="all">All</option>
                </select>
            </div>

            <!-- Status Filter -->
            <div class="flex items-center gap-2">
                <label class="flex items-center gap-2 text-tv-muted">
                    <input type="checkbox" x-model="showOpen" @change="applyFilters(); saveState()" class="w-4 h-4">
                    <span class="text-tv-green text-sm">Open</span>
                </label>
                <label class="flex items-center gap-2 text-tv-muted">
                    <input type="checkbox" x-model="showClosed" @change="applyFilters(); saveState()" class="w-4 h-4">
                    <span class="text-tv-muted text-sm">Closed</span>
                </label>
            </div>

            <!-- Sort direction indicator -->
            <div class="flex items-center gap-1 text-tv-muted text-sm">
                <i class="fas fa-sort"></i>
                <span x-text="sortColumn === 'opening_date' ? 'Date' : sortColumn === 'underlying' ? 'Symbol' : sortColumn === 'strategy_label' ? 'Strategy' : sortColumn === 'status' ? 'Status' : sortColumn === 'lot_count' ? 'Lots' : sortColumn === 'closing_date' ? 'Closed' : 'P&L'"></span>
                <span x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="bg-tv-panel/50 border-b border-tv-border px-4 py-2 flex items-center gap-8 text-base">
        <span class="text-tv-muted">
            Groups: <span class="text-tv-text" x-text="filteredGroups.length"></span>
        </span>
        <span class="text-tv-muted">
            Open: <span class="text-tv-green" x-text="stats.openCount"></span>
        </span>
        <span class="text-tv-muted">
            Closed: <span class="text-tv-text" x-text="stats.closedCount"></span>
        </span>
        <span class="text-tv-muted">
            Realized P&L:
            <span :class="stats.totalPnl >= 0 ? 'text-tv-green' : 'text-tv-red'"
                  x-text="'$' + formatNumber(stats.totalPnl)"></span>
        </span>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="flex items-center justify-center py-20">
        <div class="spinner mr-3"></div>
        <span class="text-tv-muted text-lg">Loading ledger data...</span>
    </div>

    <!-- Empty State -->
    <div x-show="!loading && filteredGroups.length === 0" class="text-center py-20">
        <i class="fas fa-book-open text-4xl text-tv-muted mb-4"></i>
        <p class="text-tv-muted text-lg">No position groups found.</p>
        <p class="text-tv-muted mt-2">Sync your data from the <a href="/chains" class="text-tv-blue hover:underline">Chains</a> page first.</p>
    </div>

    <!-- Group List -->
    <div x-show="!loading && filteredGroups.length > 0" class="py-2">
        <!-- Column Headers -->
        <div class="flex items-center px-8 py-2 text-sm text-tv-muted border-b border-tv-border bg-tv-panel/50 sticky top-0 z-10">
            <span class="w-6"></span>
            <span class="w-8 mr-3"></span>
            <span class="w-20 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortGroups('underlying')">
                Symbol
                <span x-show="sortColumn === 'underlying'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-40 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortGroups('strategy_label')">
                Strategy
                <span x-show="sortColumn === 'strategy_label'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-20 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortGroups('status')">
                Status
                <span x-show="sortColumn === 'status'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-24 text-center cursor-pointer hover:text-tv-text flex items-center justify-center gap-1" @click="sortGroups('lot_count')">
                Lots
                <span x-show="sortColumn === 'lot_count'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-28 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortGroups('opening_date')">
                Opened
                <span x-show="sortColumn === 'opening_date'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-28 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortGroups('closing_date')">
                Closed
                <span x-show="sortColumn === 'closing_date'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="ml-auto cursor-pointer hover:text-tv-text flex items-center justify-end gap-1" @click="sortGroups('total_pnl')">
                Realized P&L
                <span x-show="sortColumn === 'total_pnl'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
        </div>

        <div class="px-4 pt-2">
        <template x-for="group in filteredGroups" :key="group.group_id">
            <div class="mb-2">
                <!-- Group Header Row -->
                <div @click="group.expanded = !group.expanded"
                     class="flex items-center px-4 py-3 bg-tv-panel hover:bg-tv-border/50 cursor-pointer border border-tv-border rounded-sm transition-colors"
                     :class="group.expanded ? 'border-b-0 rounded-b-none' : ''">
                    <!-- Expand icon -->
                    <i class="fas fa-chevron-right w-6 text-tv-muted transition-transform duration-200"
                       :class="group.expanded ? 'rotate-90' : ''"></i>

                    <!-- Account badge -->
                    <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold mr-3"
                          :class="getAccountBadgeClass(group.account_number)"
                          x-text="getAccountSymbol(group.account_number)"></span>

                    <!-- Underlying -->
                    <span class="w-20 text-lg font-semibold text-tv-text" x-text="group.underlying"></span>

                    <!-- Strategy Label -->
                    <template x-if="!editMode || !group.expanded">
                        <span class="w-40 text-tv-muted text-base truncate" x-text="group.strategy_label || '—'"></span>
                    </template>
                    <template x-if="editMode && group.expanded">
                        <input type="text"
                               :value="group.strategy_label || ''"
                               @click.stop
                               @keyup.enter="updateGroupStrategy(group, $event.target.value); $event.target.blur()"
                               @blur="updateGroupStrategy(group, $event.target.value)"
                               class="w-40 bg-tv-bg border border-tv-border text-tv-text text-base px-2 py-1 rounded"
                               placeholder="Strategy label">
                    </template>

                    <!-- Status -->
                    <span class="w-20 text-sm px-2 py-0.5 rounded text-center"
                          :class="group.status === 'OPEN' ? 'bg-tv-green/20 text-tv-green' : 'bg-tv-muted/20 text-tv-muted'"
                          x-text="group.status"></span>

                    <!-- Lot count -->
                    <span class="w-24 text-tv-muted text-base text-center">
                        <span x-text="group.open_lot_count"></span>/<span x-text="group.lot_count"></span> lots
                    </span>

                    <!-- Opening date -->
                    <span class="w-28 text-tv-muted text-base" x-text="formatDate(group.opening_date)"></span>

                    <!-- Closing date -->
                    <span class="w-28 text-tv-muted text-base" x-text="group.closing_date ? formatDate(group.closing_date) : '—'"></span>

                    <!-- P&L (pushed right) -->
                    <span class="ml-auto text-base font-medium"
                          :class="group.realized_pnl >= 0 ? 'text-tv-green' : 'text-tv-red'">
                        $<span x-text="formatNumber(group.realized_pnl)"></span>
                    </span>
                </div>

                <!-- Expanded Detail -->
                <div x-show="group.expanded" x-cloak
                     class="bg-tv-bg border border-tv-border border-t-0 rounded-b-sm px-2 py-2">

                    <!-- Position View -->
                    <template x-if="viewMode === 'positions'">
                        <div>
                            <!-- Lots Table Header -->
                            <div class="flex items-center text-xs text-tv-muted px-4 py-2 border-b border-tv-border/30 font-mono">
                                <span class="w-5"></span>
                                <span x-show="editMode" class="w-8"></span>
                                <span class="w-32">Entry Date</span>
                                <span class="w-10 text-right">Qty</span>
                                <span class="w-16 text-center mx-2">Exp</span>
                                <span class="w-10">DTE</span>
                                <span class="w-16 text-center mx-2">Strike</span>
                                <span class="w-10">Type</span>
                                <span class="w-20 text-center ml-3">Status</span>
                                <span class="w-20 text-right">Entry $</span>
                                <span class="w-24 text-right">Cost Basis</span>
                                <span class="w-24 text-right ml-4">Realized</span>
                                <span class="w-24 text-right">Total P&L</span>
                            </div>

                            <!-- Lot Rows -->
                            <template x-for="(lot, lotIdx) in sortedLots(group)" :key="lot.lot_id">
                                <div>
                                    <!-- Separator between open and closed -->
                                    <template x-if="lotIdx > 0 && lot.status === 'CLOSED' && sortedLots(group)[lotIdx - 1].status !== 'CLOSED'">
                                        <div class="border-t border-tv-muted/40 my-3 mx-4"></div>
                                    </template>
                                    <div @click="toggleLotExpand(lot)"
                                         class="flex items-center text-sm px-4 py-1.5 hover:bg-tv-panel/50 font-mono cursor-pointer"
                                         :class="[lot.derivation_type ? 'ml-6' : '', lot._expanded ? 'bg-tv-panel/30' : '']">
                                        <!-- Expand chevron -->
                                        <i class="fas fa-chevron-right w-5 text-tv-muted text-xs transition-transform duration-200"
                                           :class="lot._expanded ? 'rotate-90' : ''"></i>

                                        <!-- Checkbox (edit mode) -->
                                        <template x-if="editMode">
                                            <span class="w-8">
                                                <input type="checkbox"
                                                       :checked="selectedLots.includes(lot.transaction_id)"
                                                       @click.stop="toggleLotSelection(lot.transaction_id)"
                                                       class="w-4 h-4">
                                            </span>
                                        </template>

                                        <!-- Derivation indicator -->
                                        <template x-if="lot.derivation_type">
                                            <span class="text-tv-muted mr-1">&#8627;</span>
                                        </template>

                                        <!-- Entry Date -->
                                        <span class="w-32 text-tv-muted" x-text="formatOrderDate(lot.entry_date)"></span>

                                        <!-- Qty -->
                                        <span class="w-10 text-right font-medium"
                                              :class="lot.quantity > 0 ? 'text-tv-green' : 'text-tv-red'"
                                              x-text="lot.quantity"></span>

                                        <!-- Expiration -->
                                        <span class="w-16 text-center bg-tv-panel mx-2 py-0.5 rounded text-tv-text"
                                              x-text="lot.expiration ? formatExpirationShort(lot.expiration) : (lot.instrument_type === 'EQUITY' ? 'Shares' : '—')"></span>

                                        <!-- DTE -->
                                        <span class="w-10 text-tv-muted"
                                              :class="lot.expiration && calculateDTE(lot.expiration) <= 21 ? 'text-amber-400 font-bold' : ''"
                                              x-text="lot.expiration ? calculateDTE(lot.expiration) + 'd' : '—'"></span>

                                        <!-- Strike -->
                                        <span class="w-16 text-center bg-tv-panel mx-2 py-0.5 rounded text-tv-text"
                                              x-text="lot.strike || '—'"></span>

                                        <!-- Option Type -->
                                        <span class="w-10 text-tv-muted"
                                              x-text="lot.option_type ? (lot.option_type.toUpperCase().startsWith('C') ? 'Call' : 'Put') : (lot.instrument_type === 'EQUITY' ? 'Stk' : '—')"></span>

                                        <!-- Status -->
                                        <span class="w-20 text-center text-sm px-1 py-0.5 rounded border ml-3"
                                              :class="lot.status === 'OPEN' ? 'bg-tv-green/20 text-tv-green border-tv-green/50' : lot.status === 'PARTIAL' ? 'bg-amber-500/20 text-amber-400 border-amber-500/50' : 'bg-tv-muted/20 text-tv-muted border-tv-red/50'"
                                              x-text="lot.status"></span>

                                        <!-- Entry Price -->
                                        <span class="w-20 text-right text-tv-muted"
                                              x-text="'$' + formatNumber(lot.entry_price)"></span>

                                        <!-- Cost Basis -->
                                        <span class="w-24 text-right text-tv-muted"
                                              x-text="'$' + formatNumber(lot.cost_basis)"></span>

                                        <!-- Realized P&L -->
                                        <span class="w-24 text-right ml-4"
                                              :class="lot.realized_pnl > 0 ? 'text-tv-green' : lot.realized_pnl < 0 ? 'text-tv-red' : 'text-tv-muted'"
                                              x-text="'$' + formatNumber(lot.realized_pnl)"></span>

                                        <!-- Total P&L -->
                                        <span class="w-24 text-right"
                                              :class="lot.total_pnl > 0 ? 'text-tv-green' : lot.total_pnl < 0 ? 'text-tv-red' : 'text-tv-muted'"
                                              x-text="'$' + formatNumber(lot.total_pnl)"></span>
                                    </div>

                                    <!-- Expanded Events (opening + closings) -->
                                    <div x-show="lot._expanded" x-cloak>
                                        <!-- Opening Event -->
                                        <div class="flex items-center text-xs px-4 py-1 ml-8 text-tv-muted font-mono border-l-2 border-tv-border/30">
                                            <span class="w-5"></span>
                                            <span x-show="editMode" class="w-8"></span>
                                            <span class="w-32" x-text="formatOrderDate(lot.entry_date)"></span>
                                            <span class="w-10 text-right"
                                                  :class="lot.quantity > 0 ? 'text-tv-green' : 'text-tv-red'"
                                                  x-text="(lot.quantity > 0 ? '+' : '') + lot.quantity"></span>
                                            <span class="w-16 text-center mx-2"></span>
                                            <span class="w-10"></span>
                                            <span class="w-16 text-center mx-2"></span>
                                            <span class="w-10"></span>
                                            <!-- Action in Status column -->
                                            <span class="w-20 text-center text-xs px-1 py-0.5 rounded border ml-3"
                                                  :class="lot.quantity > 0 ? 'bg-tv-green/20 text-tv-green border-tv-green/50' : 'bg-tv-red/20 text-tv-red border-tv-red/50'"
                                                  x-text="lot.quantity > 0 ? 'BTO' : 'STO'"></span>
                                            <span class="w-20 text-right" x-text="'$' + formatNumber(lot.entry_price)"></span>
                                            <span class="w-24 text-right" x-text="'$' + formatNumber(lot.cost_basis)"></span>
                                            <span class="w-24 ml-4"></span>
                                            <span class="w-24"></span>
                                        </div>

                                        <!-- Closing Events (sub-rows) -->
                                        <template x-for="closing in (lot.closings || [])" :key="closing.closing_id">
                                            <div class="flex items-center text-xs px-4 py-1 ml-8 text-tv-muted font-mono border-l-2 border-tv-border/30">
                                                <span class="w-5"></span>
                                                <span x-show="editMode" class="w-8"></span>
                                                <span class="w-32" x-text="formatOrderDate(closing.closing_date)"></span>
                                                <span class="w-10 text-right"
                                                      :class="lot.quantity < 0 ? 'text-tv-green' : 'text-tv-red'"
                                                      x-text="(lot.quantity < 0 ? '+' : '-') + closing.quantity_closed"></span>
                                                <span class="w-16 text-center mx-2"></span>
                                                <span class="w-10"></span>
                                                <span class="w-16 text-center mx-2"></span>
                                                <span class="w-10"></span>
                                                <!-- Closing type badge in Status column -->
                                                <span class="w-20 text-center text-xs px-1 py-0.5 rounded border ml-3"
                                                      :class="{
                                                          'bg-tv-blue/20 text-tv-blue border-tv-blue/50': closing.closing_type === 'MANUAL',
                                                          'bg-amber-500/20 text-amber-400 border-amber-500/50': closing.closing_type === 'EXPIRATION',
                                                          'bg-orange-500/20 text-orange-400 border-orange-500/50': closing.closing_type === 'ASSIGNMENT',
                                                          'bg-purple-500/20 text-purple-400 border-purple-500/50': closing.closing_type === 'EXERCISE'
                                                      }"
                                                      x-text="closing.closing_type === 'MANUAL' ? (lot.quantity < 0 ? 'BTC' : 'STC') : closing.closing_type"></span>
                                                <span class="w-20 text-right" x-text="'$' + formatNumber(closing.closing_price)"></span>
                                                <span class="w-24"></span>
                                                <!-- Closing realized P&L -->
                                                <span class="w-24 text-right ml-4"
                                                      :class="closing.realized_pnl > 0 ? 'text-tv-green' : closing.realized_pnl < 0 ? 'text-tv-red' : 'text-tv-muted'"
                                                      x-text="'$' + formatNumber(closing.realized_pnl)"></span>
                                                <span class="w-24"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- Action View -->
                    <template x-if="viewMode === 'actions'">
                        <div>
                            <template x-for="(order, index) in (group.orders || []).filter(o => o != null)" :key="`${group.group_id}_order_${index}`">
                                <div class="mx-2 my-3 p-3 bg-tv-panel rounded border border-tv-border">
                                    <!-- Order Header -->
                                    <div class="flex items-center text-base">
                                        <span class="w-8 text-tv-muted" x-text="(group.orders || []).length - index"></span>
                                        <span class="w-32 text-tv-muted" x-text="formatOrderDate(order.order_date)"></span>
                                        <span class="w-28 text-amber-400"
                                              x-text="order.display_type || order.order_type"></span>
                                        <!-- Credit/Debit badges -->
                                        <span x-show="order.order_type === 'ROLLING' && formatRollCreditDebit(order)"
                                              class="text-base px-3 py-1 rounded-sm"
                                              :class="calculateRollCreditDebit(order)?.type === 'credit' ? 'bg-tv-green/20 text-tv-green' : 'bg-tv-red/20 text-tv-red'"
                                              x-text="formatRollCreditDebit(order)"></span>
                                        <span x-show="order.order_type === 'OPENING' && formatOpeningCreditDebit(order)"
                                              class="text-base px-3 py-1 rounded-sm"
                                              :class="calculateOpeningCreditDebit(order)?.type === 'credit' ? 'bg-tv-green/20 text-tv-green' : 'bg-tv-red/20 text-tv-red'"
                                              x-text="formatOpeningCreditDebit(order)"></span>
                                        <span x-show="order.order_type === 'CLOSING' && formatClosingCreditDebit(order)"
                                              class="text-base px-3 py-1 rounded-sm"
                                              :class="calculateClosingCreditDebit(order)?.type === 'credit' ? 'bg-tv-green/20 text-tv-green' : 'bg-tv-red/20 text-tv-red'"
                                              x-text="formatClosingCreditDebit(order)"></span>
                                        <!-- P&L -->
                                        <span class="ml-auto font-medium"
                                              :class="order.total_pnl >= 0 ? 'text-tv-green' : 'text-tv-red'">
                                            $<span x-text="formatNumber(order.total_pnl)"></span>
                                        </span>
                                    </div>

                                    <!-- Positions table -->
                                    <div x-show="order.positions && order.positions.length > 0" class="pt-3 space-y-1 font-mono">
                                        <!-- Header row -->
                                        <div class="flex items-center text-xs text-tv-muted pb-1 border-b border-tv-border/30">
                                            <span class="w-10 text-right">Qty</span>
                                            <span class="w-16 text-center mx-2">Exp</span>
                                            <span class="w-10">DTE</span>
                                            <span class="w-16 text-center mx-2">Strike</span>
                                            <span class="w-6">Type</span>
                                            <span class="w-12 ml-4">Action</span>
                                            <span class="w-20 text-right ml-auto">Price</span>
                                            <span class="w-24 text-right">Realized</span>
                                        </div>
                                        <template x-for="position in (order.positions || []).sort((a, b) => new Date(a.expiration || 0) - new Date(b.expiration || 0) || (a.strike || 0) - (b.strike || 0))" :key="`pos_${position.position_id || Math.random()}`">
                                            <div>
                                                <div class="flex items-center text-sm">
                                                    <span class="w-10 text-right font-medium"
                                                          :class="getDisplayQuantity(position) > 0 ? 'text-tv-green' : 'text-tv-red'"
                                                          x-text="getDisplayQuantity(position)"></span>
                                                    <span class="w-16 text-center bg-tv-bg mx-2 py-0.5 rounded text-tv-text"
                                                          x-text="formatExpirationShort(position.expiration)"></span>
                                                    <span class="w-10 text-tv-muted"
                                                          x-text="calculateDTE(position.expiration) + 'd'"></span>
                                                    <span class="w-16 text-center bg-tv-bg mx-2 py-0.5 rounded text-tv-text"
                                                          x-text="position.strike"></span>
                                                    <span class="w-6 text-tv-muted"
                                                          x-text="(position.option_type || '').toUpperCase().startsWith('C') ? 'C' : 'P'"></span>
                                                    <span class="w-12 ml-4"
                                                          :class="position.opening_action?.includes('BUY') ? 'text-tv-green' : 'text-tv-red'"
                                                          x-text="formatAction(position.opening_action)"></span>
                                                    <span class="w-20 text-right text-tv-muted ml-auto"
                                                          x-text="'$' + formatNumber(position.opening_price)"></span>
                                                    <span class="w-24 text-right"
                                                          :class="position.pnl >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                                          x-text="'$' + formatNumber(position.pnl)"></span>
                                                    <span x-show="position.closing_action?.includes('EXPIRED')" class="text-amber-400 ml-2">EXP</span>
                                                    <span x-show="position.closing_action?.includes('ASSIGNED')" class="text-orange-400 ml-2">ASN</span>
                                                </div>
                                                <!-- Derived positions -->
                                                <template x-if="position.derived_positions && position.derived_positions.length > 0">
                                                    <template x-for="derived in position.derived_positions" :key="`derived_${derived.lot_id}`">
                                                        <div class="flex items-center text-sm ml-6 mt-1">
                                                            <span class="text-tv-muted mr-2">&#8627;</span>
                                                            <span class="w-10 text-right font-medium"
                                                                  :class="derived.quantity > 0 ? 'text-tv-green' : 'text-tv-red'"
                                                                  x-text="derived.quantity"></span>
                                                            <span class="w-20 text-center text-tv-text mx-2"
                                                                  x-text="derived.symbol"></span>
                                                            <span class="w-20 text-orange-400"
                                                                  x-text="derived.derivation_type"></span>
                                                            <span class="w-20 text-right text-tv-muted ml-auto"
                                                                  x-text="'$' + formatNumber(derived.entry_price)"></span>
                                                            <span class="w-24 text-right text-tv-muted"
                                                                  x-text="derived.status"></span>
                                                        </div>
                                                    </template>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>

                            <!-- No orders message -->
                            <div x-show="!group.orders || group.orders.length === 0"
                                 class="text-center py-4 text-tv-muted text-sm">
                                No orders found for this group
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>
        </div>
    </div>

    <!-- Floating Action Bar (Edit Mode) -->
    <div x-show="editMode && selectedLots.length > 0" x-cloak
         class="fixed bottom-0 left-0 right-0 bg-tv-panel border-t border-tv-border px-6 py-4 flex items-center justify-between z-50 shadow-lg">
        <span class="text-tv-text text-base">
            <span class="font-medium" x-text="selectedLots.length"></span> lot(s) selected
        </span>
        <div class="flex items-center gap-4">
            <span class="text-tv-muted">Move to:</span>
            <select x-model="moveTargetGroupId"
                    class="bg-tv-bg border border-tv-border text-tv-text text-base px-3 py-2">
                <option value="">Select group...</option>
                <template x-for="g in getMoveTargetGroups()" :key="g.group_id">
                    <option :value="g.group_id" x-text="g.underlying + ' — ' + (g.strategy_label || 'Unnamed')"></option>
                </template>
                <option value="__new__">+ New Group</option>
            </select>
            <button @click="moveLots()"
                    :disabled="!moveTargetGroupId"
                    class="bg-tv-blue text-white px-6 py-2 text-base disabled:opacity-50 hover:bg-tv-blue/80 transition-colors">
                Move
            </button>
            <button @click="selectedLots = []"
                    class="text-tv-muted hover:text-tv-text px-4 py-2 text-base">
                Cancel
            </button>
        </div>
    </div>

    <script>
    function ledgerApp() {
        return {
            // State
            groups: [],
            accounts: [],
            filteredGroups: [],
            selectedAccount: '',
            filterUnderlying: '',
            timePeriod: 'all',
            showOpen: true,
            showClosed: true,
            viewMode: 'positions',
            sortColumn: 'opening_date',
            sortDirection: 'desc',
            loading: true,
            editMode: false,
            selectedLots: [],
            moveTargetGroupId: '',
            stats: { totalPnl: 0, openCount: 0, closedCount: 0 },

            async init() {
                await this.loadAccounts();

                // Restore state from localStorage
                const saved = localStorage.getItem('ledger_state');
                if (saved) {
                    try {
                        const state = JSON.parse(saved);
                        this.timePeriod = state.timePeriod || 'all';
                        this.showOpen = state.showOpen !== undefined ? state.showOpen : true;
                        this.showClosed = state.showClosed !== undefined ? state.showClosed : true;
                        this.sortColumn = state.sortColumn || 'opening_date';
                        this.sortDirection = state.sortDirection || 'desc';
                        this.viewMode = state.viewMode || 'positions';
                    } catch (e) {}
                }

                // Sync account selection from other pages
                const savedAccount = localStorage.getItem('selectedAccount');
                if (savedAccount) {
                    this.selectedAccount = savedAccount;
                }

                // Sync symbol filter from other pages
                const savedUnderlying = localStorage.getItem('trade_journal_selected_underlying');
                if (savedUnderlying) {
                    this.filterUnderlying = savedUnderlying;
                }

                await this.fetchLedger();
            },

            async loadAccounts() {
                try {
                    const response = await fetch('/api/accounts');
                    const data = await response.json();
                    this.accounts = data.accounts || [];
                    this.accounts.sort((a, b) => {
                        const getOrder = (name) => {
                            const n = (name || '').toUpperCase();
                            if (n.includes('ROTH')) return 1;
                            if (n.includes('INDIVIDUAL')) return 2;
                            if (n.includes('TRADITIONAL')) return 3;
                            return 4;
                        };
                        return getOrder(a.account_name) - getOrder(b.account_name);
                    });
                } catch (error) {
                    console.error('Error loading accounts:', error);
                }
            },

            async fetchLedger() {
                this.loading = true;
                try {
                    const params = new URLSearchParams();
                    if (this.selectedAccount) params.set('account_number', this.selectedAccount);
                    // Server-side underlying filter is exact match; we'll do client-side for partial
                    const url = '/api/ledger' + (params.toString() ? '?' + params.toString() : '');
                    const response = await fetch(url);
                    const data = await response.json();

                    // Add expanded state
                    this.groups = data.map(g => ({ ...g, expanded: false }));
                    this.applyFilters();
                } catch (error) {
                    console.error('Error fetching ledger:', error);
                } finally {
                    this.loading = false;
                }
            },

            sortGroups(column) {
                if (this.sortColumn === column) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortColumn = column;
                    if (column === 'opening_date' || column === 'closing_date' || column === 'total_pnl') {
                        this.sortDirection = 'desc';
                    } else {
                        this.sortDirection = 'asc';
                    }
                }
                this.applyFilters();
                this.saveState();
            },

            applyFilters() {
                let filtered = [...this.groups];

                // Underlying filter (client-side, supports partial match)
                if (this.filterUnderlying) {
                    const sym = this.filterUnderlying.toUpperCase();
                    filtered = filtered.filter(g => (g.underlying || '').toUpperCase().includes(sym));
                }

                // Status filter
                if (!this.showOpen) filtered = filtered.filter(g => g.status !== 'OPEN');
                if (!this.showClosed) filtered = filtered.filter(g => g.status !== 'CLOSED');

                // Time period filter
                if (this.timePeriod !== 'all') {
                    const days = parseInt(this.timePeriod);
                    if (!isNaN(days)) {
                        const cutoff = new Date();
                        cutoff.setDate(cutoff.getDate() - days);
                        filtered = filtered.filter(g => {
                            const d = g.opening_date ? new Date(g.opening_date) : null;
                            return d && d >= cutoff;
                        });
                    }
                }

                // Sort
                filtered.sort((a, b) => {
                    let va, vb;
                    const col = this.sortColumn;
                    if (col === 'opening_date' || col === 'closing_date') {
                        va = a[col] || '';
                        vb = b[col] || '';
                    } else if (col === 'underlying') {
                        va = a.underlying || '';
                        vb = b.underlying || '';
                    } else if (col === 'strategy_label') {
                        va = a.strategy_label || '';
                        vb = b.strategy_label || '';
                    } else if (col === 'status') {
                        va = a.status || '';
                        vb = b.status || '';
                    } else if (col === 'lot_count') {
                        va = a.lot_count || 0;
                        vb = b.lot_count || 0;
                    } else if (col === 'total_pnl') {
                        va = a.realized_pnl || 0;
                        vb = b.realized_pnl || 0;
                    } else {
                        va = a[col] || '';
                        vb = b[col] || '';
                    }

                    let cmp = 0;
                    if (typeof va === 'number' && typeof vb === 'number') {
                        cmp = va - vb;
                    } else {
                        cmp = String(va).localeCompare(String(vb));
                    }
                    return this.sortDirection === 'desc' ? -cmp : cmp;
                });

                this.filteredGroups = filtered;
                this.computeStats();
            },

            computeStats() {
                let totalPnl = 0, openCount = 0, closedCount = 0;
                for (const g of this.filteredGroups) {
                    totalPnl += g.realized_pnl || 0;
                    if (g.status === 'OPEN') openCount++;
                    else closedCount++;
                }
                this.stats = { totalPnl, openCount, closedCount };
            },

            onAccountChange() {
                localStorage.setItem('selectedAccount', this.selectedAccount);
                this.fetchLedger();
            },

            saveState() {
                localStorage.setItem('ledger_state', JSON.stringify({
                    timePeriod: this.timePeriod,
                    showOpen: this.showOpen,
                    showClosed: this.showClosed,
                    sortColumn: this.sortColumn,
                    sortDirection: this.sortDirection,
                    viewMode: this.viewMode,
                }));
            },

            toggleEditMode() {
                this.editMode = !this.editMode;
                if (!this.editMode) {
                    this.selectedLots = [];
                    this.moveTargetGroupId = '';
                }
            },

            sortedLots(group) {
                return (group.lots || []).slice().sort((a, b) => {
                    // Open lots first, then closed
                    const aOpen = a.status !== 'CLOSED' ? 0 : 1;
                    const bOpen = b.status !== 'CLOSED' ? 0 : 1;
                    if (aOpen !== bOpen) return aOpen - bOpen;
                    // Within same status: expiration desc, then strike desc
                    const aExp = a.expiration || '';
                    const bExp = b.expiration || '';
                    if (aExp !== bExp) return bExp.localeCompare(aExp);
                    return (b.strike || 0) - (a.strike || 0);
                });
            },

            toggleLotSelection(transactionId) {
                const idx = this.selectedLots.indexOf(transactionId);
                if (idx >= 0) {
                    this.selectedLots.splice(idx, 1);
                } else {
                    this.selectedLots.push(transactionId);
                }
            },

            toggleLotExpand(lot) {
                lot._expanded = !lot._expanded;
            },

            getMoveTargetGroups() {
                // Find the underlying + account of selected lots
                if (this.selectedLots.length === 0) return [];

                let targetUnderlying = null;
                let targetAccount = null;
                for (const g of this.groups) {
                    for (const lot of (g.lots || [])) {
                        if (this.selectedLots.includes(lot.transaction_id)) {
                            targetUnderlying = g.underlying;
                            targetAccount = g.account_number;
                            break;
                        }
                    }
                    if (targetUnderlying) break;
                }

                if (!targetUnderlying) return [];

                // Return groups with same underlying + account, excluding groups that contain selected lots
                const sourceGroupIds = new Set();
                for (const g of this.groups) {
                    for (const lot of (g.lots || [])) {
                        if (this.selectedLots.includes(lot.transaction_id)) {
                            sourceGroupIds.add(g.group_id);
                            break;
                        }
                    }
                }

                return this.groups.filter(g =>
                    g.underlying === targetUnderlying &&
                    g.account_number === targetAccount &&
                    !sourceGroupIds.has(g.group_id)
                );
            },

            async moveLots() {
                if (!this.moveTargetGroupId || this.selectedLots.length === 0) return;

                let targetGroupId = this.moveTargetGroupId;

                // Create new group if requested
                if (targetGroupId === '__new__') {
                    // Find the underlying/account from selected lots
                    let underlying = '', accountNumber = '';
                    for (const g of this.groups) {
                        for (const lot of (g.lots || [])) {
                            if (this.selectedLots.includes(lot.transaction_id)) {
                                underlying = g.underlying;
                                accountNumber = g.account_number;
                                break;
                            }
                        }
                        if (underlying) break;
                    }

                    try {
                        const resp = await fetch('/api/ledger/groups', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ account_number: accountNumber, underlying: underlying })
                        });
                        const result = await resp.json();
                        targetGroupId = result.group_id;
                    } catch (error) {
                        console.error('Error creating group:', error);
                        return;
                    }
                }

                try {
                    await fetch('/api/ledger/move-lots', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            transaction_ids: this.selectedLots,
                            target_group_id: targetGroupId
                        })
                    });
                    this.selectedLots = [];
                    this.moveTargetGroupId = '';
                    this.editMode = false;
                    await this.fetchLedger();
                } catch (error) {
                    console.error('Error moving lots:', error);
                }
            },

            async updateGroupStrategy(group, value) {
                if (value === group.strategy_label) return;
                try {
                    await fetch(`/api/ledger/groups/${group.group_id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ strategy_label: value })
                    });
                    group.strategy_label = value;
                } catch (error) {
                    console.error('Error updating strategy:', error);
                }
            },

            // ========== Format Helpers ==========

            formatNumber(num) {
                if (num === null || num === undefined) return '0.00';
                return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            },

            formatDate(dateStr) {
                if (!dateStr) return '';
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                }
                return dateStr;
            },

            formatOrderDate(isoString) {
                if (!isoString) return '';
                const d = new Date(isoString);
                const month = d.getMonth() + 1;
                const day = d.getDate();
                let hours = d.getHours();
                const minutes = d.getMinutes().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'p' : 'a';
                hours = hours % 12 || 12;
                return `${month}/${day} ${hours}:${minutes}${ampm}`;
            },

            formatExpirationShort(expiration) {
                if (!expiration) return '';
                const date = new Date(expiration + 'T00:00:00');
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[date.getMonth()]} ${date.getDate()}`;
            },

            calculateDTE(expiration) {
                if (!expiration) return 0;
                const expDate = new Date(expiration + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const diffTime = expDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return Math.max(0, diffDays);
            },

            getAccountSymbol(accountNumber) {
                const account = this.accounts.find(a => a.account_number === accountNumber);
                if (!account) return '?';
                const name = (account.account_name || '').toUpperCase();
                if (name.includes('ROTH')) return 'R';
                if (name.includes('INDIVIDUAL')) return 'I';
                if (name.includes('TRADITIONAL')) return 'T';
                return name.charAt(0) || '?';
            },

            getAccountBadgeClass(accountNumber) {
                const symbol = this.getAccountSymbol(accountNumber);
                if (symbol === 'R') return 'bg-purple-900/60 text-purple-400';
                if (symbol === 'I') return 'bg-blue-900/60 text-blue-400';
                if (symbol === 'T') return 'bg-green-900/60 text-green-400';
                return 'bg-tv-border text-tv-muted';
            },

            formatAction(action) {
                if (!action) return '';
                const cleanAction = action.replace(/^(ORDERACTION\.|OrderAction\.)/, '');
                const actionMap = {
                    'SELL_TO_OPEN': 'STO', 'BUY_TO_CLOSE': 'BTC',
                    'BUY_TO_OPEN': 'BTO', 'SELL_TO_CLOSE': 'STC',
                    'EXPIRED': 'EXPIRED', 'ASSIGNED': 'ASSIGNED',
                    'EXERCISED': 'EXERCISED', 'CASH_SETTLED': 'CASH_SETTLED'
                };
                return actionMap[cleanAction] || cleanAction;
            },

            getDisplayQuantity(position) {
                if (!position || typeof position.quantity === 'undefined') return 0;
                const currentAction = (position.closing_action || position.opening_action || '').toUpperCase();
                const isSellAction = currentAction.includes('SELL') || currentAction.includes('STC') || currentAction.includes('STO');
                return isSellAction ? -Math.abs(position.quantity) : Math.abs(position.quantity);
            },

            // ========== Credit/Debit Helpers (for Action view) ==========

            getCreditDebitDivisor(order) {
                if (!order || !order.positions || order.positions.length === 0) return 0;
                const normalizeAction = (action) => {
                    if (!action) return '';
                    return action.replace('OrderAction.', '').toUpperCase();
                };
                const closingPositions = order.positions.filter(pos =>
                    pos.closing_action && (pos.closing_action === 'BTC' || pos.closing_action === 'STC')
                );
                if (closingPositions.length > 0) {
                    const qty = Math.abs(closingPositions[0].quantity || 0);
                    if (qty > 0) return qty;
                }
                const closingByAction = order.positions.filter(pos => {
                    const n = normalizeAction(pos.opening_action);
                    return (n === 'BTC' || n === 'BUY_TO_CLOSE' || n === 'STC' || n === 'SELL_TO_CLOSE') && pos.status === 'CLOSED';
                });
                if (closingByAction.length > 0) {
                    const qty = Math.abs(closingByAction[0].quantity || 0);
                    if (qty > 0) return qty;
                }
                const openingPositions = order.positions.filter(pos => {
                    const n = normalizeAction(pos.opening_action);
                    return (n === 'BTO' || n === 'BUY_TO_OPEN' || n === 'STO' || n === 'SELL_TO_OPEN') && pos.status !== 'CLOSED';
                });
                if (openingPositions.length > 0) {
                    const qty = Math.abs(openingPositions[0].quantity || 0);
                    if (qty > 0) return qty;
                }
                return Math.abs(order.positions[0].quantity || 0);
            },

            calculateRollCreditDebit(order) {
                if (!order || order.order_type !== 'ROLLING' || !order.positions || order.positions.length === 0) return null;
                const normalizeAction = (action) => action ? action.replace('OrderAction.', '').toUpperCase() : '';
                const openingPositions = order.positions.filter(pos => {
                    const a = normalizeAction(pos.opening_action);
                    return a === 'BTO' || a === 'BUY_TO_OPEN' || a === 'STO' || a === 'SELL_TO_OPEN';
                });
                const divisor = openingPositions.length > 0
                    ? Math.abs(openingPositions[0].quantity || 0)
                    : this.getCreditDebitDivisor(order);
                if (divisor === 0) return null;
                const perRatioAmount = Math.abs(order.total_pnl || 0) / divisor / 100;
                return { amount: perRatioAmount, type: (order.total_pnl || 0) > 0 ? 'credit' : 'debit' };
            },

            formatRollCreditDebit(order) {
                const d = this.calculateRollCreditDebit(order);
                return d ? `${d.amount.toFixed(2)} ${d.type}` : '';
            },

            calculateOpeningCreditDebit(order) {
                if (!order || order.order_type !== 'OPENING' || !order.positions || order.positions.length === 0) return null;
                const divisor = this.getCreditDebitDivisor(order);
                if (divisor === 0) return null;
                const perRatioAmount = Math.abs(order.total_pnl || 0) / divisor / 100;
                return { amount: perRatioAmount, type: (order.total_pnl || 0) > 0 ? 'credit' : 'debit' };
            },

            formatOpeningCreditDebit(order) {
                const d = this.calculateOpeningCreditDebit(order);
                return d ? `${d.amount.toFixed(2)} ${d.type}` : '';
            },

            calculateClosingCreditDebit(order) {
                if (!order || order.order_type !== 'CLOSING' || !order.positions || order.positions.length === 0) return null;
                const divisor = this.getCreditDebitDivisor(order);
                if (divisor === 0) return null;
                const perRatioAmount = Math.abs(order.total_pnl || 0) / divisor / 100;
                return { amount: perRatioAmount, type: (order.total_pnl || 0) > 0 ? 'credit' : 'debit' };
            },

            formatClosingCreditDebit(order) {
                const d = this.calculateClosingCreditDebit(order);
                return d ? `${d.amount.toFixed(2)} ${d.type}` : '';
            },
        };
    }
    </script>
</body>
</html>
