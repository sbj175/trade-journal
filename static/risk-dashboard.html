<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptionLedger - Portfolio Risk X-Ray</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232962ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='22 12 18 12 15 21 9 3 6 12 2 12'></polyline></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/tailwind-config.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif; }
        body { background: #131722; color: #d1d4dc; font-size: 16px; }
        .tv-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .tv-scrollbar::-webkit-scrollbar-track { background: #1e222d; }
        .tv-scrollbar::-webkit-scrollbar-thumb { background: #2a2e39; border-radius: 3px; }
        .tv-scrollbar::-webkit-scrollbar-thumb:hover { background: #363a45; }
        [x-cloak] { display: none !important; }
        .spinner { border: 2px solid #2a2e39; border-top: 2px solid #2962ff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .metric-card { transition: border-color 0.2s ease; }
        .metric-card:hover { border-color: #363a45; }
        .greek-symbol { font-family: 'Times New Roman', Georgia, serif; font-style: italic; font-weight: bold; }
        .apexcharts-tooltip { background: #1e222d !important; border: 1px solid #2a2e39 !important; color: #d1d4dc !important; }
        .apexcharts-tooltip-title { background: #131722 !important; border-bottom: 1px solid #2a2e39 !important; color: #d1d4dc !important; }
        .apexcharts-xaxistooltip, .apexcharts-yaxistooltip { background: #1e222d !important; border: 1px solid #2a2e39 !important; color: #d1d4dc !important; }
        .apexcharts-xaxistooltip:after, .apexcharts-xaxistooltip:before { border-bottom-color: #2a2e39 !important; }
        .pulse-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>

    <!-- Supabase JS SDK (auth) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Shared utilities -->
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/risk-app.js"></script>
</head>
<body class="min-h-screen tv-scrollbar" x-data="riskApp">

    {% include 'partials/nav.html' %}

    <!-- Status Bar -->
    <div class="bg-tv-panel border-b border-tv-border px-4 py-2 flex items-center justify-between text-sm">
        <div class="flex items-center gap-6">
            <span class="text-tv-muted">
                <i class="fas fa-shield-halved mr-1 text-tv-blue"></i>Portfolio Risk X-Ray
            </span>
            <span class="text-tv-muted" x-show="enrichedPositions.length > 0">
                <span class="text-tv-text" x-text="enrichedPositions.length"></span> positions across
                <span class="text-tv-text" x-text="underlyingGroups.length"></span> underlyings
            </span>
        </div>
        <div class="flex items-center gap-4">
            <span class="flex items-center gap-2">
                <span class="pulse-dot" :class="liveQuotesActive ? 'bg-tv-green' : 'bg-tv-red'"></span>
                <span class="text-tv-muted" x-text="liveQuotesActive ? 'Live' : 'Offline'"></span>
            </span>
            <span class="text-tv-muted" x-show="greeksSource">
                Greeks: <span class="text-tv-text" x-text="greeksSource"></span>
            </span>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="isLoading" class="text-center py-24">
        <div class="spinner mx-auto mb-4" style="width: 48px; height: 48px; border-width: 4px;"></div>
        <p class="text-tv-muted text-lg">Calculating portfolio risk...</p>
    </div>

    <!-- Empty State -->
    <div x-show="!isLoading && allPositions.length === 0" x-cloak class="text-center py-24">
        <i class="fas fa-shield-halved text-6xl text-tv-border mb-6"></i>
        <p class="text-tv-muted text-xl mb-2">No open positions found</p>
        <p class="text-tv-muted">Sync your data from the <a href="/positions" class="text-tv-blue hover:underline">Positions</a> page first.</p>
    </div>

    <!-- Main Content -->
    <main x-show="!isLoading && allPositions.length > 0" x-cloak class="p-4">

        <!-- Summary Cards -->
        <div class="grid grid-cols-6 gap-3 mb-4">
            <!-- Net Liquidating Value -->
            <div class="metric-card bg-tv-panel border border-tv-border p-4 border-l-2 border-l-tv-blue">
                <div class="text-tv-muted text-xs uppercase tracking-wider mb-2">Net Liquidating Value</div>
                <div class="text-2xl font-bold text-tv-text">
                    $<span x-text="formatNumber(currentBalance?.net_liquidating_value || 0)"></span>
                </div>
                <div class="text-xs text-tv-muted mt-1">
                    Cash: $<span x-text="formatNumber(currentBalance?.cash_balance || 0)"></span>
                </div>
            </div>

            <!-- Daily Theta -->
            <div class="metric-card bg-tv-panel border border-tv-border p-4 border-l-2"
                 :class="portfolioTotals.netTheta >= 0 ? 'border-l-tv-green' : 'border-l-tv-red'">
                <div class="text-tv-muted text-xs uppercase tracking-wider mb-2">
                    <span class="greek-symbol">&#920;</span> Daily Theta
                </div>
                <div class="text-2xl font-bold" :class="portfolioTotals.netTheta >= 0 ? 'text-tv-green' : 'text-tv-red'">
                    <span x-text="portfolioTotals.netTheta >= 0 ? '+' : ''"></span>$<span x-text="formatNumber(Math.abs(portfolioTotals.netTheta))"></span><span class="text-sm font-normal text-tv-muted">/day</span>
                </div>
                <div class="text-xs mt-1" :class="portfolioTotals.netTheta >= 0 ? 'text-tv-green/70' : 'text-tv-red/70'">
                    $<span x-text="formatNumber(Math.abs(portfolioTotals.netTheta * 30))"></span>/month projected
                </div>
            </div>

            <!-- Net Delta -->
            <div class="metric-card bg-tv-panel border border-tv-border p-4 border-l-2"
                 :class="portfolioTotals.netDelta >= 0 ? 'border-l-tv-green' : 'border-l-tv-red'">
                <div class="text-tv-muted text-xs uppercase tracking-wider mb-2">
                    <span class="greek-symbol">&#916;</span> Net Delta
                </div>
                <div class="text-2xl font-bold" :class="portfolioTotals.netDelta >= 0 ? 'text-tv-green' : 'text-tv-red'">
                    <span x-text="formatDelta(portfolioTotals.netDelta)"></span>
                </div>
                <div class="text-xs text-tv-muted mt-1">
                    $<span x-text="formatNumber(Math.abs(portfolioTotals.deltaDollars))"></span> delta-adjusted
                </div>
            </div>

            <!-- Net Gamma -->
            <div class="metric-card bg-tv-panel border border-tv-border p-4 border-l-2 border-l-amber-500">
                <div class="text-tv-muted text-xs uppercase tracking-wider mb-2">
                    <span class="greek-symbol">&#915;</span> Net Gamma
                </div>
                <div class="text-2xl font-bold" :class="portfolioTotals.netGamma >= 0 ? 'text-amber-400' : 'text-amber-500'">
                    <span x-text="formatDelta(portfolioTotals.netGamma)"></span>
                </div>
                <div class="text-xs text-tv-muted mt-1">
                    Delta change per $1 move
                </div>
            </div>

            <!-- Net Vega -->
            <div class="metric-card bg-tv-panel border border-tv-border p-4 border-l-2 border-l-purple-500">
                <div class="text-tv-muted text-xs uppercase tracking-wider mb-2">
                    <span class="greek-symbol">&#957;</span> Net Vega
                </div>
                <div class="text-2xl font-bold" :class="portfolioTotals.netVega >= 0 ? 'text-purple-400' : 'text-purple-500'">
                    <span x-text="portfolioTotals.netVega >= 0 ? '+' : ''"></span>$<span x-text="formatNumber(Math.abs(portfolioTotals.netVega))"></span>
                </div>
                <div class="text-xs text-tv-muted mt-1">
                    P&L per 1% IV change
                </div>
            </div>

            <!-- Buying Power Utilization -->
            <div class="metric-card bg-tv-panel border border-tv-border p-4 border-l-2"
                 :class="bpUtilization < 50 ? 'border-l-tv-green' : bpUtilization < 75 ? 'border-l-amber-500' : 'border-l-tv-red'">
                <div class="text-tv-muted text-xs uppercase tracking-wider mb-2">BP Utilization</div>
                <div class="text-2xl font-bold"
                     :class="bpUtilization < 50 ? 'text-tv-green' : bpUtilization < 75 ? 'text-amber-400' : 'text-tv-red'">
                    <span x-text="bpUtilization.toFixed(1)"></span>%
                </div>
                <div class="text-xs text-tv-muted mt-1">
                    $<span x-text="formatNumber(Math.abs((currentBalance?.net_liquidating_value || 0) - (currentBalance?.derivative_buying_power || 0)))"></span>
                    / $<span x-text="formatNumber(currentBalance?.net_liquidating_value || 0)"></span>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="grid grid-cols-2 gap-3 mb-3">
            <!-- Delta Exposure -->
            <div class="bg-tv-panel border border-tv-border p-4">
                <div class="text-sm text-tv-muted uppercase tracking-wider mb-3">
                    <i class="fas fa-arrows-left-right mr-1 text-tv-blue"></i>Delta Exposure by Underlying
                    <span class="text-xs font-normal ml-2">(delta dollars)</span>
                </div>
                <div id="chart-delta" style="min-height: 280px;"></div>
            </div>

            <!-- Theta Income Projection -->
            <div class="bg-tv-panel border border-tv-border p-4">
                <div class="text-sm text-tv-muted uppercase tracking-wider mb-3">
                    <i class="fas fa-chart-area mr-1 text-tv-green"></i>Theta Income Projection
                    <span class="text-xs font-normal ml-2">(cumulative over 45 days)</span>
                </div>
                <div id="chart-theta" style="min-height: 280px;"></div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="grid grid-cols-2 gap-3 mb-3">
            <!-- Portfolio Concentration Treemap -->
            <div class="bg-tv-panel border border-tv-border p-4">
                <div class="text-sm text-tv-muted uppercase tracking-wider mb-3">
                    <i class="fas fa-th-large mr-1 text-cyan-400"></i>Portfolio Concentration
                    <span class="text-xs font-normal ml-2">(sized by max risk, colored by P&L)</span>
                </div>
                <div id="chart-treemap" style="min-height: 280px;"></div>
            </div>

            <!-- Market Scenario Analysis -->
            <div class="bg-tv-panel border border-tv-border p-4">
                <div class="text-sm text-tv-muted uppercase tracking-wider mb-3">
                    <i class="fas fa-flask mr-1 text-amber-400"></i>Market Scenario Analysis
                    <span class="text-xs font-normal ml-2">(P&L at correlated market moves)</span>
                </div>
                <div id="chart-scenario" style="min-height: 280px;"></div>
            </div>
        </div>

        <!-- Risk Detail Table -->
        <div class="bg-tv-panel border border-tv-border">
            <div class="px-4 py-3 border-b border-tv-border flex items-center justify-between">
                <span class="text-sm text-tv-muted uppercase tracking-wider">
                    <i class="fas fa-table mr-1 text-tv-blue"></i>Per-Underlying Risk Breakdown
                </span>
                <span class="text-xs text-tv-muted">
                    Click column headers to sort
                </span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-tv-muted text-xs uppercase tracking-wider border-b border-tv-border">
                            <th class="text-left px-4 py-3 cursor-pointer hover:text-tv-text" @click="toggleSort('underlying')">
                                Underlying <span x-show="sortColumn==='underlying'" x-text="sortDirection==='asc'?'&#9650;':'&#9660;'"></span>
                            </th>
                            <th class="text-right px-3 py-3 cursor-pointer hover:text-tv-text" @click="toggleSort('positionCount')">
                                Pos <span x-show="sortColumn==='positionCount'" x-text="sortDirection==='asc'?'&#9650;':'&#9660;'"></span>
                            </th>
                            <th class="text-right px-3 py-3 cursor-pointer hover:text-tv-text" @click="toggleSort('underlyingPrice')">
                                Price <span x-show="sortColumn==='underlyingPrice'" x-text="sortDirection==='asc'?'&#9650;':'&#9660;'"></span>
                            </th>
                            <th class="text-right px-3 py-3 cursor-pointer hover:text-tv-text" @click="toggleSort('netDelta')">
                                Delta <span x-show="sortColumn==='netDelta'" x-text="sortDirection==='asc'?'&#9650;':'&#9660;'"></span>
                            </th>
                            <th class="text-right px-3 py-3 cursor-pointer hover:text-tv-text" @click="toggleSort('deltaDollars')">
                                Delta $ <span x-show="sortColumn==='deltaDollars'" x-text="sortDirection==='asc'?'&#9650;':'&#9660;'"></span>
                            </th>
                            <th class="text-right px-3 py-3 cursor-pointer hover:text-tv-text" @click="toggleSort('netGamma')">
                                Gamma <span x-show="sortColumn==='netGamma'" x-text="sortDirection==='asc'?'&#9650;':'&#9660;'"></span>
                            </th>
                            <th class="text-right px-3 py-3 cursor-pointer hover:text-tv-text" @click="toggleSort('netTheta')">
                                Theta <span x-show="sortColumn==='netTheta'" x-text="sortDirection==='asc'?'&#9650;':'&#9660;'"></span>
                            </th>
                            <th class="text-right px-3 py-3 cursor-pointer hover:text-tv-text" @click="toggleSort('netVega')">
                                Vega <span x-show="sortColumn==='netVega'" x-text="sortDirection==='asc'?'&#9650;':'&#9660;'"></span>
                            </th>
                            <th class="text-right px-3 py-3 cursor-pointer hover:text-tv-text" @click="toggleSort('maxRisk')">
                                Max Risk <span x-show="sortColumn==='maxRisk'" x-text="sortDirection==='asc'?'&#9650;':'&#9660;'"></span>
                            </th>
                            <th class="text-right px-3 py-3 cursor-pointer hover:text-tv-text" @click="toggleSort('unrealizedPnl')">
                                Unreal P&L <span x-show="sortColumn==='unrealizedPnl'" x-text="sortDirection==='asc'?'&#9650;':'&#9660;'"></span>
                            </th>
                            <th class="text-right px-3 py-3">% Port</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="group in sortedGroups" :key="group.underlying">
                            <tr class="border-b border-tv-border/50 hover:bg-tv-border/20 transition-colors">
                                <td class="px-4 py-3 font-semibold text-tv-text" x-text="group.underlying"></td>
                                <td class="text-right px-3 py-3 text-tv-muted" x-text="group.positionCount"></td>
                                <td class="text-right px-3 py-3 text-tv-text" x-text="'$' + formatNumber(group.underlyingPrice)"></td>
                                <td class="text-right px-3 py-3 font-mono"
                                    :class="group.netDelta >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                    x-text="formatDelta(group.netDelta)"></td>
                                <td class="text-right px-3 py-3 font-mono"
                                    :class="group.deltaDollars >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                    x-text="(group.deltaDollars >= 0 ? '+$' : '-$') + formatNumber(Math.abs(group.deltaDollars))"></td>
                                <td class="text-right px-3 py-3 font-mono text-amber-400"
                                    x-text="formatDelta(group.netGamma)"></td>
                                <td class="text-right px-3 py-3 font-mono"
                                    :class="group.netTheta >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                    x-text="(group.netTheta >= 0 ? '+$' : '-$') + formatNumber(Math.abs(group.netTheta))"></td>
                                <td class="text-right px-3 py-3 font-mono text-purple-400"
                                    x-text="(group.netVega >= 0 ? '+$' : '-$') + formatNumber(Math.abs(group.netVega))"></td>
                                <td class="text-right px-3 py-3 text-tv-text"
                                    x-text="'$' + formatNumber(group.maxRisk)"></td>
                                <td class="text-right px-3 py-3 font-mono"
                                    :class="group.unrealizedPnl >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                    x-text="(group.unrealizedPnl >= 0 ? '+$' : '-$') + formatNumber(Math.abs(group.unrealizedPnl))"></td>
                                <td class="text-right px-3 py-3 text-tv-muted"
                                    x-text="portfolioTotals.totalMaxRisk > 0 ? (group.maxRisk / portfolioTotals.totalMaxRisk * 100).toFixed(1) + '%' : '-'"></td>
                            </tr>
                        </template>
                        <!-- Totals Row -->
                        <tr class="border-t-2 border-tv-border bg-tv-bg/50 font-semibold">
                            <td class="px-4 py-3 text-tv-text">PORTFOLIO</td>
                            <td class="text-right px-3 py-3 text-tv-text" x-text="portfolioTotals.positionCount"></td>
                            <td class="text-right px-3 py-3"></td>
                            <td class="text-right px-3 py-3 font-mono"
                                :class="portfolioTotals.netDelta >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                x-text="formatDelta(portfolioTotals.netDelta)"></td>
                            <td class="text-right px-3 py-3 font-mono"
                                :class="portfolioTotals.deltaDollars >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                x-text="(portfolioTotals.deltaDollars >= 0 ? '+$' : '-$') + formatNumber(Math.abs(portfolioTotals.deltaDollars))"></td>
                            <td class="text-right px-3 py-3 font-mono text-amber-400"
                                x-text="formatDelta(portfolioTotals.netGamma)"></td>
                            <td class="text-right px-3 py-3 font-mono"
                                :class="portfolioTotals.netTheta >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                x-text="(portfolioTotals.netTheta >= 0 ? '+$' : '-$') + formatNumber(Math.abs(portfolioTotals.netTheta))"></td>
                            <td class="text-right px-3 py-3 font-mono text-purple-400"
                                x-text="(portfolioTotals.netVega >= 0 ? '+$' : '-$') + formatNumber(Math.abs(portfolioTotals.netVega))"></td>
                            <td class="text-right px-3 py-3 text-tv-text"
                                x-text="'$' + formatNumber(portfolioTotals.totalMaxRisk)"></td>
                            <td class="text-right px-3 py-3 font-mono"
                                :class="portfolioTotals.totalPnl >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                x-text="(portfolioTotals.totalPnl >= 0 ? '+$' : '-$') + formatNumber(Math.abs(portfolioTotals.totalPnl))"></td>
                            <td class="text-right px-3 py-3 text-tv-text">100%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer Note -->
        <div class="text-center text-xs text-tv-muted mt-4 pb-4">
            Greeks calculated via Black-Scholes model using underlying IV. Values are estimates and update with live quotes.
            Risk-free rate: 4.5%. Options multiplier: 100.
        </div>
    </main>


</body>
</html>
