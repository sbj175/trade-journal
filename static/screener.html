<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Screener - Trade Journal</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Shared CSS -->
    <link rel="stylesheet" href="/static/css/shared.css">

    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        function screenerApp() {
            return {
                // State
                tickers: '',
                candidates: [],
                isLoading: false,
                error: null,
                presets: {},
                selectedPreset: '',

                // Advanced settings
                showAdvanced: false,
                nearDteMin: 30,
                nearDteMax: 45,
                leapsDteMin: 300,
                leapsDeltaMin: 0.60,
                leapsDeltaMax: 0.85,
                minIvSpread: 5.0,
                minNearIv: 30.0,
                minVolume: 1,
                minOpenInterest: 0,

                // Results state
                totalScreened: 0,
                totalCandidates: 0,
                lastRun: null,

                // Sorting
                sortField: 'iv_spread',
                sortDirection: 'desc',

                // Term structure visualization
                selectedTickerForChart: null,
                termStructureData: null,
                loadingChart: false,
                chart: null,

                // Initialize
                async init() {
                    console.log('Initializing screener...');
                    await this.loadPresets();
                },

                // Load preset ticker lists
                async loadPresets() {
                    try {
                        const response = await fetch('/api/screener/presets');
                        this.presets = await response.json();
                        console.log('Loaded presets:', this.presets);
                    } catch (error) {
                        console.error('Failed to load presets:', error);
                    }
                },

                // Apply a preset
                applyPreset() {
                    if (this.selectedPreset && this.presets[this.selectedPreset]) {
                        this.tickers = this.presets[this.selectedPreset].tickers.join(', ');
                    }
                },

                // Run the screener
                async runScreener() {
                    this.isLoading = true;
                    this.error = null;
                    this.candidates = [];

                    try {
                        // Parse tickers
                        const tickerList = this.tickers
                            .split(/[,\s]+/)
                            .map(t => t.trim().toUpperCase())
                            .filter(t => t.length > 0);

                        if (tickerList.length === 0) {
                            this.error = 'Please enter at least one ticker symbol';
                            this.isLoading = false;
                            return;
                        }

                        console.log(`Running screener for ${tickerList.length} tickers...`);

                        const response = await fetch('/api/screener/run', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                tickers: tickerList,
                                near_dte_min: parseInt(this.nearDteMin),
                                near_dte_max: parseInt(this.nearDteMax),
                                leaps_dte_min: parseInt(this.leapsDteMin),
                                leaps_delta_min: parseFloat(this.leapsDeltaMin),
                                leaps_delta_max: parseFloat(this.leapsDeltaMax),
                                min_iv_spread: parseFloat(this.minIvSpread),
                                min_near_iv: parseFloat(this.minNearIv),
                                min_volume: parseInt(this.minVolume),
                                min_open_interest: parseInt(this.minOpenInterest)
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        this.candidates = data.candidates || [];
                        this.totalScreened = data.total_screened || 0;
                        this.totalCandidates = data.total_candidates || 0;
                        this.lastRun = new Date().toLocaleString();

                        console.log(`Found ${this.totalCandidates} candidates`);

                    } catch (error) {
                        console.error('Screener error:', error);
                        this.error = error.message || 'An error occurred while running the screener';
                    } finally {
                        this.isLoading = false;
                    }
                },

                // Sorting
                get sortedCandidates() {
                    if (!this.candidates || this.candidates.length === 0) {
                        return [];
                    }

                    const sorted = [...this.candidates];
                    sorted.sort((a, b) => {
                        const aVal = a[this.sortField];
                        const bVal = b[this.sortField];

                        if (this.sortDirection === 'asc') {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    });

                    return sorted;
                },

                sortBy(field) {
                    if (this.sortField === field) {
                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortField = field;
                        this.sortDirection = 'desc';
                    }
                },

                // Formatting helpers
                formatNumber(num, decimals = 2) {
                    if (num === null || num === undefined) return 'N/A';
                    return Number(num).toFixed(decimals);
                },

                formatPercent(num, decimals = 1) {
                    if (num === null || num === undefined) return 'N/A';
                    return Number(num).toFixed(decimals) + '%';
                },

                formatPrice(price) {
                    if (price === null || price === undefined) return 'N/A';
                    return '$' + Number(price).toFixed(2);
                },

                getScoreColor(score) {
                    if (score >= 20) return 'text-green-400';
                    if (score >= 15) return 'text-yellow-400';
                    return 'text-gray-400';
                },

                getIvSpreadColor(spread) {
                    if (spread >= 20) return 'bg-green-900 text-green-300';
                    if (spread >= 15) return 'bg-yellow-900 text-yellow-300';
                    if (spread >= 10) return 'bg-blue-900 text-blue-300';
                    return 'bg-gray-800 text-gray-300';
                },

                exportToCsv() {
                    if (this.candidates.length === 0) return;

                    const headers = ['Ticker', 'Price', 'IV Rank', 'Near IV', 'Near DTE', 'LEAPS IV', 'LEAPS DTE', 'LEAPS Delta', 'IV Spread', 'Term Structure', 'Near Vol', 'Near OI', 'LEAPS Vol', 'LEAPS OI'];
                    const rows = this.candidates.map(c => [
                        c.ticker,
                        c.price,
                        c.iv_rank || '',
                        c.near_iv,
                        c.near_dte,
                        c.leaps_iv,
                        c.leaps_dte,
                        c.leaps_delta,
                        c.iv_spread,
                        c.term_structure,
                        c.near_volume,
                        c.near_oi,
                        c.leaps_volume,
                        c.leaps_oi
                    ]);

                    const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `pmcc_screener_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                },

                // Term structure visualization
                async showTermStructure(ticker) {
                    this.loadingChart = true;
                    this.selectedTickerForChart = ticker;

                    try {
                        const url = `/api/screener/term-structure/${ticker}`;
                        console.log('Fetching term structure from:', url);
                        const response = await fetch(url);
                        console.log('Response status:', response.status);
                        const data = await response.json();
                        console.log('Response data:', data);

                        if (response.ok && data.success) {
                            this.termStructureData = data.data;
                            console.log('Term structure data loaded:', this.termStructureData);

                            // Use a longer delay and multiple nextTick to ensure DOM is ready
                            this.$nextTick(() => {
                                this.$nextTick(() => {
                                    setTimeout(() => {
                                        console.log('Attempting to render chart...');
                                        this.renderChart();
                                    }, 100);
                                });
                            });
                        } else if (!response.ok) {
                            console.error('HTTP error:', response.status, data);
                            alert(`Error: ${data.detail || 'Failed to load term structure'}`);
                        } else {
                            console.error('Failed to load term structure:', data);
                            alert(`Error: ${data.detail || 'Failed to load term structure'}`);
                        }
                    } catch (error) {
                        console.error('Error fetching term structure:', error);
                        alert(`Error: ${error.message}`);
                    } finally {
                        this.loadingChart = false;
                    }
                },

                closeTermStructure() {
                    this.selectedTickerForChart = null;
                    this.termStructureData = null;
                    if (this.chart) {
                        this.chart.destroy();
                        this.chart = null;
                    }
                },

                renderChart() {
                    if (!this.termStructureData || !this.termStructureData.term_structure) {
                        console.warn('renderChart: No term structure data available');
                        return;
                    }

                    const canvas = document.getElementById('termStructureChart');
                    if (!canvas) {
                        console.error('renderChart: Canvas element not found in DOM');
                        return;
                    }

                    console.log('renderChart: Canvas found, dimensions:', canvas.width, 'x', canvas.height);
                    const ctx = canvas.getContext('2d');

                    // Destroy existing chart
                    if (this.chart) {
                        this.chart.destroy();
                    }

                    const termStructure = this.termStructureData.term_structure;
                    console.log('renderChart: Rendering chart with', termStructure.length, 'data points');

                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: termStructure.map(p => `${p.dte} DTE`),
                            datasets: [{
                                label: 'Implied Volatility (%)',
                                data: termStructure.map(p => p.iv),
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.3,
                                fill: true,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: `${this.selectedTickerForChart} - IV Term Structure`,
                                    color: '#fff',
                                    font: { size: 16 }
                                },
                                legend: {
                                    labels: { color: '#fff' }
                                },
                                tooltip: {
                                    callbacks: {
                                        afterLabel: (context) => {
                                            const point = termStructure[context.dataIndex];
                                            return [
                                                `Strike: $${point.strike.toFixed(2)}`,
                                                `Delta: ${point.delta.toFixed(2)}`,
                                                `Volume: ${point.volume}`,
                                                `OI: ${point.open_interest}`,
                                                `Exp: ${point.expiration}`
                                            ];
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { color: '#9ca3af' },
                                    grid: { color: 'rgba(75, 85, 99, 0.3)' }
                                },
                                y: {
                                    ticks: { color: '#9ca3af' },
                                    grid: { color: 'rgba(75, 85, 99, 0.3)' },
                                    title: {
                                        display: true,
                                        text: 'IV (%)',
                                        color: '#9ca3af'
                                    }
                                }
                            }
                        }
                    });

                    console.log('renderChart: Chart created successfully!');
                }
            }
        }
    </script>

    <style>
        [x-cloak] {
            display: none !important;
        }

        .glass-card {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition;
        }

        .btn-secondary {
            @apply bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded transition;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen" x-data="screenerApp()" x-init="init()">
    <!-- Navigation -->
    <nav class="bg-slate-800 border-b border-slate-700 sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-8">
                    <h1 class="text-xl font-bold text-blue-400">
                        <i class="fas fa-chart-line mr-2"></i>
                        Trade Journal
                    </h1>
                    <div class="hidden sm:flex space-x-4">
                        <a href="/"
                           class="text-slate-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                            <i class="fas fa-layer-group mr-1"></i>
                            Open Positions
                        </a>
                        <a href="/chains"
                           class="text-slate-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">
                            <i class="fas fa-link mr-1"></i>
                            Order Chains
                        </a>
                        <a href="/screener"
                           class="text-blue-400 px-3 py-2 rounded-md text-sm font-semibold">
                            <i class="fas fa-search mr-1"></i>
                            Options Screener
                        </a>
                    </div>
                </div>

                <div class="text-sm text-slate-400" x-show="lastRun">
                    <i class="fas fa-clock mr-1"></i>
                    Last run: <span x-text="lastRun"></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold mb-2">Options Term Structure Screener</h2>
            <p class="text-gray-400">Find PMCC (Poor Man's Covered Call) candidates based on IV term structure</p>
        </div>

        <!-- Input Section -->
        <div class="glass-card rounded-lg p-6 mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Ticker Input -->
                <div>
                    <label class="block text-sm font-medium mb-2">Ticker Symbols</label>
                    <textarea
                        x-model="tickers"
                        rows="4"
                        placeholder="Enter tickers (comma or space separated): NVDA, TSLA, AMD..."
                        class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 focus:outline-none focus:border-blue-500"
                    ></textarea>

                    <!-- Presets -->
                    <div class="mt-3">
                        <label class="block text-sm font-medium mb-2">Or choose a preset:</label>
                        <div class="flex gap-2">
                            <select
                                x-model="selectedPreset"
                                class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 focus:outline-none focus:border-blue-500"
                            >
                                <option value="">Select preset...</option>
                                <template x-for="(preset, key) in presets" :key="key">
                                    <option :value="key" x-text="preset.name"></option>
                                </template>
                            </select>
                            <button @click="applyPreset()" class="btn-secondary">Apply</button>
                        </div>
                    </div>
                </div>

                <!-- Quick Settings -->
                <div>
                    <label class="block text-sm font-medium mb-2">Quick Filters</label>
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400">Min IV Spread (points)</label>
                            <input type="number" x-model="minIvSpread" step="1" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Min Near-Term IV (%)</label>
                            <input type="number" x-model="minNearIv" step="5" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                        </div>

                        <!-- Advanced Settings Toggle -->
                        <button @click="showAdvanced = !showAdvanced" class="text-sm text-blue-400 hover:text-blue-300">
                            <span x-show="!showAdvanced">‚ñ∂ Show advanced settings</span>
                            <span x-show="showAdvanced">‚ñº Hide advanced settings</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Advanced Settings -->
            <div x-show="showAdvanced" x-collapse class="mt-6 pt-6 border-t border-gray-700">
                <h3 class="text-lg font-semibold mb-4">Advanced Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-xs text-gray-400">Near-Term DTE Min</label>
                        <input type="number" x-model="nearDteMin" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Near-Term DTE Max</label>
                        <input type="number" x-model="nearDteMax" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">LEAPS Min DTE</label>
                        <input type="number" x-model="leapsDteMin" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">LEAPS Delta Min</label>
                        <input type="number" x-model="leapsDeltaMin" step="0.05" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">LEAPS Delta Max</label>
                        <input type="number" x-model="leapsDeltaMax" step="0.05" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Min Volume</label>
                        <input type="number" x-model="minVolume" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Min Open Interest</label>
                        <input type="number" x-model="minOpenInterest" class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
                    </div>
                </div>
            </div>

            <!-- Run Button -->
            <div class="mt-6 flex items-center justify-between">
                <button
                    @click="runScreener()"
                    :disabled="isLoading"
                    class="btn-primary px-8 py-3 text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span x-show="!isLoading">üîç Run Screener</span>
                    <span x-show="isLoading">‚è≥ Screening...</span>
                </button>

                <button
                    @click="exportToCsv()"
                    x-show="candidates.length > 0"
                    class="btn-secondary"
                >
                    üì• Export CSV
                </button>
            </div>

            <!-- Error Display -->
            <div x-show="error" class="mt-4 bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded">
                <strong>Error:</strong> <span x-text="error"></span>
            </div>
        </div>

        <!-- Results Section -->
        <div x-show="candidates.length > 0 || isLoading" class="glass-card rounded-lg p-6">
            <!-- Results Header -->
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h3 class="text-xl font-bold">Screening Results</h3>
                    <p class="text-sm text-gray-400">
                        Found <span x-text="totalCandidates" class="text-green-400 font-semibold"></span> candidates
                        out of <span x-text="totalScreened"></span> tickers screened
                    </p>
                </div>
            </div>

            <!-- Results Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-700 text-left">
                            <th @click="sortBy('ticker')" class="px-4 py-3 cursor-pointer hover:bg-gray-800">
                                Ticker <span x-show="sortField === 'ticker'" x-text="sortDirection === 'asc' ? '‚Üë' : '‚Üì'"></span>
                            </th>
                            <th @click="sortBy('price')" class="px-4 py-3 cursor-pointer hover:bg-gray-800">
                                Price <span x-show="sortField === 'price'" x-text="sortDirection === 'asc' ? '‚Üë' : '‚Üì'"></span>
                            </th>
                            <th @click="sortBy('iv_rank')" class="px-4 py-3 cursor-pointer hover:bg-gray-800">
                                IV Rank <span x-show="sortField === 'iv_rank'" x-text="sortDirection === 'asc' ? '‚Üë' : '‚Üì'"></span>
                            </th>
                            <th @click="sortBy('near_iv')" class="px-4 py-3 cursor-pointer hover:bg-gray-800">
                                Near IV <span x-show="sortField === 'near_iv'" x-text="sortDirection === 'asc' ? '‚Üë' : '‚Üì'"></span>
                            </th>
                            <th @click="sortBy('leaps_iv')" class="px-4 py-3 cursor-pointer hover:bg-gray-800">
                                LEAPS IV <span x-show="sortField === 'leaps_iv'" x-text="sortDirection === 'asc' ? '‚Üë' : '‚Üì'"></span>
                            </th>
                            <th @click="sortBy('iv_spread')" class="px-4 py-3 cursor-pointer hover:bg-gray-800">
                                Spread <span x-show="sortField === 'iv_spread'" x-text="sortDirection === 'asc' ? '‚Üë' : '‚Üì'"></span>
                            </th>
                            <th class="px-4 py-3">Details</th>
                            <th class="px-4 py-3">Chart</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(candidate, index) in sortedCandidates" :key="index">
                            <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                                <td class="px-4 py-3 font-bold text-blue-400" x-text="candidate.ticker"></td>
                                <td class="px-4 py-3" x-text="formatPrice(candidate.price)"></td>
                                <td class="px-4 py-3" x-text="candidate.iv_rank ? formatNumber(candidate.iv_rank * 100, 1) : 'N/A'"></td>
                                <td class="px-4 py-3">
                                    <span x-text="formatPercent(candidate.near_iv)"></span>
                                    <span class="text-xs text-gray-500" x-text="' (' + candidate.near_dte + ' DTE)'"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span x-text="formatPercent(candidate.leaps_iv)"></span>
                                    <span class="text-xs text-gray-500" x-text="' (' + candidate.leaps_dte + ' DTE)'"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded font-semibold" :class="getIvSpreadColor(candidate.iv_spread)" x-text="formatNumber(candidate.iv_spread, 1)"></span>
                                </td>
                                <td class="px-4 py-3 text-xs text-gray-400">
                                    <div>LEAPS Œî: <span x-text="formatNumber(candidate.leaps_delta, 2)"></span></div>
                                    <div>Vol: <span x-text="candidate.near_volume"></span> / <span x-text="candidate.leaps_volume"></span></div>
                                    <div>OI: <span x-text="candidate.near_oi"></span> / <span x-text="candidate.leaps_oi"></span></div>
                                </td>
                                <td class="px-4 py-3">
                                    <button @click="showTermStructure(candidate.ticker)" class="btn-secondary text-xs px-3 py-1">
                                        üìä View IV Curve
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div x-show="!isLoading && candidates.length === 0" class="text-center py-12 text-gray-400">
                <p class="text-lg">No candidates found matching your criteria.</p>
                <p class="text-sm mt-2">Try adjusting your filters or screening different tickers.</p>
            </div>
        </div>

        <!-- Term Structure Modal -->
        <div x-show="selectedTickerForChart"
             x-cloak
             class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75"
             @click.self="closeTermStructure()">
            <div class="glass-card rounded-lg p-6 w-full max-w-4xl mx-4" @click.stop>
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-xl font-bold" x-text="selectedTickerForChart + ' - IV Term Structure (IVx)'"></h3>
                        <div x-show="termStructureData && !loadingChart" class="text-sm text-gray-400 mt-1">
                            <template x-if="termStructureData && termStructureData.ivx">
                                <span>IVx: <span class="text-blue-400 font-semibold" x-text="formatPercent(termStructureData.ivx)"></span></span>
                            </template>
                            <template x-if="termStructureData && termStructureData.iv_rank">
                                <span class="ml-4">IV Rank: <span class="text-green-400 font-semibold" x-text="formatNumber(termStructureData.iv_rank * 100, 1)"></span></span>
                            </template>
                            <template x-if="termStructureData && termStructureData.price">
                                <span class="ml-4">Price: <span class="text-white font-semibold" x-text="formatPrice(termStructureData.price)"></span></span>
                            </template>
                        </div>
                    </div>
                    <button @click="closeTermStructure()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>

                <div x-show="loadingChart" class="text-center py-12">
                    <p class="text-gray-400">Loading IVx term structure...</p>
                </div>

                <div x-show="!loadingChart && termStructureData" class="h-96">
                    <canvas id="termStructureChart"></canvas>
                </div>

                <div x-show="!loadingChart && termStructureData" class="mt-4 p-4 bg-blue-900/20 border border-blue-700/30 rounded">
                    <p class="text-sm font-semibold text-blue-300 mb-2">üìä About this chart:</p>
                    <ul class="list-disc list-inside text-sm text-gray-400 space-y-1">
                        <li><strong>IVx Data:</strong> This uses Tastytrade's official IVx (implied volatility index) per expiration - much more reliable than bid-ask estimates</li>
                        <li><strong>Contango</strong> (downward slope) = Near-term IV > Long-term IV ‚Üí Good for PMCCs ‚úÖ</li>
                        <li><strong>Backwardation</strong> (upward slope) = Near-term IV < Long-term IV ‚Üí Not ideal for PMCCs ‚ùå</li>
                        <li><strong>Choose your LEAPS DTE:</strong> Look for a point where IV starts flattening out (typically 150-300 DTE)</li>
                        <li><strong>For 80 delta LEAPS:</strong> Look at strikes around 10-20% ITM for longer expirations</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Info Section -->
        <div class="mt-8 glass-card rounded-lg p-6">
            <h3 class="text-lg font-bold mb-3">How This Screener Works</h3>
            <div class="text-sm text-gray-400 space-y-2">
                <p><strong>Term Structure:</strong> The screener identifies opportunities where near-term options have higher IV than LEAPS, ideal for PMCCs (Poor Man's Covered Calls).</p>
                <p><strong>Near-Term IV:</strong> Measures implied volatility of ATM options expiring in 30-45 days.</p>
                <p><strong>LEAPS IV:</strong> Measures implied volatility of 70-80 delta call options expiring in 365+ days.</p>
                <p><strong>IV Spread:</strong> The difference (Near IV - LEAPS IV). Higher spreads indicate better PMCC opportunities.</p>
                <p><strong>Strategy:</strong> Buy LEAPS calls (long-term, lower IV) and sell near-term calls against them (higher IV) to profit from the term structure.</p>
            </div>

            <div class="mt-4 p-4 bg-yellow-900/30 border border-yellow-700/50 rounded">
                <p class="text-sm text-yellow-300">
                    <strong>‚ö†Ô∏è Important:</strong> This screener requires live market data to fetch implied volatility and Greeks.
                    It works best during market hours (Mon-Fri 9:30 AM - 4:00 PM ET). Outside market hours, IV data may be unavailable or stale.
                </p>
            </div>
        </div>
    </div>
</body>
</html>
