<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptionLedger - Settings</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232962ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='22 12 18 12 15 21 9 3 6 12 2 12'></polyline></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/tailwind-config.js"></script>

    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif; }
        body { background: #131722; color: #d1d4dc; font-size: 16px; }
        .tv-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .tv-scrollbar::-webkit-scrollbar-track { background: #1e222d; }
        .tv-scrollbar::-webkit-scrollbar-thumb { background: #2a2e39; border-radius: 3px; }
        .tv-scrollbar::-webkit-scrollbar-thumb:hover { background: #363a45; }
        [x-cloak] { display: none !important; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { opacity: 1; }
    </style>

    <!-- Supabase JS SDK (auth) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="/static/js/auth.js"></script>
    <script src="/static/js/settings-app.js"></script>
</head>
<body class="min-h-screen tv-scrollbar" x-data="settingsApp">

    {% include 'partials/nav.html' %}

    <!-- Notification -->
    <div x-show="notification" x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="fixed top-20 right-4 z-50 px-4 py-3 rounded shadow-lg text-sm"
         :class="notification?.type === 'success' ? 'bg-tv-green/20 border border-tv-green/30 text-tv-green' : 'bg-tv-red/20 border border-tv-red/30 text-tv-red'">
        <span x-text="notification?.message"></span>
    </div>

    <!-- Main Content -->
    <div class="flex" style="height: calc(100vh - 64px);">

        <!-- Left Sidebar Tabs -->
        <div class="w-56 flex-shrink-0 bg-tv-panel border-r border-tv-border py-4">
            <div class="px-3 mb-4">
                <h1 class="text-lg font-semibold text-tv-text">
                    <i class="fas fa-cog mr-2 text-tv-blue"></i>Settings
                </h1>
            </div>
            <nav class="space-y-0.5 px-2">
                <button @click="activeTab = 'connection'"
                        class="w-full flex items-center gap-3 px-3 py-2.5 rounded text-sm transition-colors text-left"
                        :class="activeTab === 'connection' ? 'bg-tv-blue/15 text-tv-blue border border-tv-blue/30' : 'text-tv-muted hover:text-tv-text hover:bg-tv-bg border border-transparent'">
                    <i class="fas fa-plug w-4 text-center"></i>
                    <span>Connection</span>
                    <span class="ml-auto">
                        <i class="fas fa-circle text-[6px]" :class="connectionStatus?.connected ? 'text-tv-green' : 'text-tv-red'"></i>
                    </span>
                </button>
                <button @click="activeTab = 'import'"
                        class="w-full flex items-center gap-3 px-3 py-2.5 rounded text-sm transition-colors text-left"
                        :class="activeTab === 'import' ? 'bg-tv-blue/15 text-tv-blue border border-tv-blue/30' : 'text-tv-muted hover:text-tv-text hover:bg-tv-bg border border-transparent'">
                    <i class="fas fa-file-import w-4 text-center"></i>
                    <span>Import Trades</span>
                </button>
                <button @click="activeTab = 'privacy'"
                        class="w-full flex items-center gap-3 px-3 py-2.5 rounded text-sm transition-colors text-left"
                        :class="activeTab === 'privacy' ? 'bg-tv-blue/15 text-tv-blue border border-tv-blue/30' : 'text-tv-muted hover:text-tv-text hover:bg-tv-bg border border-transparent'">
                    <i class="fas fa-eye-slash w-4 text-center"></i>
                    <span>Privacy</span>
                </button>
                <button @click="activeTab = 'targets'"
                        class="w-full flex items-center gap-3 px-3 py-2.5 rounded text-sm transition-colors text-left"
                        :class="activeTab === 'targets' ? 'bg-tv-blue/15 text-tv-blue border border-tv-blue/30' : 'text-tv-muted hover:text-tv-text hover:bg-tv-bg border border-transparent'">
                    <i class="fas fa-bullseye w-4 text-center"></i>
                    <span>Strategy Targets</span>
                </button>
                <button @click="activeTab = 'alerts'"
                        class="w-full flex items-center gap-3 px-3 py-2.5 rounded text-sm transition-colors text-left"
                        :class="activeTab === 'alerts' ? 'bg-tv-blue/15 text-tv-blue border border-tv-blue/30' : 'text-tv-muted hover:text-tv-text hover:bg-tv-bg border border-transparent'">
                    <i class="fas fa-bell w-4 text-center"></i>
                    <span>Roll Alerts</span>
                </button>
            </nav>
        </div>

        <!-- Right Content Area -->
        <div class="flex-1 overflow-y-auto tv-scrollbar p-6">
            <!-- Save status indicator -->
            <div class="flex items-center justify-end mb-4 h-5">
                <span class="text-xs text-tv-muted" x-show="saveStatus === 'pending'" x-cloak>
                    <i class="fas fa-circle text-yellow-500 text-[8px] mr-1"></i>Unsaved
                </span>
                <span class="text-xs text-tv-muted" x-show="saveStatus === 'saving'" x-cloak>
                    <i class="fas fa-spinner fa-spin mr-1"></i>Saving...
                </span>
                <span class="text-xs text-tv-green" x-show="saveStatus === 'saved'" x-cloak>
                    <i class="fas fa-check mr-1"></i>Saved
                </span>
            </div>

            <!-- Import Trades Tab -->
            <div x-show="activeTab === 'import'">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-tv-text mb-1">
                        <i class="fas fa-file-import mr-2 text-tv-blue"></i>Import Trades
                    </h2>
                    <p class="text-tv-muted text-sm">Rebuild or reprocess your trade data from Tastytrade</p>
                </div>

                <!-- Onboarding welcome banner -->
                <div x-show="onboarding" class="bg-tv-green/10 border border-tv-green/30 rounded p-4 mb-5">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-check-circle text-tv-green text-lg mt-0.5"></i>
                        <div>
                            <p class="text-tv-text font-medium">Your Tastytrade account is connected!</p>
                            <p class="text-tv-muted text-sm mt-1">Run an Initial Sync below to import your trading history. Choose a start date for how far back you'd like to import.</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <!-- Initial Sync -->
                    <div class="bg-tv-panel border border-tv-border rounded">
                        <div class="p-5">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h3 class="text-tv-text font-medium mb-1">
                                        <i class="fas fa-database mr-2 text-tv-muted"></i>Initial Sync
                                    </h3>
                                    <p class="text-tv-muted text-sm">Clears the existing database and rebuilds it from scratch. Fetches all transactions from the selected start date.</p>
                                </div>
                                <button @click="initialSync()" :disabled="initialSyncing || reprocessing"
                                        class="flex-shrink-0 ml-6 px-5 py-2.5 rounded text-sm disabled:opacity-50 whitespace-nowrap"
                                        :class="onboarding ? 'bg-tv-blue hover:bg-tv-blue/80 text-white' : 'bg-tv-red/20 hover:bg-tv-red/30 text-tv-red border border-tv-red/30'">
                                    <i class="fas fa-database mr-2" :class="{'animate-spin': initialSyncing}"></i>
                                    <span x-text="initialSyncing ? 'Importing...' : (onboarding ? 'Import Trades' : 'Initial Sync')"></span>
                                </button>
                            </div>
                            <!-- Start date picker -->
                            <div class="mt-4 flex items-center gap-3 ml-7">
                                <label class="text-tv-muted text-sm whitespace-nowrap">Import from:</label>
                                <input type="date" x-model="syncStartDate"
                                       :min="syncMinDate" :max="syncMaxDate"
                                       class="bg-tv-bg border border-tv-border text-tv-text px-3 py-1.5 rounded text-sm focus:outline-none focus:border-tv-blue">
                                <span class="text-tv-muted text-xs" x-text="syncDaysBack + ' days of history'"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Reprocess Chains -->
                    <div class="bg-tv-panel border border-tv-border rounded">
                        <div class="p-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-tv-text font-medium mb-1">
                                    <i class="fas fa-link mr-2 text-tv-muted"></i>Reprocess Chains
                                </h3>
                                <p class="text-tv-muted text-sm">Re-analyzes existing transactions to rebuild order chains and strategy detection. Does not fetch new data from Tastytrade. Use this after a software update.</p>
                            </div>
                            <button @click="reprocessChains()" :disabled="initialSyncing || reprocessing"
                                    class="flex-shrink-0 ml-6 bg-tv-blue/20 hover:bg-tv-blue/30 text-tv-blue border border-tv-blue/30 px-5 py-2.5 rounded text-sm disabled:opacity-50 whitespace-nowrap">
                                <i class="fas fa-link mr-2" :class="{'animate-spin': reprocessing}"></i>
                                <span x-text="reprocessing ? 'Processing...' : 'Reprocess Chains'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Progress overlay -->
                <div x-show="initialSyncing || reprocessing" x-cloak
                     class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                    <div class="bg-tv-panel border border-tv-border rounded-lg px-8 py-6 text-center shadow-2xl">
                        <i class="fas fa-spinner animate-spin text-tv-blue text-3xl mb-4"></i>
                        <p class="text-tv-text text-lg font-medium" x-text="initialSyncing ? 'Rebuilding database...' : 'Reprocessing chains...'"></p>
                        <p class="text-tv-muted text-sm mt-2">This may take a few seconds</p>
                    </div>
                </div>
            </div>

            <!-- Privacy Mode Tab -->
            <div x-show="activeTab === 'privacy'" x-cloak>
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-tv-text mb-1">
                        <i class="fas fa-eye-slash mr-2 text-tv-muted"></i>Privacy Mode
                    </h2>
                    <p class="text-tv-muted text-sm">Hide sensitive account balance information on the Positions page</p>
                </div>
                <div class="bg-tv-panel border border-tv-border rounded">
                    <div class="p-5">
                        <div class="flex items-center gap-4">
                            <template x-for="option in [{value: 'off', label: 'Off', icon: 'fa-eye', desc: 'All values visible'}, {value: 'medium', label: 'Medium', icon: 'fa-eye-low-vision', desc: 'Hides Net Liq'}, {value: 'high', label: 'High', icon: 'fa-eye-slash', desc: 'Hides all balances'}]" :key="option.value">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="privacyMode" :value="option.value" x-model="privacyMode" @change="savePrivacyMode()" class="sr-only">
                                    <div class="border rounded p-4 text-center transition-colors"
                                         :class="privacyMode === option.value ? 'border-tv-blue bg-tv-blue/10 text-tv-text' : 'border-tv-border bg-tv-bg text-tv-muted hover:border-tv-muted'">
                                        <i class="fas text-2xl mb-2" :class="option.icon"></i>
                                        <div class="text-sm font-medium" x-text="option.label"></div>
                                        <div class="text-xs mt-1 opacity-70" x-text="option.desc"></div>
                                    </div>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connection Tab -->
            <div x-show="activeTab === 'connection'" x-cloak>
                <div class="mb-6 flex items-start justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-tv-text mb-1">
                            <i class="fas fa-plug mr-2 text-tv-blue"></i>Tastytrade Connection
                        </h2>
                        <p class="text-tv-muted text-sm" x-text="authEnabled ? 'Connect your Tastytrade account with one click' : 'Connect to Tastytrade using OAuth2 credentials'"></p>
                    </div>
                    <div class="flex items-center gap-2" x-show="connectionStatus && !onboarding">
                        <template x-if="connectionStatus?.connected">
                            <span class="bg-tv-green/20 text-tv-green border border-tv-green/30 px-3 py-1 rounded text-xs font-medium">
                                <i class="fas fa-check-circle mr-1"></i>Connected
                            </span>
                        </template>
                        <template x-if="!connectionStatus?.connected && connectionStatus?.configured">
                            <span class="bg-tv-red/20 text-tv-red border border-tv-red/30 px-3 py-1 rounded text-xs font-medium">
                                <i class="fas fa-exclamation-circle mr-1"></i>Connection Failed
                            </span>
                        </template>
                        <template x-if="!connectionStatus?.connected && !connectionStatus?.configured">
                            <span class="bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 px-3 py-1 rounded text-xs font-medium">
                                <i class="fas fa-info-circle mr-1"></i>Not Configured
                            </span>
                        </template>
                    </div>
                </div>

                <!-- ============================================================ -->
                <!-- Auth-enabled mode: OAuth Authorization Code flow              -->
                <!-- ============================================================ -->
                <template x-if="authEnabled">
                    <div>
                        <!-- Onboarding welcome panel -->
                        <div x-show="onboarding && !connectionStatus?.configured" class="bg-tv-panel border border-tv-blue/30 rounded mb-5">
                            <div class="p-6 text-center">
                                <div class="text-4xl mb-4"><i class="fas fa-handshake text-tv-blue"></i></div>
                                <h3 class="text-xl font-semibold text-tv-text mb-2">Welcome! Let's connect your Tastytrade account.</h3>
                                <p class="text-tv-muted text-sm mb-5 max-w-lg mx-auto">
                                    OptionLedger needs read-only access to your Tastytrade account to import your trades and positions.
                                </p>
                                <div class="flex flex-col items-center gap-3 mb-5">
                                    <div class="flex items-center gap-2 text-sm text-tv-muted">
                                        <i class="fas fa-shield-halved text-tv-green w-5 text-center"></i>
                                        <span>Read-only scope &mdash; we cannot place trades or modify your account</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-sm text-tv-muted">
                                        <i class="fas fa-lock text-tv-green w-5 text-center"></i>
                                        <span>Not your password &mdash; you authorize directly on Tastytrade's website</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-sm text-tv-muted">
                                        <i class="fas fa-database text-tv-green w-5 text-center"></i>
                                        <span>Encrypted at rest &mdash; your credentials are encrypted in our database</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-sm text-tv-muted">
                                        <i class="fas fa-rotate-left text-tv-green w-5 text-center"></i>
                                        <span>Revoke anytime &mdash; disconnect here or revoke access on Tastytrade</span>
                                    </div>
                                </div>
                                <button @click="connectTastytrade()" :disabled="connecting"
                                        class="bg-tv-blue hover:bg-tv-blue/80 text-white px-8 py-3 rounded-lg text-base font-medium disabled:opacity-50 transition-colors">
                                    <i class="fas fa-right-to-bracket mr-2" x-show="!connecting"></i>
                                    <i class="fas fa-spinner fa-spin mr-2" x-show="connecting"></i>
                                    <span x-text="connecting ? 'Redirecting...' : 'Connect to Tastytrade'"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Normal connection panel (returning user or post-onboarding) -->
                        <div x-show="!onboarding || connectionStatus?.configured" class="bg-tv-panel border border-tv-border rounded">
                            <div class="p-5 space-y-4">
                                <!-- Connection error message -->
                                <div x-show="connectionStatus?.error" x-cloak class="bg-tv-red/10 border border-tv-red/20 rounded p-3 text-sm text-tv-red">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    <span x-text="connectionStatus?.error"></span>
                                </div>

                                <!-- Connected accounts -->
                                <div x-show="connectionStatus?.connected && connectionStatus?.accounts?.length > 0" x-cloak class="text-sm flex flex-col items-start gap-1.5">
                                    <span class="text-tv-muted">Accounts:</span>
                                    <template x-for="acct in connectionStatus?.accounts || []" :key="acct.account_number">
                                        <div class="inline-flex items-center gap-2 bg-tv-bg border border-tv-border rounded px-3 py-1.5 ml-4">
                                            <span class="text-tv-text font-medium" x-text="acct.account_number"></span>
                                            <span class="text-tv-muted">&mdash;</span>
                                            <span class="text-tv-muted" x-text="acct.account_name"></span>
                                        </div>
                                    </template>
                                </div>

                                <!-- Action buttons -->
                                <div class="flex items-center gap-3">
                                    <button @click="connectTastytrade()" :disabled="connecting"
                                            class="bg-tv-blue hover:bg-tv-blue/80 text-white px-5 py-2 rounded text-sm disabled:opacity-50">
                                        <i class="fas fa-right-to-bracket mr-1" x-show="!connecting"></i>
                                        <i class="fas fa-spinner fa-spin mr-1" x-show="connecting"></i>
                                        <span x-text="connecting ? 'Redirecting...' : (connectionStatus?.configured ? 'Reconnect to Tastytrade' : 'Connect to Tastytrade')"></span>
                                    </button>
                                    <button x-show="connectionStatus?.configured" x-cloak
                                            @click="disconnectTastytrade()" :disabled="deletingCredentials"
                                            class="bg-tv-red/20 hover:bg-tv-red/30 text-tv-red border border-tv-red/30 px-4 py-2 rounded text-sm disabled:opacity-50">
                                        <i class="fas fa-unlink mr-1" x-show="!deletingCredentials"></i>
                                        <i class="fas fa-spinner fa-spin mr-1" x-show="deletingCredentials"></i>
                                        <span x-text="deletingCredentials ? 'Disconnecting...' : 'Disconnect'"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- ============================================================ -->
                <!-- Auth-disabled mode: manual credential form (unchanged)        -->
                <!-- ============================================================ -->
                <template x-if="!authEnabled">
                    <div class="bg-tv-panel border border-tv-border rounded">
                        <div class="p-5 space-y-4">
                            <!-- Connection error message -->
                            <div x-show="connectionStatus?.error" x-cloak class="bg-tv-red/10 border border-tv-red/20 rounded p-3 text-sm text-tv-red">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                <span x-text="connectionStatus?.error"></span>
                            </div>

                            <!-- Connected accounts -->
                            <div x-show="connectionStatus?.connected && connectionStatus?.accounts?.length > 0" x-cloak class="text-sm flex flex-col items-start gap-1.5">
                                <span class="text-tv-muted">Accounts:</span>
                                <template x-for="acct in connectionStatus?.accounts || []" :key="acct.account_number">
                                    <div class="inline-flex items-center gap-2 bg-tv-bg border border-tv-border rounded px-3 py-1.5 ml-4">
                                        <span class="text-tv-text font-medium" x-text="acct.account_number"></span>
                                        <span class="text-tv-muted">&mdash;</span>
                                        <span class="text-tv-muted" x-text="acct.account_name"></span>
                                    </div>
                                </template>
                            </div>

                            <!-- Credential inputs -->
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-tv-muted text-sm mb-1">Client Secret <span class="text-tv-muted/50">(saved as provider_secret)</span></label>
                                    <input type="password" x-model="providerSecret" placeholder="Enter your Client Secret from Tastytrade"
                                           class="ml-4 w-[calc(100%-1rem)] bg-tv-bg border border-tv-border text-tv-text px-3 py-2 rounded text-sm focus:outline-none focus:border-tv-blue">
                                </div>
                                <div>
                                    <label class="block text-tv-muted text-sm mb-1">Refresh Token</label>
                                    <input type="password" x-model="refreshToken" placeholder="Enter your Refresh Token from Tastytrade"
                                           class="ml-4 w-[calc(100%-1rem)] bg-tv-bg border border-tv-border text-tv-text px-3 py-2 rounded text-sm focus:outline-none focus:border-tv-blue">
                                </div>
                                <div class="flex items-center gap-3 ml-4">
                                    <button @click="saveCredentials()" :disabled="savingCredentials"
                                            class="bg-tv-blue hover:bg-tv-blue/80 text-white px-4 py-2 rounded text-sm disabled:opacity-50">
                                        <i class="fas fa-save mr-1" x-show="!savingCredentials"></i>
                                        <i class="fas fa-spinner fa-spin mr-1" x-show="savingCredentials"></i>
                                        <span x-text="savingCredentials ? 'Connecting...' : 'Save & Connect'"></span>
                                    </button>
                                    <button x-show="connectionStatus?.configured" x-cloak
                                            @click="deleteCredentials()" :disabled="deletingCredentials"
                                            class="bg-tv-red/20 hover:bg-tv-red/30 text-tv-red border border-tv-red/30 px-4 py-2 rounded text-sm disabled:opacity-50">
                                        <i class="fas fa-trash-alt mr-1" x-show="!deletingCredentials"></i>
                                        <i class="fas fa-spinner fa-spin mr-1" x-show="deletingCredentials"></i>
                                        <span x-text="deletingCredentials ? 'Removing...' : 'Remove Credentials'"></span>
                                    </button>
                                </div>
                            </div>

                            <!-- Setup instructions -->
                            <div class="bg-tv-bg border border-tv-border rounded p-3 text-xs text-tv-muted space-y-2 ml-4">
                                <p class="font-medium text-tv-text"><i class="fas fa-info-circle mr-1 text-tv-blue"></i>How to get OAuth credentials</p>
                                <ol class="list-decimal list-inside space-y-1 ml-1">
                                    <li>Log in to <strong class="text-tv-text">my.tastytrade.com</strong></li>
                                    <li>Go to <strong class="text-tv-text">Manage &rarr; My Profile &rarr; API</strong></li>
                                    <li>Under <strong class="text-tv-text">OAuth Applications</strong>, create a new app (or view existing)</li>
                                    <li>Copy the <strong class="text-tv-text">Client Secret</strong> (this is the first field above)</li>
                                    <li>Create a <strong class="text-tv-text">Grant</strong> for the app to generate a <strong class="text-tv-text">Refresh Token</strong></li>
                                    <li>Copy the <strong class="text-tv-text">Refresh Token</strong> (this is the second field above)</li>
                                </ol>
                                <p class="text-tv-muted/70 italic">Note: The Client ID shown by Tastytrade is not needed. Only Client Secret and Refresh Token are required.</p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Strategy Targets Tab -->
            <div x-show="activeTab === 'targets'" x-cloak>
                <div class="mb-6 flex items-start justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-tv-text mb-1">
                            <i class="fas fa-bullseye mr-2 text-tv-blue"></i>Strategy Targets
                        </h2>
                        <p class="text-tv-muted text-sm">Configure profit and loss targets for each strategy type</p>
                    </div>
                    <button @click="resetToDefaults()"
                            class="bg-tv-bg hover:bg-tv-border text-tv-muted hover:text-tv-text border border-tv-border px-4 py-2 text-sm rounded">
                        <i class="fas fa-rotate-left mr-1"></i>Reset to Defaults
                    </button>
                </div>

                <!-- Credit Strategies -->
                <div class="bg-tv-panel border border-tv-border rounded mb-5" @input="debouncedSaveTargets()">
                    <div class="px-4 py-3 border-b border-tv-border">
                        <h3 class="text-sm font-semibold text-tv-text">
                            <i class="fas fa-arrow-down mr-2 text-tv-green"></i>Credit Strategies
                        </h3>
                        <p class="text-tv-muted text-xs mt-0.5">Strategies where you collect premium upfront</p>
                    </div>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-tv-border text-tv-muted text-left">
                                <th class="px-4 py-2 font-medium">Strategy</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Profit Target %</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Loss Limit %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="target in creditStrategies" :key="target.strategy_name">
                                <tr class="border-b border-tv-border/50 hover:bg-tv-bg/50">
                                    <td class="px-4 py-2 text-tv-text" x-text="target.strategy_name"></td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.profit_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-green text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.loss_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-red text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Debit Strategies -->
                <div class="bg-tv-panel border border-tv-border rounded mb-5" @input="debouncedSaveTargets()">
                    <div class="px-4 py-3 border-b border-tv-border">
                        <h3 class="text-sm font-semibold text-tv-text">
                            <i class="fas fa-arrow-up mr-2 text-tv-blue"></i>Debit Strategies
                        </h3>
                        <p class="text-tv-muted text-xs mt-0.5">Strategies where you pay premium upfront</p>
                    </div>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-tv-border text-tv-muted text-left">
                                <th class="px-4 py-2 font-medium">Strategy</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Profit Target %</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Loss Limit %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="target in debitStrategies" :key="target.strategy_name">
                                <tr class="border-b border-tv-border/50 hover:bg-tv-bg/50">
                                    <td class="px-4 py-2 text-tv-text" x-text="target.strategy_name"></td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.profit_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-green text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.loss_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-red text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Equity -->
                <div class="bg-tv-panel border border-tv-border rounded mb-5" @input="debouncedSaveTargets()">
                    <div class="px-4 py-3 border-b border-tv-border">
                        <h3 class="text-sm font-semibold text-tv-text">
                            <i class="fas fa-chart-bar mr-2 text-tv-muted"></i>Equity
                        </h3>
                        <p class="text-tv-muted text-xs mt-0.5">Stock/share positions</p>
                    </div>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-tv-border text-tv-muted text-left">
                                <th class="px-4 py-2 font-medium">Strategy</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Profit Target %</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Loss Limit %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="target in equityStrategies" :key="target.strategy_name">
                                <tr class="border-b border-tv-border/50 hover:bg-tv-bg/50">
                                    <td class="px-4 py-2 text-tv-text" x-text="target.strategy_name"></td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.profit_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-green text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.loss_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-red text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- How targets work -->
                <div class="bg-tv-panel border border-tv-border rounded p-4 text-sm text-tv-muted">
                    <p class="font-medium text-tv-text mb-2"><i class="fas fa-info-circle mr-1 text-tv-blue"></i>How targets work</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong class="text-tv-green">Profit Target %</strong> — Percentage of max profit at which to consider closing for a win</li>
                        <li><strong class="text-tv-red">Loss Limit %</strong> — Percentage of max loss at which to consider closing to limit damage</li>
                        <li>For credit strategies, a 50% profit target means close when you've captured 50% of the premium collected</li>
                        <li>For debit strategies, a 100% profit target means close when the position has doubled in value</li>
                    </ul>
                </div>
            </div>

            <!-- Roll Alerts Tab -->
            <div x-show="activeTab === 'alerts'" x-cloak>
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-tv-text mb-1">
                        <i class="fas fa-bell mr-2 text-yellow-400"></i>Roll Suggestion Alerts
                    </h2>
                    <p class="text-tv-muted text-sm">Configure which roll/close suggestions appear on the Positions page for debit spreads</p>
                </div>
                <div class="bg-tv-panel border border-tv-border rounded" @change="saveRollAlerts()">
                    <div class="p-5 space-y-3">
                        <!-- Master toggle -->
                        <label class="flex items-center justify-between py-2 border-b border-tv-border/50 cursor-pointer">
                            <div>
                                <span class="text-tv-text font-medium">Enable Roll Suggestions</span>
                                <span class="text-tv-muted text-xs block">Master toggle for all roll analysis badges and panels</span>
                            </div>
                            <div class="relative">
                                <input type="checkbox" x-model="rollAlerts.enabled" class="sr-only">
                                <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.enabled ? 'bg-tv-blue' : 'bg-tv-border'"></div>
                                <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.enabled ? 'translate-x-5' : ''"></div>
                            </div>
                        </label>

                        <!-- Individual toggles -->
                        <div class="space-y-2 pl-2" :class="!rollAlerts.enabled ? 'opacity-40 pointer-events-none' : ''">
                            <label class="flex items-center justify-between py-1.5 cursor-pointer">
                                <div>
                                    <span class="text-tv-text text-sm">Profit Target</span>
                                    <span class="text-tv-muted text-xs block">Alert when position reaches your configured profit target</span>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" x-model="rollAlerts.profitTarget" class="sr-only">
                                    <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.profitTarget ? 'bg-tv-green' : 'bg-tv-border'"></div>
                                    <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.profitTarget ? 'translate-x-5' : ''"></div>
                                </div>
                            </label>
                            <label class="flex items-center justify-between py-1.5 cursor-pointer">
                                <div>
                                    <span class="text-tv-text text-sm">Loss Limit</span>
                                    <span class="text-tv-muted text-xs block">Alert when position reaches your configured loss threshold</span>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" x-model="rollAlerts.lossLimit" class="sr-only">
                                    <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.lossLimit ? 'bg-tv-red' : 'bg-tv-border'"></div>
                                    <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.lossLimit ? 'translate-x-5' : ''"></div>
                                </div>
                            </label>
                            <label class="flex items-center justify-between py-1.5 cursor-pointer">
                                <div>
                                    <span class="text-tv-text text-sm">Late-Stage</span>
                                    <span class="text-tv-muted text-xs block">Alert when multiple maturing indicators converge (low DTE, high delta, etc.)</span>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" x-model="rollAlerts.lateStage" class="sr-only">
                                    <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.lateStage ? 'bg-yellow-500' : 'bg-tv-border'"></div>
                                    <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.lateStage ? 'translate-x-5' : ''"></div>
                                </div>
                            </label>
                            <label class="flex items-center justify-between py-1.5 cursor-pointer">
                                <div>
                                    <span class="text-tv-text text-sm">Delta Saturation</span>
                                    <span class="text-tv-muted text-xs block">Alert when spread delta exceeds 65% (diminishing convexity)</span>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" x-model="rollAlerts.deltaSaturation" class="sr-only">
                                    <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.deltaSaturation ? 'bg-orange-500' : 'bg-tv-border'"></div>
                                    <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.deltaSaturation ? 'translate-x-5' : ''"></div>
                                </div>
                            </label>
                            <label class="flex items-center justify-between py-1.5 cursor-pointer">
                                <div>
                                    <span class="text-tv-text text-sm">Low Reward-to-Risk</span>
                                    <span class="text-tv-muted text-xs block">Alert when remaining reward-to-risk ratio falls below 0.6</span>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" x-model="rollAlerts.lowRewardToRisk" class="sr-only">
                                    <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.lowRewardToRisk ? 'bg-orange-500' : 'bg-tv-border'"></div>
                                    <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.lowRewardToRisk ? 'translate-x-5' : ''"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</body>
</html>
