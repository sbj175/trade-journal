<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptionLedger - Settings</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232962ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='22 12 18 12 15 21 9 3 6 12 2 12'></polyline></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tv: {
                            bg: '#131722',
                            panel: '#1e222d',
                            border: '#2a2e39',
                            text: '#d1d4dc',
                            muted: '#787b86',
                            green: '#26a69a',
                            red: '#ef5350',
                            blue: '#2962ff',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif; }
        body { background: #131722; color: #d1d4dc; font-size: 16px; }
        .tv-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .tv-scrollbar::-webkit-scrollbar-track { background: #1e222d; }
        .tv-scrollbar::-webkit-scrollbar-thumb { background: #2a2e39; border-radius: 3px; }
        .tv-scrollbar::-webkit-scrollbar-thumb:hover { background: #363a45; }
        [x-cloak] { display: none !important; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { opacity: 1; }
    </style>

    <script>
        function settingsApp() {
            return {
                targets: [],
                saving: false,
                notification: null,
                _saveTimer: null,
                saveStatus: null,

                // Connection state
                connectionStatus: null,
                providerSecret: '',
                refreshToken: '',
                savingCredentials: false,

                get creditStrategies() {
                    const names = ['Bull Put Spread', 'Bear Call Spread', 'Iron Condor', 'Iron Butterfly',
                                   'Cash Secured Put', 'Covered Call', 'Short Put', 'Short Call',
                                   'Short Strangle', 'Short Straddle'];
                    return this.targets.filter(t => names.includes(t.strategy_name));
                },

                get debitStrategies() {
                    const names = ['Bull Call Spread', 'Bear Put Spread', 'Long Call', 'Long Put',
                                   'Long Strangle', 'Long Straddle'];
                    return this.targets.filter(t => names.includes(t.strategy_name));
                },

                get equityStrategies() {
                    const names = ['Shares'];
                    return this.targets.filter(t => names.includes(t.strategy_name));
                },

                rollAlerts: { enabled: true, profitTarget: true, lossLimit: true, lateStage: true, deltaSaturation: true, lowRewardToRisk: true },
                privacyMode: 'off',
                activeTab: 'import',
                initialSyncing: false,
                reprocessing: false,

                async init() {
                    await this.checkConnection();
                    await this.loadTargets();
                    this.loadRollAlerts();
                    this.privacyMode = localStorage.getItem('privacyMode') || 'off';
                },

                async checkConnection() {
                    try {
                        const resp = await fetch('/api/connection/status');
                        if (resp.ok) {
                            this.connectionStatus = await resp.json();
                        }
                    } catch (e) {
                        this.connectionStatus = { connected: false, configured: false, error: 'Could not check connection status' };
                    }
                },

                async saveCredentials() {
                    if (!this.providerSecret || !this.refreshToken) {
                        this.showNotification('Please fill in both fields', 'error');
                        return;
                    }
                    this.savingCredentials = true;
                    try {
                        // Save credentials to .env
                        const saveResp = await fetch('/api/settings/credentials', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                provider_secret: this.providerSecret,
                                refresh_token: this.refreshToken
                            })
                        });
                        if (!saveResp.ok) {
                            this.showNotification('Failed to save credentials', 'error');
                            this.savingCredentials = false;
                            return;
                        }

                        // Reconnect with new credentials
                        const reconnResp = await fetch('/api/connection/reconnect', { method: 'POST' });
                        if (reconnResp.ok) {
                            this.connectionStatus = await reconnResp.json();
                            if (this.connectionStatus.connected) {
                                this.showNotification('Connected to Tastytrade successfully!', 'success');
                                this.providerSecret = '';
                                this.refreshToken = '';
                            } else {
                                this.showNotification('Credentials saved but connection failed: ' + (this.connectionStatus.error || 'Unknown error'), 'error');
                            }
                        } else {
                            this.showNotification('Failed to reconnect', 'error');
                        }
                    } catch (e) {
                        this.showNotification('Error saving credentials: ' + e.message, 'error');
                    }
                    this.savingCredentials = false;
                },

                async loadTargets() {
                    try {
                        const resp = await fetch('/api/settings/targets');
                        if (resp.ok) {
                            this.targets = await resp.json();
                        }
                    } catch (e) {
                        this.showNotification('Failed to load targets', 'error');
                    }
                },

                debouncedSaveTargets() {
                    if (this._saveTimer) clearTimeout(this._saveTimer);
                    this.saveStatus = 'pending';
                    this._saveTimer = setTimeout(() => this.saveTargets(), 800);
                },

                async saveTargets() {
                    this.saveStatus = 'saving';
                    try {
                        const payload = this.targets.map(t => ({
                            strategy_name: t.strategy_name,
                            profit_target_pct: parseFloat(t.profit_target_pct),
                            loss_target_pct: parseFloat(t.loss_target_pct)
                        }));
                        const resp = await fetch('/api/settings/targets', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (resp.ok) {
                            this.saveStatus = 'saved';
                            setTimeout(() => { if (this.saveStatus === 'saved') this.saveStatus = null; }, 2000);
                        } else {
                            this.showNotification('Failed to save targets', 'error');
                            this.saveStatus = null;
                        }
                    } catch (e) {
                        this.showNotification('Failed to save targets', 'error');
                        this.saveStatus = null;
                    }
                },

                async resetToDefaults() {
                    try {
                        const resp = await fetch('/api/settings/targets/reset', { method: 'POST' });
                        if (resp.ok) {
                            await this.loadTargets();
                            this.showNotification('Targets reset to defaults', 'success');
                        } else {
                            this.showNotification('Failed to reset targets', 'error');
                        }
                    } catch (e) {
                        this.showNotification('Failed to reset targets', 'error');
                    }
                },

                loadRollAlerts() {
                    try {
                        const saved = localStorage.getItem('rollAlertSettings');
                        if (saved) this.rollAlerts = JSON.parse(saved);
                    } catch (e) { /* use defaults */ }
                },

                saveRollAlerts() {
                    localStorage.setItem('rollAlertSettings', JSON.stringify(this.rollAlerts));
                    this.saveStatus = 'saved';
                    setTimeout(() => { if (this.saveStatus === 'saved') this.saveStatus = null; }, 2000);
                },

                savePrivacyMode() {
                    localStorage.setItem('privacyMode', this.privacyMode);
                    this.saveStatus = 'saved';
                    setTimeout(() => { if (this.saveStatus === 'saved') this.saveStatus = null; }, 2000);
                },

                async initialSync() {
                    const confirmed = confirm(
                        'Initial Sync will CLEAR the entire database and rebuild it from scratch.\n\n' +
                        'This will fetch all transactions from the last year and may take several minutes.\n\n' +
                        'Are you sure you want to continue?'
                    );
                    if (!confirmed) return;

                    this.initialSyncing = true;
                    try {
                        const response = await fetch('/api/sync/initial', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (!response.ok) throw new Error(`Initial sync failed: ${response.statusText}`);
                        const result = await response.json();
                        this.showNotification(
                            `Initial sync completed! ${result.transactions_processed || 0} transactions, ` +
                            `${result.orders_saved || 0} orders in ${result.chains_saved || 0} chains`, 'success'
                        );
                    } catch (error) {
                        this.showNotification('Initial sync failed: ' + error.message, 'error');
                    } finally {
                        this.initialSyncing = false;
                    }
                },

                async reprocessChains() {
                    this.reprocessing = true;
                    try {
                        const response = await fetch('/api/reprocess-chains', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (!response.ok) throw new Error(`Reprocessing failed: ${response.statusText}`);
                        await response.json();
                        this.showNotification('Chain reprocessing completed successfully!', 'success');
                    } catch (error) {
                        this.showNotification('Reprocessing failed: ' + error.message, 'error');
                    } finally {
                        this.reprocessing = false;
                    }
                },

                showNotification(message, type) {
                    this.notification = { message, type };
                    setTimeout(() => { this.notification = null; }, 3000);
                }
            };
        }
    </script>
</head>
<body class="min-h-screen tv-scrollbar" x-data="settingsApp()" x-init="init()">

    {% include 'partials/nav.html' %}

    <!-- Notification -->
    <div x-show="notification" x-cloak
         x-transition:enter="transition ease-out duration-200"
         x-transition:leave="transition ease-in duration-150"
         class="fixed top-20 right-4 z-50 px-4 py-3 rounded shadow-lg text-sm"
         :class="notification?.type === 'success' ? 'bg-tv-green/20 border border-tv-green/30 text-tv-green' : 'bg-tv-red/20 border border-tv-red/30 text-tv-red'">
        <span x-text="notification?.message"></span>
    </div>

    <!-- Main Content -->
    <div class="flex" style="height: calc(100vh - 64px);">

        <!-- Left Sidebar Tabs -->
        <div class="w-56 flex-shrink-0 bg-tv-panel border-r border-tv-border py-4">
            <div class="px-3 mb-4">
                <h1 class="text-lg font-semibold text-tv-text">
                    <i class="fas fa-cog mr-2 text-tv-blue"></i>Settings
                </h1>
            </div>
            <nav class="space-y-0.5 px-2">
                <button @click="activeTab = 'import'"
                        class="w-full flex items-center gap-3 px-3 py-2.5 rounded text-sm transition-colors text-left"
                        :class="activeTab === 'import' ? 'bg-tv-blue/15 text-tv-blue border border-tv-blue/30' : 'text-tv-muted hover:text-tv-text hover:bg-tv-bg border border-transparent'">
                    <i class="fas fa-file-import w-4 text-center"></i>
                    <span>Import Trades</span>
                </button>
                <button @click="activeTab = 'privacy'"
                        class="w-full flex items-center gap-3 px-3 py-2.5 rounded text-sm transition-colors text-left"
                        :class="activeTab === 'privacy' ? 'bg-tv-blue/15 text-tv-blue border border-tv-blue/30' : 'text-tv-muted hover:text-tv-text hover:bg-tv-bg border border-transparent'">
                    <i class="fas fa-eye-slash w-4 text-center"></i>
                    <span>Privacy</span>
                </button>
                <button @click="activeTab = 'connection'"
                        class="w-full flex items-center gap-3 px-3 py-2.5 rounded text-sm transition-colors text-left"
                        :class="activeTab === 'connection' ? 'bg-tv-blue/15 text-tv-blue border border-tv-blue/30' : 'text-tv-muted hover:text-tv-text hover:bg-tv-bg border border-transparent'">
                    <i class="fas fa-plug w-4 text-center"></i>
                    <span>Connection</span>
                    <span class="ml-auto">
                        <i class="fas fa-circle text-[6px]" :class="connectionStatus?.connected ? 'text-tv-green' : 'text-tv-red'"></i>
                    </span>
                </button>
                <button @click="activeTab = 'targets'"
                        class="w-full flex items-center gap-3 px-3 py-2.5 rounded text-sm transition-colors text-left"
                        :class="activeTab === 'targets' ? 'bg-tv-blue/15 text-tv-blue border border-tv-blue/30' : 'text-tv-muted hover:text-tv-text hover:bg-tv-bg border border-transparent'">
                    <i class="fas fa-bullseye w-4 text-center"></i>
                    <span>Strategy Targets</span>
                </button>
                <button @click="activeTab = 'alerts'"
                        class="w-full flex items-center gap-3 px-3 py-2.5 rounded text-sm transition-colors text-left"
                        :class="activeTab === 'alerts' ? 'bg-tv-blue/15 text-tv-blue border border-tv-blue/30' : 'text-tv-muted hover:text-tv-text hover:bg-tv-bg border border-transparent'">
                    <i class="fas fa-bell w-4 text-center"></i>
                    <span>Roll Alerts</span>
                </button>
            </nav>
        </div>

        <!-- Right Content Area -->
        <div class="flex-1 overflow-y-auto tv-scrollbar p-6">
            <!-- Save status indicator -->
            <div class="flex items-center justify-end mb-4 h-5">
                <span class="text-xs text-tv-muted" x-show="saveStatus === 'pending'" x-cloak>
                    <i class="fas fa-circle text-yellow-500 text-[8px] mr-1"></i>Unsaved
                </span>
                <span class="text-xs text-tv-muted" x-show="saveStatus === 'saving'" x-cloak>
                    <i class="fas fa-spinner fa-spin mr-1"></i>Saving...
                </span>
                <span class="text-xs text-tv-green" x-show="saveStatus === 'saved'" x-cloak>
                    <i class="fas fa-check mr-1"></i>Saved
                </span>
            </div>

            <!-- Import Trades Tab -->
            <div x-show="activeTab === 'import'">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-tv-text mb-1">
                        <i class="fas fa-file-import mr-2 text-tv-blue"></i>Import Trades
                    </h2>
                    <p class="text-tv-muted text-sm">Rebuild or reprocess your trade data from Tastytrade</p>
                </div>

                <div class="space-y-4">
                    <!-- Initial Sync -->
                    <div class="bg-tv-panel border border-tv-border rounded">
                        <div class="p-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-tv-text font-medium mb-1">
                                    <i class="fas fa-database mr-2 text-tv-muted"></i>Initial Sync
                                </h3>
                                <p class="text-tv-muted text-sm">Clears the entire database and rebuilds it from scratch. Fetches all transactions from the last year. Use this if your data appears corrupted or after first install.</p>
                            </div>
                            <button @click="initialSync()" :disabled="initialSyncing || reprocessing"
                                    class="flex-shrink-0 ml-6 bg-tv-red/20 hover:bg-tv-red/30 text-tv-red border border-tv-red/30 px-5 py-2.5 rounded text-sm disabled:opacity-50 whitespace-nowrap">
                                <i class="fas fa-database mr-2" :class="{'animate-spin': initialSyncing}"></i>
                                <span x-text="initialSyncing ? 'Rebuilding...' : 'Initial Sync'"></span>
                            </button>
                        </div>
                    </div>

                    <!-- Reprocess Chains -->
                    <div class="bg-tv-panel border border-tv-border rounded">
                        <div class="p-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-tv-text font-medium mb-1">
                                    <i class="fas fa-link mr-2 text-tv-muted"></i>Reprocess Chains
                                </h3>
                                <p class="text-tv-muted text-sm">Re-analyzes existing transactions to rebuild order chains and strategy detection. Does not fetch new data from Tastytrade. Use this after a software update.</p>
                            </div>
                            <button @click="reprocessChains()" :disabled="initialSyncing || reprocessing"
                                    class="flex-shrink-0 ml-6 bg-tv-blue/20 hover:bg-tv-blue/30 text-tv-blue border border-tv-blue/30 px-5 py-2.5 rounded text-sm disabled:opacity-50 whitespace-nowrap">
                                <i class="fas fa-link mr-2" :class="{'animate-spin': reprocessing}"></i>
                                <span x-text="reprocessing ? 'Processing...' : 'Reprocess Chains'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Progress overlay -->
                <div x-show="initialSyncing || reprocessing" x-cloak
                     class="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                    <div class="bg-tv-panel border border-tv-border rounded-lg px-8 py-6 text-center shadow-2xl">
                        <i class="fas fa-spinner animate-spin text-tv-blue text-3xl mb-4"></i>
                        <p class="text-tv-text text-lg font-medium" x-text="initialSyncing ? 'Rebuilding database...' : 'Reprocessing chains...'"></p>
                        <p class="text-tv-muted text-sm mt-2">This may take a few seconds</p>
                    </div>
                </div>
            </div>

            <!-- Privacy Mode Tab -->
            <div x-show="activeTab === 'privacy'" x-cloak>
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-tv-text mb-1">
                        <i class="fas fa-eye-slash mr-2 text-tv-muted"></i>Privacy Mode
                    </h2>
                    <p class="text-tv-muted text-sm">Hide sensitive account balance information on the Positions page</p>
                </div>
                <div class="bg-tv-panel border border-tv-border rounded">
                    <div class="p-5">
                        <div class="flex items-center gap-4">
                            <template x-for="option in [{value: 'off', label: 'Off', icon: 'fa-eye', desc: 'All values visible'}, {value: 'medium', label: 'Medium', icon: 'fa-eye-low-vision', desc: 'Hides Net Liq'}, {value: 'high', label: 'High', icon: 'fa-eye-slash', desc: 'Hides all balances'}]" :key="option.value">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="privacyMode" :value="option.value" x-model="privacyMode" @change="savePrivacyMode()" class="sr-only">
                                    <div class="border rounded p-4 text-center transition-colors"
                                         :class="privacyMode === option.value ? 'border-tv-blue bg-tv-blue/10 text-tv-text' : 'border-tv-border bg-tv-bg text-tv-muted hover:border-tv-muted'">
                                        <i class="fas text-2xl mb-2" :class="option.icon"></i>
                                        <div class="text-sm font-medium" x-text="option.label"></div>
                                        <div class="text-xs mt-1 opacity-70" x-text="option.desc"></div>
                                    </div>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connection Tab -->
            <div x-show="activeTab === 'connection'" x-cloak>
                <div class="mb-6 flex items-start justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-tv-text mb-1">
                            <i class="fas fa-plug mr-2 text-tv-blue"></i>Tastytrade Connection
                        </h2>
                        <p class="text-tv-muted text-sm">Connect to Tastytrade using OAuth2 credentials</p>
                    </div>
                    <div class="flex items-center gap-2" x-show="connectionStatus">
                        <template x-if="connectionStatus?.connected">
                            <span class="bg-tv-green/20 text-tv-green border border-tv-green/30 px-3 py-1 rounded text-xs font-medium">
                                <i class="fas fa-check-circle mr-1"></i>Connected
                            </span>
                        </template>
                        <template x-if="!connectionStatus?.connected && connectionStatus?.configured">
                            <span class="bg-tv-red/20 text-tv-red border border-tv-red/30 px-3 py-1 rounded text-xs font-medium">
                                <i class="fas fa-exclamation-circle mr-1"></i>Connection Failed
                            </span>
                        </template>
                        <template x-if="!connectionStatus?.connected && !connectionStatus?.configured">
                            <span class="bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 px-3 py-1 rounded text-xs font-medium">
                                <i class="fas fa-info-circle mr-1"></i>Not Configured
                            </span>
                        </template>
                    </div>
                </div>
                <div class="bg-tv-panel border border-tv-border rounded">
                    <div class="p-5 space-y-4">
                        <!-- Connection error message -->
                        <div x-show="connectionStatus?.error" x-cloak class="bg-tv-red/10 border border-tv-red/20 rounded p-3 text-sm text-tv-red">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            <span x-text="connectionStatus?.error"></span>
                        </div>

                        <!-- Connected accounts -->
                        <div x-show="connectionStatus?.connected && connectionStatus?.accounts?.length > 0" x-cloak class="text-sm flex flex-col items-start gap-1.5">
                            <span class="text-tv-muted">Accounts:</span>
                            <template x-for="acct in connectionStatus?.accounts || []" :key="acct.account_number">
                                <div class="inline-flex items-center gap-2 bg-tv-bg border border-tv-border rounded px-3 py-1.5 ml-4">
                                    <span class="text-tv-text font-medium" x-text="acct.account_number"></span>
                                    <span class="text-tv-muted">&mdash;</span>
                                    <span class="text-tv-muted" x-text="acct.account_name"></span>
                                </div>
                            </template>
                        </div>

                        <!-- Credential inputs -->
                        <div class="space-y-3">
                            <div>
                                <label class="block text-tv-muted text-sm mb-1">Client Secret <span class="text-tv-muted/50">(saved as provider_secret)</span></label>
                                <input type="password" x-model="providerSecret" placeholder="Enter your Client Secret from Tastytrade"
                                       class="ml-4 w-[calc(100%-1rem)] bg-tv-bg border border-tv-border text-tv-text px-3 py-2 rounded text-sm focus:outline-none focus:border-tv-blue">
                            </div>
                            <div>
                                <label class="block text-tv-muted text-sm mb-1">Refresh Token</label>
                                <input type="password" x-model="refreshToken" placeholder="Enter your Refresh Token from Tastytrade"
                                       class="ml-4 w-[calc(100%-1rem)] bg-tv-bg border border-tv-border text-tv-text px-3 py-2 rounded text-sm focus:outline-none focus:border-tv-blue">
                            </div>
                            <div class="flex items-center gap-3 ml-4">
                                <button @click="saveCredentials()" :disabled="savingCredentials"
                                        class="bg-tv-blue hover:bg-tv-blue/80 text-white px-4 py-2 rounded text-sm disabled:opacity-50">
                                    <i class="fas fa-save mr-1" x-show="!savingCredentials"></i>
                                    <i class="fas fa-spinner fa-spin mr-1" x-show="savingCredentials"></i>
                                    <span x-text="savingCredentials ? 'Connecting...' : 'Save & Connect'"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Setup instructions -->
                        <div class="bg-tv-bg border border-tv-border rounded p-3 text-xs text-tv-muted space-y-2 ml-4">
                            <p class="font-medium text-tv-text"><i class="fas fa-info-circle mr-1 text-tv-blue"></i>How to get OAuth credentials</p>
                            <ol class="list-decimal list-inside space-y-1 ml-1">
                                <li>Log in to <strong class="text-tv-text">my.tastytrade.com</strong></li>
                                <li>Go to <strong class="text-tv-text">Manage &rarr; My Profile &rarr; API</strong></li>
                                <li>Under <strong class="text-tv-text">OAuth Applications</strong>, create a new app (or view existing)</li>
                                <li>Copy the <strong class="text-tv-text">Client Secret</strong> (this is the first field above)</li>
                                <li>Create a <strong class="text-tv-text">Grant</strong> for the app to generate a <strong class="text-tv-text">Refresh Token</strong></li>
                                <li>Copy the <strong class="text-tv-text">Refresh Token</strong> (this is the second field above)</li>
                            </ol>
                            <p class="text-tv-muted/70 italic">Note: The Client ID shown by Tastytrade is not needed. Only Client Secret and Refresh Token are required.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strategy Targets Tab -->
            <div x-show="activeTab === 'targets'" x-cloak>
                <div class="mb-6 flex items-start justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-tv-text mb-1">
                            <i class="fas fa-bullseye mr-2 text-tv-blue"></i>Strategy Targets
                        </h2>
                        <p class="text-tv-muted text-sm">Configure profit and loss targets for each strategy type</p>
                    </div>
                    <button @click="resetToDefaults()"
                            class="bg-tv-bg hover:bg-tv-border text-tv-muted hover:text-tv-text border border-tv-border px-4 py-2 text-sm rounded">
                        <i class="fas fa-rotate-left mr-1"></i>Reset to Defaults
                    </button>
                </div>

                <!-- Credit Strategies -->
                <div class="bg-tv-panel border border-tv-border rounded mb-5" @input="debouncedSaveTargets()">
                    <div class="px-4 py-3 border-b border-tv-border">
                        <h3 class="text-sm font-semibold text-tv-text">
                            <i class="fas fa-arrow-down mr-2 text-tv-green"></i>Credit Strategies
                        </h3>
                        <p class="text-tv-muted text-xs mt-0.5">Strategies where you collect premium upfront</p>
                    </div>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-tv-border text-tv-muted text-left">
                                <th class="px-4 py-2 font-medium">Strategy</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Profit Target %</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Loss Limit %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="target in creditStrategies" :key="target.strategy_name">
                                <tr class="border-b border-tv-border/50 hover:bg-tv-bg/50">
                                    <td class="px-4 py-2 text-tv-text" x-text="target.strategy_name"></td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.profit_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-green text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.loss_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-red text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Debit Strategies -->
                <div class="bg-tv-panel border border-tv-border rounded mb-5" @input="debouncedSaveTargets()">
                    <div class="px-4 py-3 border-b border-tv-border">
                        <h3 class="text-sm font-semibold text-tv-text">
                            <i class="fas fa-arrow-up mr-2 text-tv-blue"></i>Debit Strategies
                        </h3>
                        <p class="text-tv-muted text-xs mt-0.5">Strategies where you pay premium upfront</p>
                    </div>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-tv-border text-tv-muted text-left">
                                <th class="px-4 py-2 font-medium">Strategy</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Profit Target %</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Loss Limit %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="target in debitStrategies" :key="target.strategy_name">
                                <tr class="border-b border-tv-border/50 hover:bg-tv-bg/50">
                                    <td class="px-4 py-2 text-tv-text" x-text="target.strategy_name"></td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.profit_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-green text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.loss_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-red text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Equity -->
                <div class="bg-tv-panel border border-tv-border rounded mb-5" @input="debouncedSaveTargets()">
                    <div class="px-4 py-3 border-b border-tv-border">
                        <h3 class="text-sm font-semibold text-tv-text">
                            <i class="fas fa-chart-bar mr-2 text-tv-muted"></i>Equity
                        </h3>
                        <p class="text-tv-muted text-xs mt-0.5">Stock/share positions</p>
                    </div>
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-tv-border text-tv-muted text-left">
                                <th class="px-4 py-2 font-medium">Strategy</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Profit Target %</th>
                                <th class="px-4 py-2 font-medium text-center w-40">Loss Limit %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="target in equityStrategies" :key="target.strategy_name">
                                <tr class="border-b border-tv-border/50 hover:bg-tv-bg/50">
                                    <td class="px-4 py-2 text-tv-text" x-text="target.strategy_name"></td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.profit_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-green text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                    <td class="px-4 py-2 text-center">
                                        <input type="number" x-model.number="target.loss_target_pct" min="0" max="500" step="5"
                                               class="w-20 bg-tv-bg border border-tv-border text-tv-red text-center px-2 py-1 rounded focus:outline-none focus:border-tv-blue">
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- How targets work -->
                <div class="bg-tv-panel border border-tv-border rounded p-4 text-sm text-tv-muted">
                    <p class="font-medium text-tv-text mb-2"><i class="fas fa-info-circle mr-1 text-tv-blue"></i>How targets work</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong class="text-tv-green">Profit Target %</strong> — Percentage of max profit at which to consider closing for a win</li>
                        <li><strong class="text-tv-red">Loss Limit %</strong> — Percentage of max loss at which to consider closing to limit damage</li>
                        <li>For credit strategies, a 50% profit target means close when you've captured 50% of the premium collected</li>
                        <li>For debit strategies, a 100% profit target means close when the position has doubled in value</li>
                    </ul>
                </div>
            </div>

            <!-- Roll Alerts Tab -->
            <div x-show="activeTab === 'alerts'" x-cloak>
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-tv-text mb-1">
                        <i class="fas fa-bell mr-2 text-yellow-400"></i>Roll Suggestion Alerts
                    </h2>
                    <p class="text-tv-muted text-sm">Configure which roll/close suggestions appear on the Positions page for debit spreads</p>
                </div>
                <div class="bg-tv-panel border border-tv-border rounded" @change="saveRollAlerts()">
                    <div class="p-5 space-y-3">
                        <!-- Master toggle -->
                        <label class="flex items-center justify-between py-2 border-b border-tv-border/50 cursor-pointer">
                            <div>
                                <span class="text-tv-text font-medium">Enable Roll Suggestions</span>
                                <span class="text-tv-muted text-xs block">Master toggle for all roll analysis badges and panels</span>
                            </div>
                            <div class="relative">
                                <input type="checkbox" x-model="rollAlerts.enabled" class="sr-only">
                                <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.enabled ? 'bg-tv-blue' : 'bg-tv-border'"></div>
                                <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.enabled ? 'translate-x-5' : ''"></div>
                            </div>
                        </label>

                        <!-- Individual toggles -->
                        <div class="space-y-2 pl-2" :class="!rollAlerts.enabled ? 'opacity-40 pointer-events-none' : ''">
                            <label class="flex items-center justify-between py-1.5 cursor-pointer">
                                <div>
                                    <span class="text-tv-text text-sm">Profit Target</span>
                                    <span class="text-tv-muted text-xs block">Alert when position reaches your configured profit target</span>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" x-model="rollAlerts.profitTarget" class="sr-only">
                                    <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.profitTarget ? 'bg-tv-green' : 'bg-tv-border'"></div>
                                    <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.profitTarget ? 'translate-x-5' : ''"></div>
                                </div>
                            </label>
                            <label class="flex items-center justify-between py-1.5 cursor-pointer">
                                <div>
                                    <span class="text-tv-text text-sm">Loss Limit</span>
                                    <span class="text-tv-muted text-xs block">Alert when position reaches your configured loss threshold</span>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" x-model="rollAlerts.lossLimit" class="sr-only">
                                    <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.lossLimit ? 'bg-tv-red' : 'bg-tv-border'"></div>
                                    <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.lossLimit ? 'translate-x-5' : ''"></div>
                                </div>
                            </label>
                            <label class="flex items-center justify-between py-1.5 cursor-pointer">
                                <div>
                                    <span class="text-tv-text text-sm">Late-Stage</span>
                                    <span class="text-tv-muted text-xs block">Alert when multiple maturing indicators converge (low DTE, high delta, etc.)</span>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" x-model="rollAlerts.lateStage" class="sr-only">
                                    <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.lateStage ? 'bg-yellow-500' : 'bg-tv-border'"></div>
                                    <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.lateStage ? 'translate-x-5' : ''"></div>
                                </div>
                            </label>
                            <label class="flex items-center justify-between py-1.5 cursor-pointer">
                                <div>
                                    <span class="text-tv-text text-sm">Delta Saturation</span>
                                    <span class="text-tv-muted text-xs block">Alert when spread delta exceeds 65% (diminishing convexity)</span>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" x-model="rollAlerts.deltaSaturation" class="sr-only">
                                    <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.deltaSaturation ? 'bg-orange-500' : 'bg-tv-border'"></div>
                                    <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.deltaSaturation ? 'translate-x-5' : ''"></div>
                                </div>
                            </label>
                            <label class="flex items-center justify-between py-1.5 cursor-pointer">
                                <div>
                                    <span class="text-tv-text text-sm">Low Reward-to-Risk</span>
                                    <span class="text-tv-muted text-xs block">Alert when remaining reward-to-risk ratio falls below 0.6</span>
                                </div>
                                <div class="relative">
                                    <input type="checkbox" x-model="rollAlerts.lowRewardToRisk" class="sr-only">
                                    <div class="w-10 h-5 rounded-full transition-colors" :class="rollAlerts.lowRewardToRisk ? 'bg-orange-500' : 'bg-tv-border'"></div>
                                    <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform" :class="rollAlerts.lowRewardToRisk ? 'translate-x-5' : ''"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</body>
</html>
