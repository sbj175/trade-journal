<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptionLedger - Positions</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232962ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='22 12 18 12 15 21 9 3 6 12 2 12'></polyline></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/tailwind-config.js"></script>

    <!-- Alpine.js for interactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif; }
        body { background: #131722; color: #d1d4dc; font-size: 16px; }
        .tv-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .tv-scrollbar::-webkit-scrollbar-track { background: #1e222d; }
        .tv-scrollbar::-webkit-scrollbar-thumb { background: #2a2e39; border-radius: 3px; }
        .tv-scrollbar::-webkit-scrollbar-thumb:hover { background: #363a45; }
        [x-cloak] { display: none !important; }
    </style>

    <!-- Supabase JS SDK (auth) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Shared utilities -->
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/positions-app.js"></script>
</head>
<body class="min-h-screen tv-scrollbar" x-data="positionsApp">

    {% include 'partials/nav.html' %}

    <!-- Action Bar -->
    <div class="bg-tv-panel border-b border-tv-border px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <button @click="fetchPositions(true)"
                    :disabled="isLoading"
                    class="bg-tv-green/20 hover:bg-tv-green/30 text-tv-green border border-tv-green/30 px-4 py-2 text-base disabled:opacity-50">
                <i class="fas fa-sync-alt mr-2" :class="{'animate-spin': isLoading}"></i>
                <span x-text="isLoading ? 'Syncing...' : 'Sync'"></span>
            </button>

            <!-- Symbol Filter -->
            <div class="relative">
                <input type="text"
                       x-model="selectedUnderlying"
                       @focus="$event.target.select()"
                       @keyup.enter="filterPositions(); requestLiveQuotes(); saveFilterPreferences()"
                       @blur="filterPositions(); requestLiveQuotes(); saveFilterPreferences()"
                       @input="selectedUnderlying = selectedUnderlying.toUpperCase()"
                       placeholder="Symbol"
                       class="bg-tv-bg border border-tv-border text-tv-text text-base px-3 py-2 w-28 uppercase placeholder:normal-case placeholder:text-tv-muted"
                       :class="selectedUnderlying ? 'pr-8' : ''">
                <button x-show="selectedUnderlying"
                        @click="selectedUnderlying = ''; filterPositions(); requestLiveQuotes(); saveFilterPreferences()"
                        class="absolute right-2 top-1/2 -translate-y-1/2 text-tv-muted hover:text-tv-text"
                        title="Clear symbol filter">
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>

            <!-- Account Balances -->
            <template x-if="currentAccountBalance">
                <div class="flex items-center gap-6 ml-6 text-base">
                    <div>
                        <span class="text-tv-muted text-sm">Net Liq:</span>
                        <span class="font-medium ml-1" x-text="privacyMode !== 'off' ? '••••••' : '$' + formatNumber(currentAccountBalance.net_liquidating_value)"></span>
                    </div>
                    <div class="flex-grow"></div>
                    <div>
                        <span class="text-tv-muted text-sm">Cash:</span>
                        <span class="font-medium ml-1" x-text="privacyMode === 'high' ? '••••••' : '$' + formatNumber(currentAccountBalance.cash_balance)"></span>
                    </div>
                    <div>
                        <span class="text-tv-muted text-sm">Option BP:</span>
                        <span class="font-medium ml-1" x-text="privacyMode === 'high' ? '••••••' : '$' + formatNumber(currentAccountBalance.derivative_buying_power)"></span>
                    </div>
                    <div>
                        <span class="text-tv-muted text-sm">Stock BP:</span>
                        <span class="font-medium ml-1" x-text="privacyMode === 'high' ? '••••••' : '$' + formatNumber(currentAccountBalance.equity_buying_power)"></span>
                    </div>
                </div>
            </template>

            <span class="text-sm text-tv-muted ml-4" x-show="lastQuoteUpdate">
                Quotes: <span x-text="lastQuoteUpdate"></span>
                <span x-show="liveQuotesActive" class="text-tv-green ml-1">LIVE</span>
            </span>
        </div>
    </div>

    <!-- Loading State -->
    <div x-show="isLoading" class="text-center py-12">
        <i class="fas fa-spinner fa-spin text-4xl text-tv-blue mb-4"></i>
        <p class="text-tv-muted">Loading positions...</p>
    </div>

    <!-- Empty State -->
    <div x-show="!isLoading && !error && filteredItems.length === 0" class="text-center py-12">
        <i class="fas fa-layer-group text-4xl text-tv-muted mb-4"></i>
        <p class="text-tv-muted mb-4">No open positions found</p>
    </div>

    <!-- Reconciliation Banner -->
    <div x-show="reconciliation && !isLoading" x-cloak class="mx-2 mt-2">
        <div class="px-4 py-2 rounded text-sm flex items-center justify-between"
             :class="reconciliation && (reconciliation.unlinked?.length || reconciliation.quantity_mismatch?.length || reconciliation.stale?.length)
                     ? 'bg-yellow-500/10 border border-yellow-500/30 text-yellow-400'
                     : 'bg-tv-green/10 border border-tv-green/30 text-tv-green'">
            <span>
                <i class="fas fa-check-circle mr-1" x-show="reconciliation && !reconciliation.unlinked?.length && !reconciliation.quantity_mismatch?.length && !reconciliation.stale?.length"></i>
                <i class="fas fa-exclamation-triangle mr-1" x-show="reconciliation && (reconciliation.unlinked?.length || reconciliation.quantity_mismatch?.length || reconciliation.stale?.length)"></i>
                <span x-text="reconciliation ? reconciliation.matched + '/' + reconciliation.total + ' options matched' : ''"></span>
                <span x-show="reconciliation?.unlinked?.length" class="ml-2" x-text="reconciliation?.unlinked?.length + ' unlinked'"></span>
                <span x-show="reconciliation?.stale?.length" class="ml-2" x-text="reconciliation?.stale?.length + ' stale'"></span>
                <span x-show="reconciliation?.auto_closed?.length" class="ml-2 text-tv-green" x-text="reconciliation?.auto_closed?.length + ' auto-closed'"></span>
            </span>
            <button @click="reconciliation = null" class="text-tv-muted hover:text-tv-text text-xs ml-4">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main x-show="!isLoading && !error && filteredItems.length > 0 && allItems.length > 0" x-cloak class="p-2">
        <!-- Column Headers -->
        <div class="flex items-center px-4 py-2 text-sm text-tv-muted border-b border-tv-border bg-tv-panel/50 sticky top-16">
            <span class="w-8"></span>
            <span class="w-6 text-center" x-show="selectedAccount === ''"></span>
            <span class="w-14 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortPositions('underlying')">
                Symbol
                <span x-show="sortColumn === 'underlying'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-8 text-right cursor-pointer hover:text-tv-text flex items-center justify-end gap-1 mr-1" @click="sortPositions('ivr')">
                IVR
                <span x-show="sortColumn === 'ivr'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-40 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortPositions('price')">
                Price
                <span x-show="sortColumn === 'price'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-12"></span>
            <span class="w-36 cursor-pointer hover:text-tv-text flex items-center gap-1" @click="sortPositions('strategy')">
                Strategy
                <span x-show="sortColumn === 'strategy'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-12 text-center cursor-pointer hover:text-tv-text flex items-center justify-center gap-1" @click="sortPositions('dte')">
                DTE
                <span x-show="sortColumn === 'dte'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-12 text-center cursor-pointer hover:text-tv-text flex items-center justify-center gap-1" @click="sortPositions('days')">
                Days
                <span x-show="sortColumn === 'days'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-24 text-right cursor-pointer hover:text-tv-text flex items-center justify-end gap-1" @click="sortPositions('cost_basis')">
                Cost Basis
                <span x-show="sortColumn === 'cost_basis'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-24 text-right cursor-pointer hover:text-tv-text flex items-center justify-end gap-1" @click="sortPositions('net_liq')">
                Net Liq
                <span x-show="sortColumn === 'net_liq'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-24 text-right cursor-pointer hover:text-tv-text flex items-center justify-end gap-1" @click="sortPositions('realized_pnl')">
                Realized
                <span x-show="sortColumn === 'realized_pnl'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-24 text-right cursor-pointer hover:text-tv-text flex items-center justify-end gap-1" @click="sortPositions('open_pnl')">
                Open
                <span x-show="sortColumn === 'open_pnl'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-24 text-right cursor-pointer hover:text-tv-text flex items-center justify-end gap-1" @click="sortPositions('total_pnl')">
                Total
                <span x-show="sortColumn === 'total_pnl'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
            <span class="w-14 text-right cursor-pointer hover:text-tv-text flex items-center justify-end gap-1" @click="sortPositions('pnl_percent')">
                % Rtn
                <span x-show="sortColumn === 'pnl_percent'" x-text="sortDirection === 'asc' ? '▲' : '▼'" class="text-tv-blue"></span>
            </span>
        </div>

        <!-- Position Groups -->
        <div class="divide-y divide-tv-border">
            <template x-for="(group, index) in groupedPositions" :key="group.groupKey">
                <div>
                    <!-- Subtotal Row -->
                    <template x-if="group._isSubtotal">
                        <div class="flex items-center px-4 py-2 bg-blue-500/10 border-l-2 border-tv-blue">
                            <div class="w-8"></div>
                            <div class="w-6" x-show="selectedAccount === ''"></div>
                            <div class="w-14">
                                <div class="font-bold text-base text-tv-text" x-text="group.displayKey"></div>
                            </div>
                            <div class="w-8 mr-1"></div>
                            <div class="w-40"></div>
                            <div class="w-12"></div>
                            <!-- Strategy -->
                            <div class="w-36 text-xs text-tv-muted" x-text="group._childCount + ' positions'"></div>
                            <!-- DTE -->
                            <div class="w-12"></div>
                            <!-- Days -->
                            <div class="w-12"></div>
                            <!-- Cost Basis -->
                            <div class="w-24 text-right font-medium"
                                 :class="(group._subtotalCostBasis >= 0 ? 'text-tv-green' : 'text-tv-red') + ' ' + dollarSizeClass(group._subtotalCostBasis)">
                                <span x-show="group._subtotalCostBasis < 0">-</span>$<span x-text="formatDollar(group._subtotalCostBasis)"></span>
                            </div>
                            <!-- Net Liq -->
                            <div class="w-24 text-right font-medium"
                                 :class="(group._subtotalNetLiq >= 0 ? 'text-tv-green' : 'text-tv-red') + ' ' + dollarSizeClass(group._subtotalNetLiq)">
                                <span x-show="group._subtotalNetLiq < 0">-</span>$<span x-text="formatDollar(group._subtotalNetLiq)"></span>
                            </div>
                            <!-- Realized -->
                            <div class="w-24 text-right font-medium"
                                 :class="(group._subtotalRealizedPnL >= 0 ? 'text-tv-green' : 'text-tv-red') + ' ' + dollarSizeClass(group._subtotalRealizedPnL)">
                                <span x-show="group._subtotalRealizedPnL !== 0">
                                    <span x-show="group._subtotalRealizedPnL < 0">-</span>$<span x-text="formatDollar(group._subtotalRealizedPnL)"></span>
                                </span>
                            </div>
                            <!-- Open P/L -->
                            <div class="w-24 text-right font-medium"
                                 :class="(group._subtotalOpenPnL >= 0 ? 'text-tv-green' : 'text-tv-red') + ' ' + dollarSizeClass(group._subtotalOpenPnL)">
                                <span x-show="group._subtotalOpenPnL < 0">-</span>$<span x-text="formatDollar(group._subtotalOpenPnL)"></span>
                            </div>
                            <!-- Total P/L -->
                            <div class="w-24 text-right font-bold"
                                 :class="(group._subtotalTotalPnL >= 0 ? 'text-tv-green' : 'text-tv-red') + ' ' + dollarSizeClass(group._subtotalTotalPnL)">
                                <span x-show="group._subtotalTotalPnL < 0">-</span>$<span x-text="formatDollar(group._subtotalTotalPnL)"></span>
                            </div>
                            <!-- % Rtn -->
                            <div class="w-14"></div>
                        </div>
                    </template>

                    <!-- Regular Row (Chain or Share) -->
                    <template x-if="!group._isSubtotal">
                        <div x-data="{ expanded: false }">
                            <!-- Group Row -->
                            <div class="flex items-center px-4 py-2 hover:bg-tv-border/30 cursor-pointer transition-colors"
                                 @click="expanded = !expanded"
                                <!-- Chevron -->
                                <div class="w-8">
                                    <i class="fas fa-chevron-right text-tv-muted transition-transform duration-200"
                                       :class="{ 'rotate-90': expanded }"></i>
                                </div>

                                <!-- Account Symbol (only when All Accounts selected) -->
                                <div class="w-6 text-center text-tv-muted text-sm" x-show="selectedAccount === ''">
                                    <span x-text="getAccountSymbol(group.accountNumber)"></span>
                                </div>

                                <!-- Symbol -->
                                <div class="w-14">
                                    <div class="font-semibold text-base text-tv-text">
                                        <span x-text="group.displayKey || group.underlying"></span>
                                        <span x-show="_hasEquity(group) && (group.positions || []).length > 0" class="text-[10px] text-tv-muted ml-1 bg-tv-border/50 px-1 rounded">+stk</span>
                                    </div>
                                </div>

                                <!-- IVR -->
                                <div class="w-8 text-right mr-1"
                                     :class="getUnderlyingIVR(group.underlying) >= 50 ? 'font-bold text-yellow-400' : 'text-tv-muted'"
                                     x-text="getUnderlyingIVR(group.underlying) !== null ? getUnderlyingIVR(group.underlying) : ''"></div>

                                <!-- Price -->
                                <div class="w-40 flex items-center gap-2">
                                    <template x-if="getUnderlyingQuote(group.underlying)">
                                        <div class="flex items-center gap-2">
                                            <div class="w-20 px-2 py-1 rounded-sm text-base font-medium border text-right"
                                                 style="font-variant-numeric: tabular-nums"
                                                 :class="(getUnderlyingQuote(group.underlying).change || 0) >= 0 ? 'bg-green-900/60 text-green-400 border-green-700/50' : 'bg-tv-border text-tv-muted border-tv-border'">
                                                <span x-text="formatNumber(getUnderlyingQuote(group.underlying).price || 0)"></span>
                                            </div>
                                            <div class="w-16 text-right text-sm"
                                                 style="font-variant-numeric: tabular-nums"
                                                 :class="(getUnderlyingQuote(group.underlying).change || 0) >= 0 ? 'text-green-400' : 'text-tv-muted'">
                                                <span x-text="((getUnderlyingQuote(group.underlying).change || 0) >= 0 ? '+' : '') + (getUnderlyingQuote(group.underlying).changePercent || 0).toFixed(2) + '%'"></span>
                                            </div>
                                        </div>
                                    </template>
                                    <template x-if="!getUnderlyingQuote(group.underlying)">
                                        <span class="text-tv-muted text-sm"><i class="fas fa-spinner fa-spin"></i></span>
                                    </template>
                                </div>

                                <!-- Ledger Link -->
                                <div class="w-12">
                                    <a :href="'/ledger?underlying=' + encodeURIComponent(group.underlying)"
                                       @click.stop
                                       class="text-tv-blue hover:text-blue-400"
                                       title="View in Ledger">
                                        <i class="fas fa-book"></i>
                                        <span x-show="group.roll_count > 0" class="text-xs text-tv-muted ml-0.5" x-text="'R' + group.roll_count"></span>
                                    </a>
                                </div>

                                <!-- Strategy -->
                                <div class="w-36 relative">
                                    <div class="text-sm text-tv-muted" x-text="getGroupStrategyLabel(group)"></div>
                                    <template x-if="group.rollAnalysis && group.rollAnalysis.badges.length > 0">
                                        <div class="flex flex-wrap gap-1 mt-0.5">
                                            <template x-for="badge in group.rollAnalysis.badges" :key="badge.label">
                                                <span class="text-[10px] px-1.5 py-0 rounded-sm border leading-4"
                                                      :class="{
                                                          'bg-green-500/20 text-green-400 border-green-500/50': badge.color === 'green',
                                                          'bg-red-500/20 text-red-400 border-red-500/50': badge.color === 'red',
                                                          'bg-yellow-500/20 text-yellow-400 border-yellow-500/50': badge.color === 'yellow',
                                                          'bg-orange-500/20 text-orange-400 border-orange-500/50': badge.color === 'orange'
                                                      }"
                                                      x-text="badge.label"></span>
                                            </template>
                                        </div>
                                    </template>
                                    <!-- Tag chips -->
                                    <div class="flex flex-wrap gap-1 mt-0.5 items-center" @click.stop>
                                        <template x-for="tag in (group.tags || [])" :key="tag.id">
                                            <span class="text-[10px] px-1.5 py-0.5 rounded-full border inline-flex items-center gap-0.5 leading-3"
                                                  :style="`background: ${tag.color}20; color: ${tag.color}; border-color: ${tag.color}50`">
                                                <span x-text="tag.name"></span>
                                                <button @click="removeTagFromGroup(group, tag.id, $event)"
                                                        class="hover:opacity-70 ml-0.5 leading-none">&times;</button>
                                            </span>
                                        </template>
                                        <button @click="openTagPopover(group.group_id, $event)"
                                                class="text-[10px] w-4 h-4 rounded-full border border-tv-border/50 text-tv-muted hover:text-tv-blue hover:border-tv-blue/50 flex items-center justify-center leading-none"
                                                title="Add tag">+</button>
                                    </div>
                                    <!-- Tag popover -->
                                    <template x-if="tagPopoverGroup === group.group_id">
                                        <div class="absolute top-full left-0 mt-1 z-50 bg-[#1e222d] border border-tv-border rounded shadow-lg p-1.5 w-44"
                                             @click.stop
                                             @click.outside="closeTagPopover()">
                                            <input type="text"
                                                   :id="'tag-input-' + group.group_id"
                                                   x-model="tagSearch"
                                                   @keydown="handleTagInput($event, group)"
                                                   class="w-full bg-tv-bg border border-tv-border text-tv-text text-xs px-2 py-1 rounded outline-none focus:border-tv-blue/50"
                                                   placeholder="Type tag name...">
                                            <div class="max-h-28 overflow-y-auto mt-1">
                                                <template x-for="tag in filteredTagSuggestions" :key="tag.id">
                                                    <button @click="addTagToGroup(group, tag); closeTagPopover()"
                                                            class="flex items-center gap-1.5 w-full text-left px-2 py-1 text-xs text-tv-text hover:bg-tv-panel rounded">
                                                        <span class="w-2.5 h-2.5 rounded-full flex-shrink-0" :style="`background: ${tag.color}`"></span>
                                                        <span x-text="tag.name"></span>
                                                    </button>
                                                </template>
                                                <template x-if="tagSearch.trim() && !filteredTagSuggestions.find(t => t.name.toLowerCase() === tagSearch.trim().toLowerCase())">
                                                    <button @click="addTagToGroup(group, tagSearch.trim()); closeTagPopover()"
                                                            class="flex items-center gap-1.5 w-full text-left px-2 py-1 text-xs text-tv-blue hover:bg-tv-panel rounded">
                                                        <i class="fas fa-plus text-[8px]"></i>
                                                        <span>Create "<span x-text="tagSearch.trim()"></span>"</span>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>

                                <!-- DTE -->
                                <div class="w-12 text-center"
                                     :class="getMinDTE(group) !== null && getMinDTE(group) <= 21 ? 'font-bold text-yellow-400' : 'text-tv-text'"
                                     x-text="getMinDTE(group) !== null ? getMinDTE(group) : ''"></div>

                                <!-- Days -->
                                <div class="w-12 text-center text-tv-text" x-text="getGroupDaysOpen(group) || ''"></div>

                                <!-- Cost Basis -->
                                <div class="w-24 text-right"
                                     :class="(getGroupCostBasis(group) >= 0 ? 'text-tv-green' : 'text-tv-red') + ' ' + dollarSizeClass(getGroupCostBasis(group))">
                                    <span x-show="getGroupCostBasis(group) < 0">-</span>$<span x-text="formatDollar(getGroupCostBasis(group))"></span>
                                </div>

                                <!-- Net Liq -->
                                <div class="w-24 text-right font-medium"
                                     :class="(getGroupNetLiqWithLiveQuotes(group) >= 0 ? 'text-tv-green' : 'text-tv-red') + ' ' + dollarSizeClass(getGroupNetLiqWithLiveQuotes(group))">
                                    <span x-show="getGroupNetLiqWithLiveQuotes(group) < 0">-</span>$<span x-text="formatDollar(getGroupNetLiqWithLiveQuotes(group))"></span>
                                </div>

                                <!-- Realized P/L -->
                                <div class="w-24 text-right"
                                     :class="(getGroupRealizedPnL(group) >= 0 ? 'text-tv-green' : 'text-tv-red') + ' ' + dollarSizeClass(getGroupRealizedPnL(group))">
                                    <template x-if="getGroupRealizedPnL(group) !== 0">
                                        <span>
                                            <span x-show="getGroupRealizedPnL(group) < 0">-</span>$<span x-text="formatDollar(getGroupRealizedPnL(group))"></span>
                                        </span>
                                    </template>
                                    <template x-if="getGroupRealizedPnL(group) === 0">
                                        <span></span>
                                    </template>
                                </div>

                                <!-- Open P/L -->
                                <div class="w-24 text-right font-medium"
                                     :class="(getGroupOpenPnL(group) >= 0 ? 'text-tv-green' : 'text-tv-red') + ' ' + dollarSizeClass(getGroupOpenPnL(group))">
                                    <span x-show="getGroupOpenPnL(group) < 0">-</span>$<span x-text="formatDollar(getGroupOpenPnL(group))"></span>
                                </div>

                                <!-- Total P/L -->
                                <div class="w-24 text-right font-bold"
                                     :class="(getGroupTotalPnL(group) >= 0 ? 'text-tv-green' : 'text-tv-red') + ' ' + dollarSizeClass(getGroupTotalPnL(group))">
                                    <span x-show="getGroupTotalPnL(group) < 0">-</span>$<span x-text="formatDollar(getGroupTotalPnL(group))"></span>
                                </div>

                                <!-- % Rtn -->
                                <div class="w-14 text-right"
                                     :class="getGroupPnLPercent(group) !== null ? (parseFloat(getGroupPnLPercent(group)) >= 0 ? 'text-tv-green' : 'text-tv-red') : 'text-tv-muted'"
                                     x-text="getGroupPnLPercent(group) !== null ? getGroupPnLPercent(group) + '%' : ''"></div>

                                <!-- Comment indicator -->
                                <div class="flex-1 text-tv-muted text-sm truncate pl-2"
                                     x-show="getPositionComment(group)"
                                     x-text="getPositionComment(group)"></div>

                            </div>

                            <!-- Expanded Detail Panel -->
                            <div x-show="expanded" class="bg-tv-bg border-t border-tv-border">
                                <div class="mx-4 my-3 p-3 bg-tv-panel rounded border border-tv-border font-mono">
                                    <div class="flex gap-4">
                                        <div class="flex-shrink-0 space-y-1">
                                            <!-- Option legs section -->
                                            <template x-if="(group.positions || []).length > 0">
                                                <div>
                                                    <!-- Header row -->
                                                    <div class="flex items-center text-xs text-tv-muted pb-1 border-b border-tv-border/30">
                                                        <span class="w-10 text-right">Qty</span>
                                                        <span class="w-16 text-center mx-2">Exp</span>
                                                        <span class="w-10">DTE</span>
                                                        <span class="w-16 text-center mx-2">Strike</span>
                                                        <span class="w-6">Type</span>
                                                        <span class="w-24 text-right ml-4">Cost Basis</span>
                                                        <span class="w-20 text-right">Net Liq</span>
                                                        <span class="w-20 text-right">Open P/L</span>
                                                    </div>

                                                    <!-- Option legs -->
                                                    <template x-for="leg in [...(group.positions || [])].sort((a, b) => {
                                                        const expA = a.expiration || '';
                                                        const expB = b.expiration || '';
                                                        if (expA !== expB) return expA.localeCompare(expB);
                                                        return (a.strike || 0) - (b.strike || 0);
                                                    })" :key="leg.symbol">
                                                        <div class="flex items-center text-sm py-0.5">
                                                            <span class="w-10 text-right font-medium"
                                                                  :class="getSignedQuantity(leg) > 0 ? 'text-tv-green' : 'text-tv-red'"
                                                                  x-text="getSignedQuantity(leg)"></span>
                                                            <span class="w-16 text-center bg-tv-border/30 mx-2 py-0.5 rounded text-tv-text"
                                                                  x-text="getExpirationDate(leg)"></span>
                                                            <span class="w-10 text-tv-muted"
                                                                  :class="getDTE(leg) <= 7 ? 'text-tv-red' : getDTE(leg) <= 30 ? 'text-yellow-400' : ''"
                                                                  x-text="getDTE(leg) !== null ? getDTE(leg) + 'd' : ''"></span>
                                                            <span class="w-16 text-center bg-tv-border/30 mx-2 py-0.5 rounded text-tv-text"
                                                                  x-text="getStrikePrice(leg)"></span>
                                                            <span class="w-6 text-tv-muted"
                                                                  x-text="getOptionType(leg)"></span>
                                                            <span class="w-24 text-right ml-4"
                                                                  :class="(leg.cost_basis || 0) >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                                                  x-text="'$' + formatNumber(leg.cost_basis || 0)"></span>
                                                            <span class="w-20 text-right text-tv-muted"
                                                                  x-text="'$' + formatNumber(_calculateLegMarketValue(leg))"></span>
                                                            <span class="w-20 text-right font-medium"
                                                                  :class="_calculateLegPnL(leg) >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                                                  x-text="'$' + formatNumber(_calculateLegPnL(leg))"></span>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>

                                            <!-- Equity section -->
                                            <template x-if="(group.equityLegs || []).length > 0">
                                                <div :class="(group.positions || []).length > 0 ? 'mt-2 pt-2 border-t border-tv-border/30' : ''">
                                                    <div class="flex items-center text-xs text-tv-muted pb-1 border-b border-tv-border/30">
                                                        <span class="w-16">Shares</span>
                                                        <span class="w-20 text-right">Avg Price</span>
                                                        <span class="w-24 text-right ml-4">Cost Basis</span>
                                                        <span class="w-20 text-right">Mkt Value</span>
                                                        <span class="w-20 text-right">Open P/L</span>
                                                    </div>
                                                    <div class="flex items-center text-sm py-0.5">
                                                        <span class="w-16 font-medium text-tv-text" x-text="group.equitySummary?.quantity || 0"></span>
                                                        <span class="w-20 text-right text-tv-muted" x-text="'$' + formatNumber(group.equitySummary?.average_price || 0)"></span>
                                                        <span class="w-24 text-right ml-4 text-tv-muted"
                                                              x-text="'$' + formatNumber(group.equitySummary?.cost_basis || 0)"></span>
                                                        <span class="w-20 text-right text-tv-muted"
                                                              x-text="'$' + formatNumber(_calculateEquityMarketValue(group))"></span>
                                                        <span class="w-20 text-right font-medium"
                                                              :class="(_calculateEquityMarketValue(group) + (group.equityLegs || []).reduce((s, l) => s + (l.cost_basis || 0), 0)) >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                                              x-text="'$' + formatNumber(_calculateEquityMarketValue(group) + (group.equityLegs || []).reduce((s, l) => s + (l.cost_basis || 0), 0))"></span>
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- No legs message for assigned chains -->
                                            <template x-if="(group.positions || []).length === 0 && (group.equityLegs || []).length === 0">
                                                <div class="text-xs text-tv-muted py-1">
                                                    <span x-show="group.has_assignment">All positions assigned/exercised</span>
                                                    <span x-show="!group.has_assignment">No open legs</span>
                                                </div>
                                            </template>

                                            <!-- Chain summary -->
                                            <div class="flex items-center text-xs text-tv-muted mt-2 pt-1 border-t border-tv-border/30 gap-4">
                                                <span x-text="'Opened: ' + (group.opening_date || 'N/A')"></span>
                                                <span x-text="'Orders: ' + (group.order_count || 1)"></span>
                                                <span x-show="group.roll_count > 0" x-text="'Rolls: ' + group.roll_count" class="text-tv-blue"></span>
                                                <span x-show="group.realized_pnl !== 0"
                                                      :class="group.realized_pnl >= 0 ? 'text-tv-green' : 'text-tv-red'"
                                                      x-text="'Realized: $' + formatNumber(group.realized_pnl)"></span>
                                            </div>
                                        </div>

                                        <!-- Comments -->
                                        <div class="flex-1 min-w-0">
                                            <div class="text-xs text-tv-muted pb-1 border-b border-tv-border/30 mb-1">Notes</div>
                                            <textarea :value="getPositionComment(group)"
                                                      @input="updatePositionComment(group, $event.target.value)"
                                                      @click.stop
                                                      rows="3"
                                                      class="w-full bg-transparent text-tv-text text-sm font-sans border border-tv-border/30 rounded px-2 py-1 resize-none outline-none focus:border-tv-blue/50"
                                                      placeholder="Add notes..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Roll Analysis Panel -->
                                <template x-if="group.rollAnalysis">
                                    <div class="mx-4 mb-3 p-3 bg-tv-panel rounded border-l-2"
                                         :class="{
                                             'border-green-500 border border-l-2 border-green-500/30': group.rollAnalysis.borderColor === 'green',
                                             'border-red-500 border border-l-2 border-red-500/30': group.rollAnalysis.borderColor === 'red',
                                             'border-yellow-500 border border-l-2 border-yellow-500/30': group.rollAnalysis.borderColor === 'yellow',
                                             'border-tv-blue border border-l-2 border-tv-blue/30': group.rollAnalysis.borderColor === 'blue'
                                         }">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs font-semibold text-tv-text">Roll Analysis</span>
                                            <span class="text-[10px] px-1.5 py-0 rounded-sm border leading-4"
                                                  :class="{
                                                      'bg-green-500/20 text-green-400 border-green-500/50': group.rollAnalysis.convexity === 'High' || group.rollAnalysis.convexity === 'Low Risk',
                                                      'bg-yellow-500/20 text-yellow-400 border-yellow-500/50': group.rollAnalysis.convexity === 'Diminishing' || group.rollAnalysis.convexity === 'Elevated Risk',
                                                      'bg-red-500/20 text-red-400 border-red-500/50': group.rollAnalysis.convexity === 'Low' || group.rollAnalysis.convexity === 'High Risk'
                                                  }"
                                                  x-text="group.rollAnalysis.isCredit ? group.rollAnalysis.convexity : (group.rollAnalysis.convexity + ' Convexity')"></span>
                                        </div>
                                        <!-- Compact 3-column layout -->
                                        <div class="flex gap-6 text-xs mb-2">
                                            <!-- P&L Status -->
                                            <div class="space-y-1">
                                                <div class="text-[10px] text-tv-muted uppercase tracking-wider font-semibold mb-1.5">P&L Status</div>
                                                <div class="flex justify-between gap-3">
                                                    <span class="text-tv-muted" x-text="group.rollAnalysis.pnlLabel"></span>
                                                    <span class="font-medium" :class="group.rollAnalysis.pnlPositive ? 'text-tv-green' : 'text-tv-red'"
                                                          x-text="group.rollAnalysis.pnlValue"></span>
                                                </div>
                                                <div class="flex justify-between gap-3">
                                                    <span class="text-tv-muted">Reward:Risk</span>
                                                    <span class="font-medium" :class="group.rollAnalysis.rewardToRiskRaw < (group.rollAnalysis.isCredit ? 0.3 : 0.6) ? 'text-orange-400' : 'text-tv-text'"
                                                          x-text="group.rollAnalysis.rewardToRisk"></span>
                                                </div>
                                                <div class="flex justify-between gap-3">
                                                    <span class="text-tv-muted">Max P / L</span>
                                                    <span class="font-medium text-tv-text"
                                                          x-text="'$' + group.rollAnalysis.maxProfit + ' / $' + group.rollAnalysis.maxLoss"></span>
                                                </div>
                                            </div>
                                            <!-- Greeks -->
                                            <div class="space-y-1 border-l border-tv-border/20 pl-6">
                                                <div class="text-[10px] text-tv-muted uppercase tracking-wider font-semibold mb-1.5">Greeks</div>
                                                <div class="flex justify-between gap-3">
                                                    <span class="text-tv-muted">Net Delta</span>
                                                    <span class="font-medium"
                                                          :class="group.rollAnalysis.netDelta > 0.01 ? 'text-tv-green' : group.rollAnalysis.netDelta < -0.01 ? 'text-tv-red' : 'text-tv-text'"
                                                          x-text="group.rollAnalysis.netDelta.toFixed(2)"></span>
                                                </div>
                                                <div class="flex justify-between gap-3">
                                                    <span class="text-tv-muted">Theta/Day</span>
                                                    <span class="font-medium"
                                                          :class="group.rollAnalysis.netTheta > 0.01 ? 'text-tv-green' : group.rollAnalysis.netTheta < -0.01 ? 'text-tv-red' : 'text-tv-text'"
                                                          x-text="'$' + group.rollAnalysis.netTheta.toFixed(2)"></span>
                                                </div>
                                                <div class="flex justify-between gap-3">
                                                    <span class="text-tv-muted">Gamma</span>
                                                    <span class="font-medium text-tv-text"
                                                          x-text="group.rollAnalysis.netGamma.toFixed(2)"></span>
                                                </div>
                                                <div class="flex justify-between gap-3">
                                                    <span class="text-tv-muted">Vega</span>
                                                    <span class="font-medium text-tv-text"
                                                          x-text="group.rollAnalysis.netVega.toFixed(2)"></span>
                                                </div>
                                            </div>
                                            <!-- Context -->
                                            <div class="space-y-1 border-l border-tv-border/20 pl-6">
                                                <div class="text-[10px] text-tv-muted uppercase tracking-wider font-semibold mb-1.5">Context</div>
                                                <div class="flex justify-between gap-3">
                                                    <span class="text-tv-muted">Near Short</span>
                                                    <span class="font-medium" :class="parseFloat(group.rollAnalysis.proximityToShort) < 3 ? 'text-yellow-400' : 'text-tv-text'"
                                                          x-text="group.rollAnalysis.proximityToShort + '%'"></span>
                                                </div>
                                                <div class="flex justify-between gap-3">
                                                    <span class="text-tv-muted">Delta Sat.</span>
                                                    <span class="font-medium" :class="parseFloat(group.rollAnalysis.deltaSaturation) >= 65 ? (group.rollAnalysis.isCredit ? 'text-tv-red' : 'text-orange-400') : 'text-tv-text'"
                                                          x-text="group.rollAnalysis.deltaSaturation + '%'"></span>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Footer: Suggestion + AI Insight placeholder -->
                                        <div class="flex items-start justify-between gap-2">
                                            <template x-if="group.rollAnalysis.suggestion">
                                                <div class="flex-1 pl-3 py-2 border-l-2 text-xs text-tv-text bg-tv-bg/50 rounded-r"
                                                     :class="{
                                                         'border-red-500': group.rollAnalysis.urgency === 'high',
                                                         'border-yellow-500': group.rollAnalysis.urgency === 'medium',
                                                         'border-tv-blue': group.rollAnalysis.urgency === 'low'
                                                     }">
                                                    <span x-text="group.rollAnalysis.suggestion"></span>
                                                </div>
                                            </template>
                                            <button disabled
                                                    class="ml-auto text-xs px-2 py-1 rounded border border-tv-border/50 text-tv-muted cursor-not-allowed shrink-0"
                                                    title="Coming soon">
                                                <i class="fas fa-wand-magic-sparkles mr-1"></i>AI Insight
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </main>
</body>
</html>
